---
description: این سند به شما آموزش می‌دهد که چگونه با استفاده از ماکروها در ویم، کارهای
  تکراری را خودکار کنید و ویرایش فایل‌ها را آسان‌تر کنید.
title: Ch09. Macros
---

هنگام ویرایش فایل‌ها، ممکن است خود را در حال تکرار همان اقدامات بیابید. آیا خوب نیست که بتوانید آن اقدامات را یک بار انجام دهید و هر زمان که به آن نیاز داشتید، دوباره اجرا کنید؟ با ماکروهای Vim، می‌توانید اقدامات را ضبط کرده و درون رجیسترهای Vim ذخیره کنید تا هر زمان که به آن نیاز داشتید، اجرا شوند.

در این فصل، یاد خواهید گرفت که چگونه از ماکروها برای خودکار کردن کارهای خسته‌کننده استفاده کنید (علاوه بر اینکه تماشای ویرایش خودکار فایل شما جالب است).

## ماکروهای پایه

در اینجا نحو پایه یک ماکرو Vim آمده است:

```shell
qa                     شروع ضبط یک ماکرو در رجیستر a
q (در حین ضبط)        متوقف کردن ضبط ماکرو
```

شما می‌توانید هر حرف کوچک (a-z) را برای ذخیره ماکروها انتخاب کنید. در اینجا نحوه اجرای یک ماکرو آمده است:

```shell
@a    اجرای ماکرو از رجیستر a
@@    اجرای آخرین ماکروهای اجرا شده
```

فرض کنید این متن را دارید و می‌خواهید همه چیز را در هر خط بزرگ کنید:

```shell
hello
vim
macros
are
awesome
```

با قرار دادن نشانگر خود در ابتدای خط "hello"، اجرا کنید:

```shell
qa0gU$jq
```

تجزیه و تحلیل:
- `qa` ضبط یک ماکرو را در رجیستر a شروع می‌کند.
- `0` به ابتدای خط می‌رود.
- `gU$` متن را از موقعیت فعلی شما تا انتهای خط بزرگ می‌کند.
- `j` به یک خط پایین‌تر می‌رود.
- `q` ضبط را متوقف می‌کند.

برای پخش آن، `@a` را اجرا کنید. درست مانند بسیاری از دستورات دیگر Vim، می‌توانید یک آرگومان شمارش به ماکروها بدهید. به عنوان مثال، اجرای `3@a` ماکرو را سه بار اجرا می‌کند.

## محافظت ایمنی

اجرای ماکرو به طور خودکار زمانی که با خطا مواجه می‌شود، متوقف می‌شود. فرض کنید این متن را دارید:

```shell
a. chocolate donut
b. mochi donut
c. powdered sugar donut
d. plain donut
```

اگر می‌خواهید اولین کلمه در هر خط را بزرگ کنید، این ماکرو باید کار کند:

```shell
qa0W~jq
```

تجزیه و تحلیل دستور بالا:
- `qa` ضبط یک ماکرو را در رجیستر a شروع می‌کند.
- `0` به ابتدای خط می‌رود.
- `W` به کلمه بعدی می‌رود.
- `~` حالت حرف زیر نشانگر را تغییر می‌دهد.
- `j` به یک خط پایین‌تر می‌رود.
- `q` ضبط را متوقف می‌کند.

من ترجیح می‌دهم که تعداد اجرای ماکرو را بیشتر از حد نیاز بشمارم، بنابراین معمولاً آن را نود و نه بار (`99@a`) اجرا می‌کنم. با این دستور، Vim واقعاً این ماکرو را نود و نه بار اجرا نمی‌کند. وقتی Vim به آخرین خط می‌رسد و حرکت `j` را اجرا می‌کند، دیگر خطی برای پایین رفتن پیدا نمی‌کند، خطا می‌دهد و اجرای ماکرو متوقف می‌شود.

این که اجرای ماکرو با اولین خطا متوقف می‌شود، یک ویژگی خوب است، در غیر این صورت Vim به اجرای این ماکرو نود و نه بار ادامه می‌دهد، حتی اگر به انتهای خط رسیده باشد.

## ماکرو خط فرمان

اجرای `@a` در حالت عادی تنها راهی نیست که می‌توانید ماکروها را در Vim اجرا کنید. شما همچنین می‌توانید دستور خط فرمان `:normal @a` را اجرا کنید. `:normal` به کاربر اجازه می‌دهد هر دستور حالت عادی را که به عنوان آرگومان داده شده است، اجرا کند. در مورد بالا، این همانند اجرای `@a` از حالت عادی است.

دستور `:normal` محدوده را به عنوان آرگومان می‌پذیرد. می‌توانید از این برای اجرای ماکرو در محدوده‌های انتخابی استفاده کنید. اگر می‌خواهید ماکرو خود را بین خطوط ۲ و ۳ اجرا کنید، می‌توانید `:2,3 normal @a` را اجرا کنید.

## اجرای ماکرو در چندین فایل

فرض کنید چندین فایل `.txt` دارید که هر کدام شامل متنی هستند. وظیفه شما این است که تنها اولین کلمه را در خطوطی که شامل کلمه "donut" هستند، بزرگ کنید. فرض کنید `0W~j` در رجیستر a است (همان ماکرو قبلی). چگونه می‌توانید این کار را سریعاً انجام دهید؟

فایل اول:

```shell
## savory.txt
a. cheddar jalapeno donut
b. mac n cheese donut
c. fried dumpling
```

فایل دوم:

```shell
## sweet.txt
a. chocolate donut
b. chocolate pancake
c. powdered sugar donut
```

فایل سوم:

```shell
## plain.txt
a. wheat bread
b. plain donut
```

در اینجا نحوه انجام آن آمده است:
- `:args *.txt` برای پیدا کردن تمام فایل‌های `.txt` در دایرکتوری فعلی شما.
- `:argdo g/donut/normal @a` دستور جهانی `g/donut/normal @a` را در هر فایل داخل `:args` اجرا می‌کند.
- `:argdo update` دستور `update` را برای ذخیره هر فایل داخل `:args` زمانی که بافر تغییر کرده است، اجرا می‌کند.

اگر با دستور جهانی `:g/donut/normal @a` آشنا نیستید، این دستور، دستوری که شما می‌دهید (`normal @a`) را در خطوطی که با الگو مطابقت دارند (`/donut/`) اجرا می‌کند. من در فصل بعدی به دستور جهانی می‌پردازم.

## ماکرو بازگشتی

شما می‌توانید یک ماکرو را به صورت بازگشتی با فراخوانی همان رجیستر ماکرو در حین ضبط آن ماکرو اجرا کنید. فرض کنید دوباره این لیست را دارید و نیاز دارید که حالت اولین کلمه را تغییر دهید:

```shell
a. chocolate donut
b. mochi donut
c. powdered sugar donut
d. plain donut
```

این بار، بیایید به صورت بازگشتی این کار را انجام دهیم. اجرا کنید:

```shell
qaqqa0W~j@aq
```

تجزیه و تحلیل مراحل:
- `qaq` یک ماکرو خالی a را ضبط می‌کند. لازم است که با یک رجیستر خالی شروع کنید زیرا وقتی ماکرو را به صورت بازگشتی فراخوانی می‌کنید، هر آنچه در آن رجیستر است را اجرا می‌کند.
- `qa` ضبط را در رجیستر a شروع می‌کند.
- `0` به اولین کاراکتر در خط فعلی می‌رود.
- `W` به کلمه بعدی می‌رود.
- `~` حالت حرف زیر نشانگر را تغییر می‌دهد.
- `j` به یک خط پایین‌تر می‌رود.
- `@a` ماکرو a را اجرا می‌کند.
- `q` ضبط را متوقف می‌کند.

حالا می‌توانید فقط `@a` را اجرا کنید و تماشا کنید که Vim ماکرو را به صورت بازگشتی اجرا می‌کند.

ماکرو چگونه می‌دانست که کی متوقف شود؟ وقتی ماکرو در آخرین خط بود، سعی کرد `j` را اجرا کند، از آنجا که خطی برای پایین رفتن وجود نداشت، اجرای ماکرو متوقف شد.

## افزودن به یک ماکرو

اگر نیاز دارید اقداماتی را به یک ماکرو موجود اضافه کنید، به جای بازسازی ماکرو از ابتدا، می‌توانید اقداماتی را به یکی از ماکروهای موجود اضافه کنید. در فصل رجیستر، یاد گرفتید که می‌توانید یک رجیستر نام‌دار را با استفاده از نماد بزرگ آن اضافه کنید. همان قانون اعمال می‌شود. برای افزودن اقدامات به یک ماکرو در رجیستر a، از رجیستر A استفاده کنید.

یک ماکرو در رجیستر a ضبط کنید: `qa0W~q` (این توالی حالت حرف بعدی در یک خط را تغییر می‌دهد). اگر می‌خواهید یک توالی جدید اضافه کنید تا یک نقطه در انتهای خط نیز اضافه کنید، اجرا کنید:

```shell
qAA.<Esc>q
```

تجزیه و تحلیل:
- `qA` ضبط ماکرو را در رجیستر A شروع می‌کند.
- `A.<Esc>` در انتهای خط (اینجا `A` دستور حالت وارد کردن است، نه ماکرو A) یک نقطه وارد می‌کند و سپس از حالت وارد کردن خارج می‌شود.
- `q` ضبط ماکرو را متوقف می‌کند.

حالا وقتی `@a` را اجرا می‌کنید، نه تنها حالت حرف کلمه بعدی را تغییر می‌دهد، بلکه یک نقطه در انتهای خط نیز اضافه می‌کند.

## اصلاح یک ماکرو

اگر نیاز دارید که اقدامات جدیدی را در وسط یک ماکرو اضافه کنید، چه؟

فرض کنید که شما یک ماکرو دارید که اولین کلمه واقعی را تغییر می‌دهد و یک نقطه در انتهای خط اضافه می‌کند، `0W~A.<Esc>` در رجیستر a. فرض کنید که بین بزرگ کردن اولین کلمه و اضافه کردن یک نقطه در انتهای خط، نیاز دارید که کلمه "deep fried" را درست قبل از کلمه "donut" اضافه کنید *(زیرا تنها چیزی که بهتر از دونات‌های معمولی است، دونات‌های سرخ شده هستند)*.

من متن بخش قبلی را دوباره استفاده می‌کنم:
```shell
a. chocolate donut
b. mochi donut
c. powdered sugar donut
d. plain donut
```

ابتدا، بیایید ماکرو موجود را فراخوانی کنیم (فرض کنید که ماکرو را از بخش قبلی در رجیستر a نگه داشته‌اید) با `:put a`:

```shell
0W~A.^[
```

این `^[` چیست؟ آیا شما `0W~A.<Esc>` را انجام ندادید؟ `<Esc>` کجاست؟ `^[` نمایندگی کد *داخلی* Vim از `<Esc>` است. با برخی از کلیدهای خاص، Vim نمایندگی این کلیدها را به صورت کدهای داخلی چاپ می‌کند. برخی از کلیدهای رایج که نمایندگی کد داخلی دارند شامل `<Esc>`, `<Backspace>` و `<Enter>` هستند. کلیدهای خاص بیشتری وجود دارد، اما آنها در حیطه این فصل نیستند.

به ماکرو برگردیم، درست بعد از عملگر تغییر حالت (`~`)، بیایید دستوراتی را برای رفتن به انتهای خط (`$`)، بازگشت به یک کلمه (`b`)، رفتن به حالت وارد کردن (`i`)، تایپ "deep fried " (فراموش نکنید که بعد از "fried " فاصله بگذارید) و خروج از حالت وارد کردن (`<Esc>`) اضافه کنیم.

اینجا چیزی است که شما در نهایت با آن مواجه خواهید شد:

```shell
0W~$bideep fried <Esc>A.^[
```

یک مشکل کوچک وجود دارد. Vim `<Esc>` را درک نمی‌کند. شما نمی‌توانید به طور مستقیم `<Esc>` را تایپ کنید. شما باید نمایندگی کد داخلی برای کلید `<Esc>` را بنویسید. در حالی که در حالت وارد کردن هستید، `Ctrl-V` را فشار دهید و سپس `<Esc>` را فشار دهید. Vim `^[` را چاپ می‌کند. `Ctrl-V` یک عملگر حالت وارد کردن است که برای وارد کردن کاراکتر غیر عددی بعدی *به طور تحت‌اللفظی* استفاده می‌شود. کد ماکرو شما اکنون باید به این شکل باشد:

```shell
0W~$bideep fried ^[A.^[
```

برای افزودن دستور اصلاح شده به رجیستر a، می‌توانید به همان روشی که برای افزودن یک ورودی جدید به یک رجیستر نام‌دار عمل می‌کنید، عمل کنید. در ابتدای خط، `"ay$` را اجرا کنید تا متن یانک شده را در رجیستر a ذخیره کنید.

حالا وقتی `@a` را اجرا می‌کنید، ماکرو شما حالت کلمه اول را تغییر می‌دهد، "deep fried " را قبل از "donut" اضافه می‌کند و یک "." در انتهای خط اضافه می‌کند. خوشمزه!

یک روش جایگزین برای اصلاح یک ماکرو این است که از یک عبارت خط فرمان استفاده کنید. `:let @a="` را انجام دهید، سپس `Ctrl-R a` را انجام دهید، این به معنای چسباندن محتوای رجیستر a به طور تحت‌اللفظی است. در نهایت، فراموش نکنید که علامت‌های نقل قول دوتایی (`"`) را ببندید. شما ممکن است چیزی شبیه به `:let @a="0W~$bideep fried ^[A.^["` داشته باشید.

## افزونگی ماکرو

شما می‌توانید به راحتی ماکروها را از یک رجیستر به رجیستری دیگر کپی کنید. به عنوان مثال، برای کپی کردن یک ماکرو از رجیستر a به رجیستر z، می‌توانید `:let @z = @a` را انجام دهید. `@a` نمایانگر محتوای رجیستر a است. حالا اگر `@z` را اجرا کنید، دقیقاً همان اقدامات را به عنوان `@a` انجام می‌دهد.

من ایجاد یک افزونگی را در ماکروهای پرکاربرد خود مفید می‌دانم. در روند کار من، معمولاً ماکروها را در هفت حرف الفبایی اول (a-g) ضبط می‌کنم و اغلب آنها را بدون فکر زیاد جایگزین می‌کنم. اگر ماکروهای مفید را به سمت انتهای الفبا منتقل کنم، می‌توانم آنها را حفظ کنم بدون اینکه نگران باشم که به طور تصادفی آنها را جایگزین کنم.

## ماکروهای سریالی در مقابل موازی

Vim می‌تواند ماکروها را به صورت سریالی و موازی اجرا کند. فرض کنید این متن را دارید:

```shell
import { FUNC1 } from "library1";
import { FUNC2 } from "library2";
import { FUNC3 } from "library3";
import { FUNC4 } from "library4";
import { FUNC5 } from "library5";
```

اگر می‌خواهید یک ماکرو برای کوچک کردن تمام "FUNC" های بزرگ ضبط کنید، این ماکرو باید کار کند:

```shell
qa0f{gui{jq
```

تجزیه و تحلیل:
- `qa` ضبط را در رجیستر a شروع می‌کند.
- `0` به اولین خط می‌رود.
- `f{` اولین نمونه از "{" را پیدا می‌کند.
- `gui{` متن داخل شیء متنی پرانتز را کوچک می‌کند (`i{`).
- `j` به یک خط پایین‌تر می‌رود.
- `q` ضبط ماکرو را متوقف می‌کند.

حالا می‌توانید `99@a` را اجرا کنید تا آن را در خطوط باقی‌مانده اجرا کنید. اما اگر این عبارت واردات را در فایل خود داشته باشید چه؟

```shell
import { FUNC1 } from "library1";
import { FUNC2 } from "library2";
import { FUNC3 } from "library3";
import foo from "bar";
import { FUNC4 } from "library4";
import { FUNC5 } from "library5";
```

اجرای `99@a` فقط ماکرو را سه بار اجرا می‌کند. این ماکرو در دو خط آخر اجرا نمی‌شود زیرا اجرای آن در خط "foo" با شکست مواجه می‌شود. این انتظار می‌رود وقتی ماکرو را به صورت سریالی اجرا می‌کنید. شما همیشه می‌توانید به خط بعدی که "FUNC4" است بروید و آن ماکرو را دوباره پخش کنید. اما اگر می‌خواهید همه چیز را در یک بار انجام دهید چه؟

ماکرو را به صورت موازی اجرا کنید.

به یاد داشته باشید که ماکروها می‌توانند با استفاده از دستور خط فرمان `:normal` اجرا شوند (مثلاً `:3,5 normal @a` ماکرو a را در خطوط ۳-۵ اجرا می‌کند). اگر `:1,$ normal @a` را اجرا کنید، خواهید دید که ماکرو در تمام خطوط به جز خط "foo" اجرا می‌شود. کار می‌کند!

اگرچه درون‌مایه Vim واقعاً ماکروها را به صورت موازی اجرا نمی‌کند، اما به طور ظاهری، مانند این عمل می‌کند. Vim `@a` را *به طور مستقل* در هر خط از اولین خط تا آخرین خط (`1,$`) اجرا می‌کند. از آنجا که Vim این ماکروها را به طور مستقل اجرا می‌کند، هر خط نمی‌داند که یکی از اجرای ماکرو در خط "foo" شکست خورده است.
## یادگیری ماکروها به روش هوشمند

بسیاری از کارهایی که در ویرایش انجام می‌دهید تکراری هستند. برای بهتر شدن در ویرایش، به عادت شناسایی اقدامات تکراری عادت کنید. از ماکروها (یا دستور نقطه) استفاده کنید تا مجبور نباشید یک عمل را دو بار انجام دهید. تقریباً هر چیزی که می‌توانید در Vim انجام دهید، می‌تواند با ماکروها تکرار شود.

در ابتدا، نوشتن ماکروها برایم بسیار awkward بود، اما تسلیم نشوید. با تمرین کافی، به عادت خودکارسازی همه چیز عادت خواهید کرد.

شاید استفاده از یادآورهای ذهنی به شما در یادآوری ماکروهایتان کمک کند. اگر ماکروی دارید که یک تابع ایجاد می‌کند، از "f register (`qf`) استفاده کنید. اگر ماکروی برای عملیات عددی دارید، "n register باید کار کند (`qn`). آن را با *اولین ثبت نامی* که به ذهنتان می‌رسد هنگام فکر کردن به آن عملیات نام‌گذاری کنید. همچنین متوجه شدم که "q register یک ماکرو ثبت نامی پیش‌فرض خوب است زیرا `qq` نیاز به قدرت ذهنی کمتری برای فکر کردن دارد. در نهایت، من همچنین دوست دارم ماکروهایم را به ترتیب حروف الفبا افزایش دهم، مانند `qa`، سپس `qb`، سپس `qc` و غیره.

یک روش پیدا کنید که برای شما بهترین کارایی را داشته باشد.