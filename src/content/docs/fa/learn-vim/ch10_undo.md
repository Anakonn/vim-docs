---
description: این سند به بررسی سیستم بازگشت و پیشرفت در ویم می‌پردازد و نحوه دسترسی
  به وضعیت‌های مختلف متن و کنترل تغییرات را آموزش می‌دهد.
title: Ch10. Undo
---

ما همه انواع اشتباهات تایپی را مرتکب می‌شویم. به همین دلیل، قابلیت بازگشت (undo) یک ویژگی ضروری در هر نرم‌افزار مدرن است. سیستم بازگشت و پیشرفت (undo) در Vim نه تنها قادر به بازگشت و پیشرفت اشتباهات ساده است، بلکه به شما این امکان را می‌دهد که به حالت‌های مختلف متن دسترسی پیدا کنید و کنترل کاملی بر تمام متونی که تاکنون تایپ کرده‌اید داشته باشید. در این فصل، یاد خواهید گرفت که چگونه بازگشت، پیشرفت، ناوبری در یک شاخه بازگشت، حفظ بازگشت و سفر در زمان را انجام دهید.

## بازگشت، پیشرفت و UNDO

برای انجام یک بازگشت پایه، می‌توانید از `u` استفاده کنید یا دستور `:undo` را اجرا کنید.

اگر این متن را داشته باشید (به خط خالی زیر "یک" توجه کنید):

```shell
یک

```

سپس متن دیگری اضافه کنید:

```shell
یک
دو
```

اگر `u` را فشار دهید، Vim متن "دو" را باز می‌گرداند.

چگونه Vim می‌داند که چقدر باید بازگرداند؟ Vim یک "تغییر" را در یک زمان باز می‌گرداند، مشابه تغییر در دستور نقطه‌ای (برخلاف دستور نقطه‌ای، دستورات خط فرمان نیز به عنوان یک تغییر حساب می‌شوند).

برای پیشرفت در آخرین تغییر، `Ctrl-R` را فشار دهید یا دستور `:redo` را اجرا کنید. پس از اینکه متن بالا را برای حذف "دو" بازگرداندید، اجرای `Ctrl-R` متن حذف شده را برمی‌گرداند.

Vim همچنین UNDO دارد که می‌توانید با `U` اجرا کنید. این همه تغییرات اخیر را باز می‌گرداند.

چگونه `U` با `u` متفاوت است؟ اول، `U` *همه* تغییرات در آخرین خط تغییر یافته را حذف می‌کند، در حالی که `u` تنها یک تغییر را در یک زمان حذف می‌کند. دوم، در حالی که انجام `u` به عنوان یک تغییر حساب نمی‌شود، انجام `U` به عنوان یک تغییر حساب می‌شود.

به این مثال برگردیم:

```shell
یک
دو
```

خط دوم را به "سه" تغییر دهید:

```shell
یک
سه
```

خط دوم را دوباره تغییر دهید و آن را با "چهار" جایگزین کنید:

```shell
یک
چهار
```

اگر `u` را فشار دهید، "سه" را خواهید دید. اگر دوباره `u` را فشار دهید، "دو" را خواهید دید. اگر به جای فشار دادن `u` وقتی هنوز متن "چهار" را داشتید، `U` را فشار داده بودید، خواهید دید:

```shell
یک

```

`U` تمام تغییرات واسطه‌ای را دور می‌زند و به حالت اصلی که شروع کردید (یک خط خالی) می‌رود. علاوه بر این، از آنجا که UNDO در واقع یک تغییر جدید در Vim ایجاد می‌کند، می‌توانید UNDO خود را بازگردانید. `U` به دنبال `U` خود را باز می‌گرداند. می‌توانید `U` را فشار دهید، سپس `U`، سپس `U` و غیره. شما همان دو حالت متنی را که به جلو و عقب می‌روند، خواهید دید.

من شخصاً از `U` استفاده نمی‌کنم زیرا به یادآوری حالت اصلی دشوار است (به ندرت به آن نیاز دارم).

Vim حداکثر تعداد دفعاتی که می‌توانید بازگشت کنید را در متغیر گزینه `undolevels` تنظیم می‌کند. می‌توانید آن را با `:echo &undolevels` بررسی کنید. من آن را روی 1000 تنظیم کرده‌ام. برای تغییر آن به 1000، دستور `:set undolevels=1000` را اجرا کنید. می‌توانید آن را به هر عددی که دوست دارید تنظیم کنید.

## شکستن بلوک‌ها

قبلاً اشاره کردم که `u` یک "تغییر" واحد را مشابه تغییر در دستور نقطه‌ای باز می‌گرداند: متون وارد شده از زمانی که وارد حالت وارد کردن می‌شوید تا زمانی که از آن خارج می‌شوید به عنوان یک تغییر حساب می‌شوند.

اگر `ione دو سه<Esc>` را انجام دهید و سپس `u` را فشار دهید، Vim تمام متن "یک دو سه" را حذف می‌کند زیرا کل آن به عنوان یک تغییر حساب می‌شود. این مسئله بزرگ نیست اگر متون کوتاهی نوشته‌اید، اما اگر چندین پاراگراف را در یک جلسه حالت وارد کردن بدون خروج نوشته‌اید و بعداً متوجه شدید که اشتباهی مرتکب شده‌اید چه؟ اگر `u` را فشار دهید، همه چیزهایی که نوشته‌اید حذف خواهد شد. آیا مفید نخواهد بود اگر بتوانید `u` را فشار دهید تا تنها یک بخش از متن خود را حذف کنید؟

خوشبختانه، می‌توانید بلوک‌های بازگشت را بشکنید. وقتی در حالت وارد کردن تایپ می‌کنید، فشار دادن `Ctrl-G u` یک نقطه شکست بازگشت ایجاد می‌کند. به عنوان مثال، اگر `ione <Ctrl-G u>دو <Ctrl-G u>سه<Esc>` را انجام دهید، سپس `u` را فشار دهید، تنها متن "سه" را از دست خواهید داد (یک بار دیگر `u` را فشار دهید تا "دو" را حذف کنید). وقتی متنی طولانی می‌نویسید، از `Ctrl-G u` به طور استراتژیک استفاده کنید. انتهای هر جمله، بین دو پاراگراف یا بعد از هر خط کد مکان‌های مناسبی برای افزودن نقاط شکست بازگشت هستند تا در صورت بروز اشتباه، بازگشت به عقب را آسان‌تر کنید.

ایجاد یک نقطه شکست بازگشت هنگام حذف بخش‌ها در حالت وارد کردن با `Ctrl-W` (حذف کلمه قبل از نشانگر) و `Ctrl-U` (حذف تمام متن قبل از نشانگر) نیز مفید است. دوستی پیشنهاد کرد که از نقشه‌های زیر استفاده کنید:

```shell
inoremap <c-u> <c-g>u<c-u>
inoremap <c-w> <c-g>u<c-w>
```

با این‌ها، می‌توانید به راحتی متون حذف شده را بازیابی کنید.

## درخت بازگشت

Vim هر تغییری که تاکنون نوشته شده است را در یک درخت بازگشت ذخیره می‌کند. یک فایل خالی جدید ایجاد کنید. سپس یک متن جدید اضافه کنید:

```shell
یک

```

یک متن جدید اضافه کنید:

```shell
یک
دو
```

یک بار بازگشت کنید:

```shell
یک

```

یک متن متفاوت اضافه کنید:

```shell
یک
سه
```

دوباره بازگشت کنید:

```shell
یک

```

و یک متن متفاوت دیگر اضافه کنید:

```shell
یک
چهار
```

حالا اگر بازگشت کنید، متن "چهار" که تازه اضافه کرده‌اید را از دست خواهید داد:

```shell
یک

```

اگر یک بار دیگر بازگشت کنید:

```shell

```

شما متن "یک" را از دست خواهید داد. در اکثر ویرایشگرهای متنی، بازگرداندن متون "دو" و "سه" غیرممکن خواهد بود، اما نه با Vim! فشار دهید `g+` و متن "یک" خود را برمی‌گردانید:

```shell
یک

```

دوباره `g+` را تایپ کنید و یک دوست قدیمی را خواهید دید:

```shell
یک
دو
```

بگذارید ادامه دهیم. دوباره `g+` را فشار دهید:

```shell
یک
سه
```

یک بار دیگر `g+` را فشار دهید:

```shell
یک
چهار
```

در Vim، هر بار که `u` را فشار دهید و سپس تغییر متفاوتی ایجاد کنید، Vim متن حالت قبلی را با ایجاد یک "شاخه بازگشت" ذخیره می‌کند. در این مثال، پس از اینکه "دو" را تایپ کردید، سپس `u` را فشار دادید، سپس "سه" را تایپ کردید، یک شاخه برگ ایجاد کردید که حالت حاوی متن "دو" را ذخیره می‌کند. در آن لحظه، درخت بازگشت حداقل دو گره برگ داشت: گره اصلی حاوی متن "سه" (جدیدترین) و گره شاخه بازگشت حاوی متن "دو". اگر بازگشت دیگری انجام داده و متن "چهار" را تایپ کرده بودید، سه گره خواهید داشت: یک گره اصلی حاوی متن "چهار" و دو گره حاوی متون "سه" و "دو".

برای پیمایش در هر گره درخت بازگشت، می‌توانید از `g+` برای رفتن به یک حالت جدیدتر و `g-` برای رفتن به یک حالت قدیمی‌تر استفاده کنید. تفاوت بین `u`، `Ctrl-R`، `g+` و `g-` این است که هر دو `u` و `Ctrl-R` فقط درخت اصلی را در درخت بازگشت پیمایش می‌کنند در حالی که `g+` و `g-` *همه* گره‌ها را در درخت بازگشت پیمایش می‌کنند.

درخت بازگشت به راحتی قابل تجسم نیست. من پلاگین [vim-mundo](https://github.com/simnalamburt/vim-mundo) را بسیار مفید می‌دانم که به تجسم درخت بازگشت Vim کمک می‌کند. به آن زمان بدهید تا با آن بازی کنید.

## بازگشت پایدار

اگر Vim را شروع کنید، یک فایل را باز کنید و بلافاصله `u` را فشار دهید، احتمالاً هشدار "*قبلاً در قدیمی‌ترین تغییر هستید*" را مشاهده خواهید کرد. هیچ چیزی برای بازگشت وجود ندارد زیرا هیچ تغییری ایجاد نکرده‌اید.

برای چرخش تاریخچه بازگشت از آخرین جلسه ویرایش، Vim می‌تواند تاریخچه بازگشت شما را با یک فایل بازگشت حفظ کند با `:wundo`.

یک فایل `mynumbers.txt` ایجاد کنید. تایپ کنید:

```shell
یک
```

سپس یک خط دیگر تایپ کنید (اطمینان حاصل کنید که هر خط به عنوان یک تغییر حساب می‌شود):

```shell
یک
دو
```

یک خط دیگر تایپ کنید:

```shell
یک
دو
سه
```

حالا فایل بازگشت خود را با `:wundo {my-undo-file}` ایجاد کنید. اگر نیاز به بازنویسی یک فایل بازگشت موجود دارید، می‌توانید `!` را بعد از `wundo` اضافه کنید.

```shell
:wundo! mynumbers.undo
```

سپس از Vim خارج شوید.

تا الان باید فایل‌های `mynumbers.txt` و `mynumbers.undo` را در دایرکتوری خود داشته باشید. دوباره `mynumbers.txt` را باز کنید و سعی کنید `u` را فشار دهید. نمی‌توانید. از زمانی که فایل را باز کرده‌اید هیچ تغییری ایجاد نکرده‌اید. حالا تاریخچه بازگشت خود را با خواندن فایل بازگشت با `:rundo` بارگذاری کنید:

```shell
:rundo mynumbers.undo
```

حالا اگر `u` را فشار دهید، Vim "سه" را حذف می‌کند. دوباره `u` را فشار دهید تا "دو" را حذف کند. انگار هرگز Vim را بسته‌اید!

اگر می‌خواهید یک پایداری بازگشت خودکار داشته باشید، یکی از راه‌های انجام آن افزودن این موارد به vimrc است:

```shell
set undodir=~/.vim/undo_dir
set undofile
```

تنظیمات بالا تمام فایل‌های بازگشت را در یک دایرکتوری متمرکز، دایرکتوری `~/.vim` قرار می‌دهد. نام `undo_dir` دلخواه است. `set undofile` به Vim می‌گوید که ویژگی `undofile` را فعال کند زیرا به طور پیش‌فرض خاموش است. حالا هر بار که ذخیره می‌کنید، Vim به طور خودکار فایل مربوطه را در دایرکتوری `undo_dir` ایجاد و به‌روزرسانی می‌کند (اطمینان حاصل کنید که دایرکتوری واقعی `undo_dir` را در دایرکتوری `~/.vim` قبل از اجرای این دستور ایجاد کرده‌اید).

## سفر در زمان

چه کسی می‌گوید سفر در زمان وجود ندارد؟ Vim می‌تواند به یک حالت متنی در گذشته با دستور `:earlier` سفر کند.

اگر این متن را داشته باشید:

```shell
یک

```
سپس بعداً اضافه کنید:

```shell
یک
دو
```

اگر "دو" را کمتر از ده ثانیه پیش تایپ کرده باشید، می‌توانید به حالتی که "دو" وجود نداشت، ده ثانیه پیش برگردید با:

```shell
:earlier 10s
```

می‌توانید از `:undolist` برای دیدن زمان آخرین تغییر استفاده کنید. `:earlier` همچنین پذیرای آرگومان‌های مختلف است:

```shell
:earlier 10s    به حالت 10 ثانیه قبل بروید
:earlier 10m    به حالت 10 دقیقه قبل بروید
:earlier 10h    به حالت 10 ساعت قبل بروید
:earlier 10d    به حالت 10 روز قبل بروید
```

علاوه بر این، همچنین یک `count` معمولی را به عنوان آرگومان می‌پذیرد تا به Vim بگوید که به حالت قدیمی‌تر `count` بار برود. به عنوان مثال، اگر `:earlier 2` را انجام دهید، Vim به حالت متنی قدیمی‌تر دو تغییر پیش می‌رود. این همانند انجام `g-` دو بار است. همچنین می‌توانید به آن بگویید که به حالت متنی قدیمی‌تر 10 ذخیره پیش برود با `:earlier 10f`.

مجموعه‌ای از آرگومان‌های مشابه با معادل `:earlier` کار می‌کند: `:later`.

```shell
:later 10s    به حالت 10 ثانیه بعد بروید
:later 10m    به حالت 10 دقیقه بعد بروید
:later 10h    به حالت 10 ساعت بعد بروید
:later 10d    به حالت 10 روز بعد بروید
:later 10     به حالت جدیدتر 10 بار بروید
:later 10f    به حالت 10 ذخیره بعد بروید
```

## یادگیری بازگشت به روش هوشمند

`u` و `Ctrl-R` دو دستور ضروری Vim برای اصلاح اشتباهات هستند. ابتدا آن‌ها را یاد بگیرید. سپس، یاد بگیرید که چگونه از `:earlier` و `:later` با استفاده از آرگومان‌های زمانی استفاده کنید. پس از آن، زمان خود را برای درک درخت بازگشت صرف کنید. پلاگین [vim-mundo](https://github.com/simnalamburt/vim-mundo) به من کمک زیادی کرد. متن‌های این فصل را تایپ کنید و در حین ایجاد هر تغییر، درخت بازگشت را بررسی کنید. هنگامی که آن را درک کردید، هرگز سیستم بازگشت را به همان شکل قبلی نخواهید دید.

قبل از این فصل، یاد گرفتید که چگونه هر متنی را در یک فضای پروژه پیدا کنید، با بازگشت، اکنون می‌توانید هر متنی را در بعد زمانی پیدا کنید. اکنون قادر به جستجوی هر متنی بر اساس موقعیت و زمان نوشته شده‌اید. شما به وجود همه‌جانبه Vim دست یافته‌اید.