---
description: این فصل به بررسی مسیرهای زمان اجرا در ویم می‌پردازد و نحوه سفارشی‌سازی
  آن‌ها را برای بهبود تجربه کاربری توضیح می‌دهد.
title: Ch24. Vim Runtime
---

در فصل‌های قبلی، من اشاره کردم که Vim به طور خودکار به دنبال مسیرهای خاصی مانند `pack/` (فصل ۲۲) و `compiler/` (فصل ۱۹) در دایرکتوری `~/.vim/` می‌گردد. این‌ها نمونه‌هایی از مسیرهای زمان اجرای Vim هستند.

Vim بیشتر از این دو مسیر زمان اجرا دارد. در این فصل، شما یک مرور کلی از این مسیرهای زمان اجرا خواهید آموخت. هدف این فصل نشان دادن زمان‌هایی است که آن‌ها فراخوانی می‌شوند. دانستن این موضوع به شما این امکان را می‌دهد که Vim را بیشتر درک و سفارشی‌سازی کنید.

## مسیر زمان اجرا

در یک ماشین یونیکس، یکی از مسیرهای زمان اجرای Vim شما `$HOME/.vim/` است (اگر سیستم‌عامل متفاوتی مانند ویندوز دارید، مسیر شما ممکن است متفاوت باشد). برای دیدن اینکه مسیرهای زمان اجرا برای سیستم‌عامل‌های مختلف چیست، به `:h 'runtimepath'` مراجعه کنید. در این فصل، من از `~/.vim/` به عنوان مسیر زمان اجرای پیش‌فرض استفاده خواهم کرد.

## اسکریپت‌های پلاگین

Vim یک مسیر زمان اجرای پلاگین دارد که هر بار که Vim شروع می‌شود، هر اسکریپت در این دایرکتوری را یک بار اجرا می‌کند. نام "پلاگین" را با پلاگین‌های خارجی Vim (مانند NERDTree، fzf.vim و غیره) اشتباه نگیرید.

به دایرکتوری `~/.vim/` بروید و یک دایرکتوری `plugin/` ایجاد کنید. دو فایل ایجاد کنید: `donut.vim` و `chocolate.vim`.

درون `~/.vim/plugin/donut.vim`:

```shell
echo "donut!"
```

درون `~/.vim/plugin/chocolate.vim`:

```shell
echo "chocolate!"
```

حالا Vim را ببندید. دفعه بعد که Vim را باز کنید، هر دو `"donut!"` و `"chocolate!"` نمایش داده خواهند شد. مسیر زمان اجرای پلاگین می‌تواند برای اسکریپت‌های اولیه استفاده شود.

## تشخیص نوع فایل

قبل از شروع، برای اطمینان از اینکه این تشخیص‌ها کار می‌کنند، مطمئن شوید که vimrc شما حداقل شامل خط زیر باشد:

```shell
filetype plugin indent on
```

برای زمینه بیشتر به `:h filetype-overview` مراجعه کنید. اساساً این کار تشخیص نوع فایل Vim را فعال می‌کند.

وقتی یک فایل جدید باز می‌کنید، معمولاً Vim می‌داند که نوع فایل چیست. اگر شما یک فایل `hello.rb` داشته باشید، اجرای `:set filetype?` پاسخ صحیح `filetype=ruby` را برمی‌گرداند.

Vim می‌داند که چگونه نوع فایل‌های "متداول" (Ruby، Python، Javascript و غیره) را تشخیص دهد. اما اگر شما یک فایل سفارشی داشته باشید چه؟ شما باید به Vim آموزش دهید که آن را تشخیص دهد و نوع فایل صحیح را به آن اختصاص دهد.

دو روش برای تشخیص وجود دارد: استفاده از نام فایل و محتوای فایل.

### تشخیص نام فایل

تشخیص نام فایل نوع فایل را با استفاده از نام آن فایل تشخیص می‌دهد. وقتی شما فایل `hello.rb` را باز می‌کنید، Vim می‌داند که این یک فایل Ruby است به دلیل پسوند `.rb`.

دو راه برای انجام تشخیص نام فایل وجود دارد: استفاده از دایرکتوری زمان اجرای `ftdetect/` و استفاده از فایل زمان اجرای `filetype.vim`. بیایید هر دو را بررسی کنیم.

#### `ftdetect/`

بیایید یک فایل مبهم (اما خوشمزه) ایجاد کنیم، `hello.chocodonut`. وقتی آن را باز می‌کنید و `:set filetype?` را اجرا می‌کنید، از آنجا که این یک پسوند نام فایل متداول نیست، Vim نمی‌داند چه چیزی از آن بسازد. این دستور `filetype=` را برمی‌گرداند.

شما باید به Vim دستور دهید که تمام فایل‌هایی که با `.chocodonut` پایان می‌یابند را به عنوان نوع فایل "chocodonut" تنظیم کند. یک دایرکتوری به نام `ftdetect/` در ریشه زمان اجرا (`~/.vim/`) ایجاد کنید. درون آن، یک فایل ایجاد کنید و نام آن را `chocodonut.vim` (`~/.vim/ftdetect/chocodonut.vim`) بگذارید. درون این فایل، اضافه کنید:

```shell
autocmd BufNewFile,BufRead *.chocodonut set filetype=chocodonut
```

`BufNewFile` و `BufRead` هر بار که شما یک بافر جدید ایجاد می‌کنید و یک بافر جدید باز می‌کنید، فعال می‌شوند. `*.chocodonut` به این معنی است که این رویداد فقط زمانی فعال خواهد شد که بافر باز شده دارای پسوند نام فایل `.chocodonut` باشد. در نهایت، دستور `set filetype=chocodonut` نوع فایل را به نوع chocodonut تنظیم می‌کند.

Vim را دوباره راه‌اندازی کنید. حالا فایل `hello.chocodonut` را باز کنید و `:set filetype?` را اجرا کنید. این دستور `filetype=chocodonut` را برمی‌گرداند.

خوشمزه! شما می‌توانید هر تعداد فایلی که می‌خواهید درون `ftdetect/` قرار دهید. در آینده، شاید بخواهید `ftdetect/strawberrydonut.vim`، `ftdetect/plaindonut.vim` و غیره را اضافه کنید، اگر تصمیم بگیرید که نوع‌های فایل دونات خود را گسترش دهید.

در واقع، دو راه برای تنظیم نوع فایل در Vim وجود دارد. یکی همان است که شما استفاده کردید `set filetype=chocodonut`. راه دیگر این است که `setfiletype chocodonut` را اجرا کنید. دستور اول `set filetype=chocodonut` *همیشه* نوع فایل را به نوع chocodonut تنظیم می‌کند، در حالی که دستور دوم `setfiletype chocodonut` فقط نوع فایل را تنظیم می‌کند اگر هنوز نوع فایلی تنظیم نشده باشد.

#### فایل نوع فایل

روش دوم تشخیص فایل نیاز دارد که شما یک `filetype.vim` در دایرکتوری ریشه (`~/.vim/filetype.vim`) ایجاد کنید. این را درون آن اضافه کنید:

```shell
autocmd BufNewFile,BufRead *.plaindonut set filetype=plaindonut
```

یک فایل `hello.plaindonut` ایجاد کنید. وقتی آن را باز می‌کنید و `:set filetype?` را اجرا می‌کنید، Vim نوع فایل سفارشی صحیح `filetype=plaindonut` را نمایش می‌دهد.

عجب شیرینی، کار می‌کند! به هر حال، اگر با `filetype.vim` بازی کنید، ممکن است متوجه شوید که این فایل چندین بار زمانی که شما `hello.plaindonut` را باز می‌کنید اجرا می‌شود. برای جلوگیری از این، می‌توانید یک محافظ اضافه کنید تا اسکریپت اصلی فقط یک بار اجرا شود. `filetype.vim` را به‌روز کنید:

```shell
if exists("did_load_filetypes")
  finish
endif

augroup donutfiletypedetection
  autocmd! BufRead,BufNewFile *.plaindonut setfiletype plaindonut
augroup END
```

`finish` یک دستور Vim برای متوقف کردن اجرای بقیه اسکریپت است. عبارت `"did_load_filetypes"` *یک* تابع داخلی Vim نیست. در واقع، این یک متغیر جهانی از درون `$VIMRUNTIME/filetype.vim` است. اگر کنجکاو هستید، `:e $VIMRUNTIME/filetype.vim` را اجرا کنید. شما این خطوط را درون آن خواهید یافت:

```shell
if exists("did_load_filetypes")
  finish
endif

let did_load_filetypes = 1
```

زمانی که Vim این فایل را فراخوانی می‌کند، متغیر `did_load_filetypes` را تعریف کرده و آن را به ۱ تنظیم می‌کند. ۱ در Vim درست است. شما باید بقیه `filetype.vim` را نیز بخوانید. ببینید آیا می‌توانید بفهمید که چه کاری انجام می‌دهد وقتی Vim آن را فراخوانی می‌کند.

### اسکریپت نوع فایل

بیایید یاد بگیریم که چگونه نوع فایل را بر اساس محتوای فایل تشخیص داده و اختصاص دهیم.

فرض کنید شما مجموعه‌ای از فایل‌ها دارید که پسوند قابل قبولی ندارند. تنها چیزی که این فایل‌ها در آن مشترک هستند این است که همه آن‌ها با کلمه "donutify" در خط اول شروع می‌شوند. شما می‌خواهید این فایل‌ها را به نوع فایل `donut` اختصاص دهید. فایل‌های جدیدی به نام‌های `sugardonut`، `glazeddonut` و `frieddonut` (بدون پسوند) ایجاد کنید. درون هر فایل، این خط را اضافه کنید:

```shell
donutify
```

زمانی که شما از داخل `sugardonut` `:set filetype?` را اجرا می‌کنید، Vim نمی‌داند چه نوع فایلی را باید به این فایل اختصاص دهد. این دستور `filetype=` را برمی‌گرداند.

در مسیر ریشه زمان اجرا، یک فایل `scripts.vim` اضافه کنید (`~/.vim/scripts.vim`). درون آن، این‌ها را اضافه کنید:

```shell
if did_filetype()
  finish
endif

if getline(1) =~ '^\\<donutify\\>'
  setfiletype donut
endif
```

تابع `getline(1)` متن خط اول را برمی‌گرداند. این بررسی می‌کند که آیا خط اول با کلمه "donutify" شروع می‌شود یا خیر. تابع `did_filetype()` یک تابع داخلی Vim است. این تابع زمانی که یک رویداد مرتبط با نوع فایل حداقل یک بار فراخوانی شود، درست برمی‌گرداند. این به عنوان یک محافظ برای متوقف کردن دوباره‌اجرای رویداد نوع فایل استفاده می‌شود.

فایل `sugardonut` را باز کنید و `:set filetype?` را اجرا کنید، اکنون Vim `filetype=donut` را برمی‌گرداند. اگر شما فایل‌های دیگر دونات (`glazeddonut` و `frieddonut`) را باز کنید، Vim همچنین نوع فایل آن‌ها را به عنوان نوع `donut` شناسایی می‌کند.

توجه داشته باشید که `scripts.vim` فقط زمانی اجرا می‌شود که Vim فایلی با نوع فایل ناشناخته باز کند. اگر Vim فایلی با نوع فایل شناخته شده باز کند، `scripts.vim` اجرا نخواهد شد.

## پلاگین نوع فایل

اگر بخواهید Vim اسکریپت‌های خاص chocodonut را زمانی که یک فایل chocodonut باز می‌کنید اجرا کند و این اسکریپت‌ها را زمانی که فایل plaindonut را باز می‌کنید اجرا نکند، چه می‌کنید؟

شما می‌توانید این کار را با مسیر زمان اجرای پلاگین نوع فایل (`~/.vim/ftplugin/`) انجام دهید. Vim در این دایرکتوری به دنبال فایلی با همان نام نوع فایلی که تازه باز کرده‌اید می‌گردد. یک فایل `chocodonut.vim` ایجاد کنید (`~/.vim/ftplugin/chocodonut.vim`):

```shell
echo "Calling from chocodonut ftplugin"
```

یک فایل ftplugin دیگر، `plaindonut.vim` (`~/.vim/ftplugin/plaindonut.vim`) ایجاد کنید:

```shell
echo "Calling from plaindonut ftplugin"
```

حالا هر بار که شما یک نوع فایل chocodonut را باز کنید، Vim اسکریپت‌ها را از `~/.vim/ftplugin/chocodonut.vim` اجرا می‌کند. هر بار که شما یک نوع فایل plaindonut را باز کنید، Vim اسکریپت‌ها را از `~/.vim/ftplugin/plaindonut.vim` اجرا می‌کند.

یک هشدار: این فایل‌ها هر بار که نوع فایل یک بافر تنظیم می‌شود (`set filetype=chocodonut` به عنوان مثال) اجرا می‌شوند. اگر شما ۳ فایل مختلف chocodonut را باز کنید، اسکریپت‌ها *در مجموع* سه بار اجرا خواهند شد.

## فایل‌های فرمت

Vim یک مسیر زمان اجرای فرمت دارد که مشابه ftplugin کار می‌کند، جایی که Vim به دنبال فایلی با همان نام نوع فایلی که باز شده است می‌گردد. هدف این مسیرهای زمان اجرای فرمت ذخیره کدهای مرتبط با فرمت است. اگر شما فایل `~/.vim/indent/chocodonut.vim` را داشته باشید، فقط زمانی که شما یک نوع فایل chocodonut را باز کنید، اجرا خواهد شد. شما می‌توانید کدهای مرتبط با فرمت برای فایل‌های chocodonut را در اینجا ذخیره کنید.

## رنگ‌ها

Vim یک مسیر زمان اجرای رنگ‌ها (`~/.vim/colors/`) برای ذخیره طرح‌های رنگی دارد. هر فایلی که درون این دایرکتوری قرار بگیرد در دستور `:color` نمایش داده خواهد شد.

اگر شما یک فایل `~/.vim/colors/beautifulprettycolors.vim` داشته باشید، وقتی شما `:color` را اجرا می‌کنید و Tab را فشار می‌دهید، `beautifulprettycolors` به عنوان یکی از گزینه‌های رنگی نمایش داده خواهد شد. اگر شما ترجیح می‌دهید که طرح رنگی خود را اضافه کنید، اینجا جایی است که باید بروید.

اگر می‌خواهید طرح‌های رنگی که دیگران ساخته‌اند را بررسی کنید، یک مکان خوب برای بازدید [vimcolors](https://vimcolors.com/) است.

## هایلایت سینتکس

Vim یک مسیر زمان اجرای سینتکس (`~/.vim/syntax/`) برای تعریف هایلایت سینتکس دارد.

فرض کنید شما یک فایل `hello.chocodonut` دارید، درون آن شما عبارات زیر را دارید:

```shell
(donut "tasty")
(donut "savory")
```

اگرچه اکنون Vim نوع فایل صحیح را می‌داند، تمام متن‌ها رنگ یکسانی دارند. بیایید یک قانون هایلایت سینتکس اضافه کنیم تا کلمه "donut" را هایلایت کنیم. یک فایل سینتکس جدید برای chocodonut ایجاد کنید، `~/.vim/syntax/chocodonut.vim`. درون آن اضافه کنید:

```shell
syntax keyword donutKeyword donut

highlight link donutKeyword Keyword
```

حالا فایل `hello.chocodonut` را دوباره باز کنید. کلمات کلیدی `donut` اکنون هایلایت شده‌اند.

این فصل به طور عمیق به هایلایت سینتکس نمی‌پردازد. این یک موضوع وسیع است. اگر کنجکاو هستید، به `:h syntax.txt` مراجعه کنید.

پلاگین [vim-polyglot](https://github.com/sheerun/vim-polyglot) یک پلاگین عالی است که هایلایت‌هایی برای بسیاری از زبان‌های برنامه‌نویسی محبوب ارائه می‌دهد.

## مستندات

اگر شما یک پلاگین ایجاد کنید، باید مستندات خود را ایجاد کنید. شما از مسیر زمان اجرای doc برای این کار استفاده می‌کنید.

بیایید یک مستندات پایه برای کلمات کلیدی chocodonut و plaindonut ایجاد کنیم. یک فایل `donut.txt` (`~/.vim/doc/donut.txt`) ایجاد کنید. درون آن، این متون را اضافه کنید:

```shell
*chocodonut* Delicious chocolate donut

*plaindonut* No choco goodness but still delicious nonetheless
```

اگر شما سعی کنید برای `chocodonut` و `plaindonut` جستجو کنید (`:h chocodonut` و `:h plaindonut`)، چیزی پیدا نخواهید کرد.

ابتدا، شما باید `:helptags` را اجرا کنید تا ورودی‌های کمک جدیدی ایجاد کنید. `:helptags ~/.vim/doc/`

حالا اگر شما `:h chocodonut` و `:h plaindonut` را اجرا کنید، این ورودی‌های کمک جدید را خواهید یافت. توجه داشته باشید که فایل اکنون فقط خواندنی است و نوع فایل "help" دارد.
## بارگذاری تنبل اسکریپت‌ها

تمام مسیرهای زمان اجرا که در این فصل یاد گرفتید به طور خودکار اجرا شدند. اگر می‌خواهید یک اسکریپت را به صورت دستی بارگذاری کنید، از مسیر زمان اجرای autoload استفاده کنید.

یک دایرکتوری autoload ایجاد کنید (`~/.vim/autoload/`). درون آن دایرکتوری، یک فایل جدید ایجاد کرده و نام آن را `tasty.vim` بگذارید (`~/.vim/autoload/tasty.vim`). درون آن:

```shell
echo "tasty.vim global"

function tasty#donut()
  echo "tasty#donut"
endfunction
```

توجه داشته باشید که نام تابع `tasty#donut` است، نه `donut()`. علامت پوند (`#`) هنگام استفاده از ویژگی autoload الزامی است. کنوانسیون نام‌گذاری تابع برای ویژگی autoload به این صورت است:

```shell
function fileName#functionName()
  ...
endfunction
```

در این مورد، نام فایل `tasty.vim` و نام تابع (به طور فنی) `donut` است.

برای فراخوانی یک تابع، به دستور `call` نیاز دارید. بیایید آن تابع را با `:call tasty#donut()` فراخوانی کنیم.

بار اولی که تابع را فراخوانی می‌کنید، باید *هر دو* پیام echo ("tasty.vim global" و "tasty#donut") را ببینید. فراخوانی‌های بعدی به تابع `tasty#donut` فقط پیام echo "testy#donut" را نمایش می‌دهند.

زمانی که یک فایل را در Vim باز می‌کنید، بر خلاف مسیرهای زمان اجرای قبلی، اسکریپت‌های autoload به طور خودکار بارگذاری نمی‌شوند. تنها زمانی که به طور صریح `tasty#donut()` را فراخوانی کنید، Vim به دنبال فایل `tasty.vim` می‌گردد و همه چیز داخل آن، از جمله تابع `tasty#donut()` را بارگذاری می‌کند. Autoload مکانیزم مناسبی برای توابعی است که منابع زیادی را استفاده می‌کنند اما شما به ندرت از آن‌ها استفاده می‌کنید.

شما می‌توانید به تعداد دلخواه دایرکتوری‌های تو در تو با autoload اضافه کنید. اگر مسیر زمان اجرا `~/.vim/autoload/one/two/three/tasty.vim` دارید، می‌توانید تابع را با `:call one#two#three#tasty#donut()` فراخوانی کنید.

## اسکریپت‌های بعدی

Vim یک مسیر زمان اجرای بعدی (`~/.vim/after/`) دارد که ساختار `~/.vim/` را منعکس می‌کند. هر چیزی در این مسیر آخرین اجرا می‌شود، بنابراین توسعه‌دهندگان معمولاً از این مسیرها برای نادیده‌گرفتن اسکریپت‌ها استفاده می‌کنند.

به عنوان مثال، اگر می‌خواهید اسکریپت‌های موجود در `plugin/chocolate.vim` را نادیده بگیرید، می‌توانید `~/.vim/after/plugin/chocolate.vim` را ایجاد کنید تا اسکریپت‌های نادیده‌گیر را قرار دهید. Vim اسکریپت `~/.vim/after/plugin/chocolate.vim` را *پس از* `~/.vim/plugin/chocolate.vim` اجرا خواهد کرد.

## $VIMRUNTIME

Vim یک متغیر محیطی `$VIMRUNTIME` برای اسکریپت‌ها و فایل‌های پشتیبانی پیش‌فرض دارد. می‌توانید با اجرای `:e $VIMRUNTIME` آن را بررسی کنید.

ساختار باید برای شما آشنا باشد. این شامل بسیاری از مسیرهای زمان اجرا است که در این فصل یاد گرفتید.

به یاد داشته باشید که در فصل 21، یاد گرفتید که وقتی Vim را باز می‌کنید، به دنبال فایل‌های vimrc در هفت مکان مختلف می‌گردد. من گفتم که آخرین مکانی که Vim بررسی می‌کند `$VIMRUNTIME/defaults.vim` است. اگر Vim نتواند هیچ فایل vimrc کاربری پیدا کند، از `defaults.vim` به عنوان vimrc استفاده می‌کند.

آیا تا به حال سعی کرده‌اید Vim را بدون پلاگین syntax مانند vim-polyglot اجرا کنید و با این حال فایل شما هنوز هم به طور نحوی هایلایت شده است؟ این به این دلیل است که وقتی Vim نتواند یک فایل syntax از مسیر زمان اجرا پیدا کند، به دنبال یک فایل syntax از دایرکتوری syntax `$VIMRUNTIME` می‌گردد.

برای یادگیری بیشتر، به `:h $VIMRUNTIME` مراجعه کنید.

## گزینه Runtimepath

برای بررسی runtimepath خود، `:set runtimepath?` را اجرا کنید.

اگر از Vim-Plug یا مدیران پلاگین خارجی محبوب استفاده می‌کنید، باید فهرستی از دایرکتوری‌ها را نمایش دهد. به عنوان مثال، من نشان می‌دهد:

```shell
runtimepath=~/.vim,~/.vim/plugged/vim-signify,~/.vim/plugged/base16-vim,~/.vim/plugged/fzf.vim,~/.vim/plugged/fzf,~/.vim/plugged/vim-gutentags,~/.vim/plugged/tcomment_vim,~/.vim/plugged/emmet-vim,~/.vim/plugged/vim-fugitive,~/.vim/plugged/vim-sensible,~/.vim/plugged/lightline.vim, ...
```

یکی از کارهایی که مدیران پلاگین انجام می‌دهند این است که هر پلاگین را به مسیر زمان اجرا اضافه می‌کنند. هر مسیر زمان اجرا می‌تواند ساختار دایرکتوری خاص خود را مشابه `~/.vim/` داشته باشد.

اگر یک دایرکتوری `~/box/of/donuts/` دارید و می‌خواهید آن دایرکتوری را به مسیر زمان اجرای خود اضافه کنید، می‌توانید این را به vimrc خود اضافه کنید:

```shell
set rtp+=$HOME/box/of/donuts/
```

اگر درون `~/box/of/donuts/`، یک دایرکتوری پلاگین (`~/box/of/donuts/plugin/hello.vim`) و یک ftplugin (`~/box/of/donuts/ftplugin/chocodonut.vim`) دارید، Vim تمام اسکریپت‌ها را از `plugin/hello.vim` زمانی که Vim را باز می‌کنید اجرا خواهد کرد. Vim همچنین `ftplugin/chocodonut.vim` را زمانی که یک فایل chocodonut را باز می‌کنید اجرا خواهد کرد.

این را خودتان امتحان کنید: یک مسیر دلخواه ایجاد کنید و آن را به runtimepath خود اضافه کنید. برخی از مسیرهای زمان اجرا که از این فصل یاد گرفتید را اضافه کنید. مطمئن شوید که آن‌ها به درستی کار می‌کنند.

## یادگیری Runtime به شیوه هوشمند

زمان خود را برای خواندن آن بگذارید و با این مسیرهای زمان اجرا بازی کنید. برای دیدن اینکه چگونه مسیرهای زمان اجرا در عمل استفاده می‌شوند، به مخزن یکی از پلاگین‌های محبوب Vim خود بروید و ساختار دایرکتوری آن را مطالعه کنید. شما باید اکنون بتوانید بیشتر آن‌ها را درک کنید. سعی کنید دنبال کنید و تصویر کلی را تشخیص دهید. حال که ساختار دایرکتوری Vim را درک کرده‌اید، آماده‌اید تا Vimscript را یاد بگیرید.