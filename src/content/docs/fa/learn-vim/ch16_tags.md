---
description: این سند به شما آموزش می‌دهد که چگونه با استفاده از تگ‌های Vim به سرعت
  به تعاریف در کدها دسترسی پیدا کنید و درک بهتری از کدها داشته باشید.
title: Ch16. Tags
---

یک ویژگی مفید در ویرایش متن، توانایی رفتن به هر تعریفی به سرعت است. در این فصل، یاد خواهید گرفت که چگونه از تگ‌های Vim برای این کار استفاده کنید.

## مرور تگ

فرض کنید کسی یک کد جدید به شما داده است:

```shell
one = One.new
one.donut
```

`One`؟ `donut`؟ خوب، این‌ها ممکن است برای توسعه‌دهندگانی که کد را در آن زمان نوشته‌اند واضح بوده باشد، اما اکنون آن توسعه‌دهندگان دیگر اینجا نیستند و این بر عهده شماست که این کدهای مبهم را درک کنید. یکی از راه‌ها برای کمک به درک این موضوع، پیگیری کد منبع است که در آن `One` و `donut` تعریف شده‌اند.

شما می‌توانید با استفاده از `fzf` یا `grep` (یا `vimgrep`) به دنبال آن‌ها بگردید، اما در این مورد، تگ‌ها سریع‌تر هستند.

به تگ‌ها مانند یک دفترچه آدرس فکر کنید:

```shell
Name    Address
Iggy1   1234 Cool St, 11111
Iggy2   9876 Awesome Ave, 2222
```

به جای داشتن یک جفت نام-آدرس، تگ‌ها تعاریف را با آدرس‌ها جفت می‌کنند.

فرض کنید که شما این دو فایل Ruby را در یک دایرکتوری دارید:

```shell
## one.rb
class One
  def initialize
    puts "Initialized"
  end

  def donut
    puts "Bar"
  end
end
```

و

```shell
## two.rb
require './one'

one = One.new
one.donut
```

برای پرش به یک تعریف، می‌توانید از `Ctrl-]` در حالت عادی استفاده کنید. در داخل `two.rb`، به خطی که `one.donut` در آن است بروید و نشانگر را روی `donut` قرار دهید. `Ctrl-]` را فشار دهید.

اوه، Vim نتوانست فایل تگ را پیدا کند. شما ابتدا باید فایل تگ را تولید کنید.

## تولیدکننده تگ

Vim مدرن به همراه تولیدکننده تگ نمی‌آید، بنابراین شما باید یک تولیدکننده تگ خارجی دانلود کنید. گزینه‌های متعددی برای انتخاب وجود دارد:

- ctags = فقط C. تقریباً در همه جا در دسترس است.
- exuberant ctags = یکی از محبوب‌ترین‌ها. دارای پشتیبانی از زبان‌های متعدد.
- universal ctags = مشابه exuberant ctags، اما جدیدتر.
- etags = برای Emacs. همم...
- JTags = جاوا
- ptags.py = پایتون
- ptags = پرل
- gnatxref = آدا

اگر به آموزش‌های Vim آنلاین نگاه کنید، بسیاری از آن‌ها [exuberant ctags](http://ctags.sourceforge.net/) را توصیه می‌کنند. این ابزار از [41 زبان برنامه‌نویسی](http://ctags.sourceforge.net/languages.html) پشتیبانی می‌کند. من از آن استفاده کردم و عالی کار کرد. با این حال، از آنجایی که از سال 2009 نگهداری نشده است، universal ctags انتخاب بهتری خواهد بود. این ابزار مشابه exuberant ctags کار می‌کند و در حال حاضر در حال نگهداری است.

من به جزئیات نصب universal ctags نمی‌پردازم. برای دستورالعمل‌های بیشتر به مخزن [universal ctags](https://github.com/universal-ctags/ctags) مراجعه کنید.

فرض کنید که universal ctags را نصب کرده‌اید، بیایید یک فایل تگ پایه تولید کنیم. اجرا کنید:

```shell
ctags -R .
```

گزینه `R` به ctags می‌گوید که یک اسکن بازگشتی از مکان فعلی شما (`.`) انجام دهد. شما باید یک فایل `tags` در دایرکتوری فعلی خود ببینید. در داخل آن چیزی شبیه به این خواهید دید:

```shell
!_TAG_FILE_FORMAT	2	/فرمت گسترش یافته؛ --format=1 به خطوط ;" اضافه نخواهد کرد/
!_TAG_FILE_SORTED	1	/0=بدون ترتیب، 1=ترتیب‌دار، 2=حساس به حروف بزرگ و کوچک/
!_TAG_OUTPUT_FILESEP	slash	/اسلش یا بک‌اسلش/
!_TAG_OUTPUT_MODE	u-ctags	/u-ctags یا e-ctags/
!_TAG_PATTERN_LENGTH_LIMIT	96	/0 برای بدون محدودیت/
!_TAG_PROGRAM_AUTHOR	Universal Ctags Team	//
!_TAG_PROGRAM_NAME	Universal Ctags	/مشتق از Exuberant Ctags/
!_TAG_PROGRAM_URL	<https://ctags.io/>	/سایت رسمی/
!_TAG_PROGRAM_VERSION	0.0.0	/b43eb39/
One	one.rb	/^class One$/;"	c
donut	one.rb	/^  def donut$/;"	f	class:One
initialize	one.rb	/^  def initialize$/;"	f	class:One
```

ممکن است فایل شما کمی متفاوت به نظر برسد بسته به تنظیمات Vim و تولیدکننده ctags. یک فایل تگ از دو بخش تشکیل شده است: متاداده تگ و لیست تگ. این متاداده (`!TAG_FILE...`) معمولاً توسط تولیدکننده ctags کنترل می‌شود. من در اینجا به آن نمی‌پردازم، اما می‌توانید مستندات آن‌ها را بررسی کنید! لیست تگ، لیستی از تمام تعاریف ایندکس شده توسط ctags است.

حالا به `two.rb` بروید، نشانگر را روی `donut` قرار دهید و `Ctrl-]` را تایپ کنید. Vim شما را به فایل `one.rb` در خطی که `def donut` است می‌برد. موفقیت! اما چگونه Vim این کار را انجام داد؟

## آناتومی تگ‌ها

بیایید به مورد تگ `donut` نگاه کنیم:

```shell
donut	one.rb	/^  def donut$/;"	f	class:One
```

مورد تگ بالا از چهار جزء تشکیل شده است: یک `tagname`، یک `tagfile`، یک `tagaddress` و گزینه‌های تگ.
- `donut` نام `tagname` است. وقتی نشانگر شما روی "donut" است، Vim در فایل تگ به دنبال خطی می‌گردد که رشته "donut" را داشته باشد.
- `one.rb` نام `tagfile` است. Vim به دنبال فایلی به نام `one.rb` می‌گردد.
- `/^ def donut$/` آدرس `tagaddress` است. `/.../` نشانگر الگو است. `^` الگوی اولین عنصر در یک خط است. پس از آن دو فاصله وجود دارد، سپس رشته `def donut`. در نهایت، `$` الگوی آخرین عنصر در یک خط است.
- `f class:One` گزینه تگ است که به Vim می‌گوید که تابع `donut` یک تابع (`f`) است و بخشی از کلاس `One` است.

بیایید به یک مورد دیگر در لیست تگ نگاه کنیم:

```shell
One	one.rb	/^class One$/;"	c
```

این خط به همان شیوه‌ای که الگوی `donut` کار می‌کند:

- `One` نام `tagname` است. توجه داشته باشید که با تگ‌ها، اولین اسکن حساس به حروف بزرگ و کوچک است. اگر شما `One` و `one` را در لیست داشته باشید، Vim `One` را به `one` ترجیح می‌دهد.
- `one.rb` نام `tagfile` است. Vim به دنبال فایلی به نام `one.rb` می‌گردد.
- `/^class One$/` الگوی `tagaddress` است. Vim به دنبال خطی می‌گردد که با (`^`) `class` شروع می‌شود و با (`$`) `One` پایان می‌یابد.
- `c` یکی از گزینه‌های ممکن تگ است. از آنجایی که `One` یک کلاس روبی است و نه یک رویه، با `c` علامت‌گذاری می‌شود.

بسته به اینکه از کدام تولیدکننده تگ استفاده می‌کنید، محتوای فایل تگ شما ممکن است متفاوت به نظر برسد. حداقل، یک فایل تگ باید یکی از این فرمت‌ها را داشته باشد:

```shell
1.  {tagname} {TAB} {tagfile} {TAB} {tagaddress}
2.  {tagname} {TAB} {tagfile} {TAB} {tagaddress} {term} {field} ..
```

## فایل تگ

شما یاد گرفته‌اید که پس از اجرای `ctags -R .` یک فایل جدید به نام `tags` ایجاد می‌شود. Vim چگونه می‌داند که کجا به دنبال فایل تگ باشد؟

اگر شما `:set tags?` را اجرا کنید، ممکن است `tags=./tags,tags` را ببینید (بسته به تنظیمات Vim شما، ممکن است متفاوت باشد). در اینجا Vim به دنبال تمام تگ‌ها در مسیر فایل فعلی در مورد `./tags` و دایرکتوری فعلی (ریشه پروژه شما) در مورد `tags` می‌گردد.

همچنین در مورد `./tags`، Vim ابتدا به دنبال یک فایل تگ در مسیر فایل فعلی شما می‌گردد، بدون توجه به اینکه چقدر تو در تو است، سپس به دنبال یک فایل تگ در دایرکتوری فعلی (ریشه پروژه) می‌گردد. Vim پس از پیدا کردن اولین تطابق متوقف می‌شود.

اگر فایل `'tags'` شما گفته باشد `tags=./tags,tags,/user/iggy/mytags/tags`، سپس Vim همچنین به دایرکتوری `/user/iggy/mytags` برای یک فایل تگ پس از اتمام جستجوی `./tags` و دایرکتوری `tags` نگاه می‌کند. شما نیازی به ذخیره فایل تگ خود در داخل پروژه ندارید، می‌توانید آن‌ها را جدا نگه دارید.

برای افزودن یک مکان جدید برای فایل تگ، از دستور زیر استفاده کنید:

```shell
set tags+=path/to/my/tags/file
```

## تولید تگ‌ها برای یک پروژه بزرگ

اگر سعی کنید ctags را در یک پروژه بزرگ اجرا کنید، ممکن است زمان زیادی ببرد زیرا Vim همچنین به داخل هر دایرکتوری تو در تو نگاه می‌کند. اگر شما یک توسعه‌دهنده جاوااسکریپت هستید، می‌دانید که `node_modules` می‌تواند بسیار بزرگ باشد. تصور کنید که شما پنج زیرپروژه دارید و هر کدام دایرکتوری `node_modules` خود را دارند. اگر شما `ctags -R .` را اجرا کنید، ctags سعی خواهد کرد از طریق تمام 5 `node_modules` اسکن کند. احتمالاً شما نیازی به اجرای ctags در `node_modules` ندارید.

برای اجرای ctags با استثنای `node_modules`، اجرا کنید:

```shell
ctags -R --exclude=node_modules .
```

این بار باید کمتر از یک ثانیه طول بکشد. به هر حال، می‌توانید از گزینه `exclude` چندین بار استفاده کنید:

```shell
ctags -R --exclude=.git --exclude=vendor --exclude=node_modules --exclude=db --exclude=log .
```

نکته این است که اگر می‌خواهید یک دایرکتوری را حذف کنید، `--exclude` بهترین دوست شماست.

## ناوبری تگ‌ها

شما می‌توانید با استفاده از فقط `Ctrl-]` مسافت خوبی را طی کنید، اما بیایید چند ترفند دیگر یاد بگیریم. کلید پرش تگ `Ctrl-]` یک جایگزین در حالت خط فرمان دارد: `:tag {tag-name}`. اگر شما اجرا کنید:

```shell
:tag donut
```

Vim به متد `donut` پرش خواهد کرد، درست مانند اینکه `Ctrl-]` را روی رشته "donut" فشار دهید. شما همچنین می‌توانید آرگومان را با `<Tab>` تکمیل کنید:

```shell
:tag d<Tab>
```

Vim تمام تگ‌هایی که با "d" شروع می‌شوند را لیست می‌کند. در این مورد، "donut".

در یک پروژه واقعی، ممکن است با چندین متد با نام یکسان مواجه شوید. بیایید دو فایل Ruby قبلی را به‌روزرسانی کنیم. در داخل `one.rb`:

```shell
## one.rb
class One
  def initialize
    puts "Initialized"
  end

  def donut
    puts "one donut"
  end

  def pancake
    puts "one pancake"
  end
end
```

در داخل `two.rb`:

```shell
## two.rb
require './one.rb'

def pancake
  "Two pancakes"
end

one = One.new
one.donut
puts pancake
```

اگر شما در حال کدنویسی هستید، فراموش نکنید که دوباره `ctags -R .` را اجرا کنید زیرا اکنون چند رویه جدید دارید. شما دو نمونه از رویه `pancake` دارید. اگر شما در `two.rb` باشید و `Ctrl-]` را فشار دهید، چه اتفاقی می‌افتد؟

Vim به `def pancake` در داخل `two.rb` پرش خواهد کرد، نه به `def pancake` در داخل `one.rb`. این به این دلیل است که Vim رویه `pancake` در `two.rb` را با اولویت بالاتری نسبت به رویه دیگر `pancake` می‌بیند.

## اولویت تگ

همه تگ‌ها برابر نیستند. برخی از تگ‌ها اولویت بالاتری دارند. اگر Vim با نام‌های تکراری مواجه شود، اولویت کلیدواژه را بررسی می‌کند. ترتیب به این صورت است:

1. یک تگ استاتیک کاملاً مطابقت یافته در فایل فعلی.
2. یک تگ جهانی کاملاً مطابقت یافته در فایل فعلی.
3. یک تگ جهانی کاملاً مطابقت یافته در یک فایل دیگر.
4. یک تگ استاتیک کاملاً مطابقت یافته در یک فایل دیگر.
5. یک تگ استاتیک مطابقت یافته بدون توجه به حروف بزرگ و کوچک در فایل فعلی.
6. یک تگ جهانی مطابقت یافته بدون توجه به حروف بزرگ و کوچک در فایل فعلی.
7. یک تگ جهانی مطابقت یافته بدون توجه به حروف بزرگ و کوچک در یک فایل دیگر.
8. یک تگ استاتیک مطابقت یافته بدون توجه به حروف بزرگ و کوچک در فایل فعلی.

بر اساس لیست اولویت، Vim تطابق دقیق پیدا شده در همان فایل را اولویت می‌دهد. به همین دلیل است که Vim رویه `pancake` در `two.rb` را به رویه `pancake` در `one.rb` ترجیح می‌دهد. برخی استثناها برای لیست اولویت بالا بسته به تنظیمات `'tagcase'`، `'ignorecase'` و `'smartcase'` شما وجود دارد، اما من در اینجا به آن‌ها نمی‌پردازم. اگر علاقه‌مند هستید، به `:h tag-priority` مراجعه کنید.

## پرش‌های انتخابی تگ

خوب است که بتوانید انتخاب کنید به کدام مورد تگ پرش کنید، به جای اینکه همیشه به بالاترین اولویت پرش کنید. شاید شما واقعاً نیاز دارید به متد `pancake` در `one.rb` پرش کنید و نه به آن در `two.rb`. برای این کار، می‌توانید از `:tselect` استفاده کنید. اجرا کنید:

```shell
:tselect pancake
```

شما در پایین صفحه خواهید دید:
## برچسب نوع pri               فایل
1 F C f    پنکیک           two.rb
             def pancake
2 F   f    پنکیک           one.rb
             class:One
             def pancake
```

اگر عدد ۲ را تایپ کنید، Vim به رویه در `one.rb` می‌پرد. اگر عدد ۱ را تایپ کنید، Vim به رویه در `two.rb` می‌پرد.

به ستون `pri` توجه کنید. شما `F C` را در اولین تطابق و `F` را در دومین تطابق دارید. این چیزی است که Vim برای تعیین اولویت برچسب استفاده می‌کند. `F C` به معنای یک برچسب جهانی کاملاً مطابقت یافته (`F`) در فایل جاری (`C`) است. `F` به معنای فقط یک برچسب جهانی کاملاً مطابقت یافته (`F`) است. `F C` همیشه اولویت بالاتری نسبت به `F` دارد.

اگر `:tselect donut` را اجرا کنید، Vim همچنین از شما می‌خواهد که انتخاب کنید به کدام مورد برچسب بپرید، حتی اگر فقط یک گزینه برای انتخاب وجود داشته باشد. آیا راهی وجود دارد که Vim فقط در صورتی که چندین تطابق وجود دارد، لیست برچسب را نمایش دهد و اگر فقط یک برچسب پیدا شد، بلافاصله بپرد؟

البته! Vim یک روش `:tjump` دارد. اجرا کنید:

```shell
:tjump donut
```

Vim بلافاصله به رویه `donut` در `one.rb` می‌پرد، مشابه اجرای `:tag donut`. حالا اجرا کنید:

```shell
:tjump pancake
```

Vim گزینه‌های برچسب را برای انتخاب به شما نمایش می‌دهد، مشابه اجرای `:tselect pancake`. با `tjump` شما بهترین ویژگی‌های هر دو روش را دریافت می‌کنید.

Vim یک کلید حالت عادی برای `tjump` دارد: `g Ctrl-]`. من شخصاً `g Ctrl-]` را بیشتر از `Ctrl-]` دوست دارم.

## تکمیل خودکار با برچسب‌ها

برچسب‌ها می‌توانند به تکمیل‌های خودکار کمک کنند. به یاد داشته باشید از فصل ۶، حالت درج، که می‌توانید از زیرحالت `Ctrl-X` برای انجام تکمیل‌های خودکار مختلف استفاده کنید. یکی از زیرحالت‌های تکمیل خودکار که من ذکر نکردم `Ctrl-]` است. اگر در حالت درج `Ctrl-X Ctrl-]` را انجام دهید، Vim از فایل برچسب برای تکمیل خودکار استفاده می‌کند.

اگر به حالت درج بروید و `Ctrl-x Ctrl-]` را تایپ کنید، خواهید دید:

```shell
One
donut
initialize
pancake
```

## پشته برچسب

Vim فهرستی از تمام برچسب‌هایی که به آن‌ها پریدید و از آن‌ها برگشتید را در یک پشته برچسب نگه می‌دارد. می‌توانید این پشته را با `:tags` مشاهده کنید. اگر ابتدا به `pancake` پرش کرده‌اید، سپس به `donut`، و `:tags` را اجرا کنید، خواهید دید:

```shell
  # به برچسب         از خط  در فایل/متن
  1  1 pancake            10  ch16_tags/two.rb
  2  1 donut               9  ch16_tags/two.rb
>
```

به نماد `>` در بالا توجه کنید. این نشان‌دهنده موقعیت فعلی شما در پشته است. برای "پاپ" کردن پشته و بازگشت به یک پشته قبلی، می‌توانید `:pop` را اجرا کنید. امتحان کنید، سپس دوباره `:tags` را اجرا کنید:

```shell
  # به برچسب         از خط  در فایل/متن
  1  1 pancake            10  puts pancake
> 2  1 donut               9  one.donut

```

توجه داشته باشید که نماد `>` اکنون در خط دوم است، جایی که `donut` قرار دارد. یک بار دیگر `pop` کنید، سپس دوباره `:tags` را اجرا کنید:

```shell
  # به برچسب         از خط  در فایل/متن
> 1  1 pancake            10  puts pancake
  2  1 donut               9  one.donut
```

در حالت عادی، می‌توانید `Ctrl-t` را اجرا کنید تا همان اثر را به عنوان `:pop` به دست آورید.

## تولید خودکار برچسب

یکی از بزرگترین معایب برچسب‌های Vim این است که هر بار که تغییرات قابل توجهی ایجاد می‌کنید، باید فایل برچسب را دوباره تولید کنید. اگر به تازگی رویه `pancake` را به رویه `waffle` تغییر نام داده‌اید، فایل برچسب نمی‌دانست که رویه `pancake` تغییر نام داده است. هنوز `pancake` را در لیست برچسب‌ها ذخیره کرده است. شما باید `ctags -R .` را اجرا کنید تا یک فایل برچسب به‌روز شده ایجاد کنید. بازسازی یک فایل برچسب جدید به این روش می‌تواند خسته‌کننده باشد.

خوشبختانه چندین روش وجود دارد که می‌توانید برای تولید خودکار برچسب‌ها استفاده کنید.

## تولید برچسب در زمان ذخیره

Vim یک روش خودکار (`autocmd`) برای اجرای هر دستوری در زمان وقوع یک رویداد دارد. می‌توانید از این برای تولید برچسب‌ها در هر بار ذخیره استفاده کنید. اجرا کنید:

```shell
:autocmd BufWritePost *.rb silent !ctags -R .
```

تجزیه و تحلیل:
- `autocmd` یک دستور خط فرمان است. این دستور یک رویداد، الگوی فایل و یک دستور را می‌پذیرد.
- `BufWritePost` یک رویداد برای ذخیره یک بافر است. هر بار که یک فایل را ذخیره می‌کنید، یک رویداد `BufWritePost` را فعال می‌کنید.
- `.rb` یک الگوی فایل برای فایل‌های روبی است.
- `silent` در واقع بخشی از دستوری است که شما ارسال می‌کنید. بدون این، Vim هر بار که شما دستور خودکار را فعال می‌کنید، `press ENTER or type command to continue` را نمایش می‌دهد.
- `!ctags -R .` دستوری است که باید اجرا شود. به یاد داشته باشید که `!cmd` از داخل Vim دستور ترمینال را اجرا می‌کند.

حال هر بار که از داخل یک فایل روبی ذخیره می‌کنید، Vim `ctags -R .` را اجرا خواهد کرد.

## استفاده از پلاگین‌ها

چندین پلاگین برای تولید خودکار ctags وجود دارد:

- [vim-gutentags](https://github.com/ludovicchabant/vim-gutentags)
- [vim-tags](https://github.com/szw/vim-tags)
- [vim-easytags](https://github.com/xolox/vim-easytags)
- [vim-autotag](https://github.com/craigemery/vim-autotag)

من از vim-gutentags استفاده می‌کنم. استفاده از آن ساده است و به راحتی کار می‌کند.

## Ctags و هک‌های گیت

تیم پوپ، نویسنده بسیاری از پلاگین‌های عالی Vim، یک وبلاگ نوشت که پیشنهاد می‌کند از هک‌های گیت استفاده کنید. [آن را بررسی کنید](https://tbaggery.com/2011/08/08/effortless-ctags-with-git.html).

## یادگیری برچسب‌ها به روش هوشمند

یک برچسب زمانی مفید است که به درستی پیکربندی شده باشد. فرض کنید با یک کد جدید مواجه هستید و می‌خواهید بفهمید `functionFood` چه کاری انجام می‌دهد، می‌توانید به راحتی با پرش به تعریف آن بخوانید. درون آن، می‌آموزید که همچنین `functionBreakfast` را فراخوانی می‌کند. شما آن را دنبال می‌کنید و می‌آموزید که `functionPancake` را فراخوانی می‌کند. نمودار فراخوانی تابع شما به شکل زیر است:

```shell
functionFood -> functionBreakfast -> functionPancake
```

این به شما بینش می‌دهد که این جریان کد مربوط به داشتن یک پنکیک برای صبحانه است.

برای یادگیری بیشتر در مورد برچسب‌ها، به `:h tags` مراجعه کنید. حالا که می‌دانید چگونه از برچسب‌ها استفاده کنید، بیایید به ویژگی دیگری بپردازیم: تا کردن.