---
description: تعلم كيفية استخدام الماكروز في فيم لأتمتة المهام المتكررة، مما يسهل تحرير
  الملفات ويجعل العملية أكثر كفاءة.
title: Ch09. Macros
---

عند تحرير الملفات، قد تجد نفسك تكرر نفس الإجراءات. ألن يكون من الجيد إذا كان بإمكانك القيام بتلك الإجراءات مرة واحدة وإعادة تشغيلها كلما احتجت إليها؟ مع ماكرو Vim، يمكنك تسجيل الإجراءات وتخزينها داخل سجلات Vim ليتم تنفيذها كلما احتجت إليها.

في هذا الفصل، ستتعلم كيفية استخدام الماكرو لأتمتة المهام المملة (بالإضافة إلى أنه يبدو رائعًا أن ترى ملفك يعدل نفسه).

## الماكرو الأساسية

إليك الصيغة الأساسية لماكرو Vim:

```shell
qa                     ابدأ تسجيل ماكرو في السجل a
q (أثناء التسجيل)      أوقف تسجيل الماكرو
```

يمكنك اختيار أي حرف صغير (a-z) لتخزين الماكرو. إليك كيفية تنفيذ ماكرو:

```shell
@a    نفذ الماكرو من السجل a
@@    نفذ آخر ماكرو تم تنفيذه
```

افترض أن لديك هذا النص وتريد تحويل كل شيء إلى أحرف كبيرة في كل سطر:

```shell
hello
vim
macros
are
awesome
```

مع وجود المؤشر في بداية السطر "hello"، قم بتشغيل:

```shell
qa0gU$jq
```

التفصيل:
- `qa` يبدأ تسجيل ماكرو في السجل a.
- `0` يذهب إلى بداية السطر.
- `gU$` يحول النص من موقعك الحالي إلى نهاية السطر إلى أحرف كبيرة.
- `j` ينزل سطرًا واحدًا.
- `q` يوقف التسجيل.

لإعادة تشغيله، قم بتشغيل `@a`. تمامًا مثل العديد من أوامر Vim الأخرى، يمكنك تمرير حجة عددية إلى الماكرو. على سبيل المثال، تشغيل `3@a` ينفذ الماكرو ثلاث مرات.

## حماية الأمان

ينتهي تنفيذ الماكرو تلقائيًا عندما يصادف خطأ. افترض أن لديك هذا النص:

```shell
a. chocolate donut
b. mochi donut
c. powdered sugar donut
d. plain donut
```

إذا كنت تريد تحويل الكلمة الأولى في كل سطر إلى أحرف كبيرة، يجب أن يعمل هذا الماكرو:

```shell
qa0W~jq
```

إليك تفصيل الأمر أعلاه:
- `qa` يبدأ تسجيل ماكرو في السجل a.
- `0` يذهب إلى بداية السطر.
- `W` يذهب إلى الكلمة التالية.
- `~` يبدل حالة الحرف تحت المؤشر.
- `j` ينزل سطرًا واحدًا.
- `q` يوقف التسجيل.

أفضل أن أفرط في عد تنفيذ الماكرو بدلاً من أن أعده بشكل ناقص، لذا عادةً ما أستدعيه تسعًا وتسعين مرة (`99@a`). مع هذا الأمر، لا يقوم Vim فعليًا بتشغيل هذا الماكرو تسعًا وتسعين مرة. عندما يصل Vim إلى السطر الأخير ويشغل حركة `j`، يجد أنه لا يوجد سطر آخر للنزول إليه، فيرمي خطأ ويتوقف عن تنفيذ الماكرو.

إن حقيقة أن تنفيذ الماكرو يتوقف عند أول خطأ هو ميزة جيدة، وإلا فإن Vim سيستمر في تنفيذ هذا الماكرو تسعًا وتسعين مرة على الرغم من أنه قد وصل بالفعل إلى نهاية السطر.

## ماكرو سطر الأوامر

تشغيل `@a` في وضع العادي ليس الطريقة الوحيدة التي يمكنك بها تنفيذ الماكرو في Vim. يمكنك أيضًا تشغيل الأمر `:normal @a`. يسمح `:normal` للمستخدم بتنفيذ أي أمر في وضع العادي يتم تمريره كحجة. في الحالة السابقة، يكون الأمر نفسه كما لو كنت تقوم بتشغيل `@a` من وضع العادي.

يقبل أمر `:normal` النطاق كحجج. يمكنك استخدام ذلك لتشغيل الماكرو في نطاقات محددة. إذا كنت تريد تنفيذ الماكرو الخاص بك بين السطرين 2 و3، يمكنك تشغيل `:2,3 normal @a`.

## تنفيذ ماكرو عبر ملفات متعددة

افترض أن لديك عدة ملفات `.txt`، يحتوي كل منها على بعض النصوص. مهمتك هي تحويل الكلمة الأولى فقط في الأسطر التي تحتوي على كلمة "donut" إلى أحرف كبيرة. افترض أن لديك `0W~j` في السجل a (نفس الماكرو كما في السابق). كيف يمكنك إنجاز ذلك بسرعة؟

الملف الأول:

```shell
## savory.txt
a. cheddar jalapeno donut
b. mac n cheese donut
c. fried dumpling
```

الملف الثاني:

```shell
## sweet.txt
a. chocolate donut
b. chocolate pancake
c. powdered sugar donut
```

الملف الثالث:

```shell
## plain.txt
a. wheat bread
b. plain donut
```

إليك كيفية القيام بذلك:
- `:args *.txt` للعثور على جميع ملفات `.txt` في الدليل الحالي.
- `:argdo g/donut/normal @a` ينفذ الأمر العالمي `g/donut/normal @a` على كل ملف داخل `:args`.
- `:argdo update` ينفذ أمر `update` لحفظ كل ملف داخل `:args` عندما يتم تعديل المخزن المؤقت.

إذا لم تكن معتادًا على الأمر العالمي `:g/donut/normal @a`، فإنه ينفذ الأمر الذي تعطيه (`normal @a`) على الأسطر التي تطابق النمط (`/donut/`). سأستعرض الأمر العالمي في فصل لاحق.

## ماكرو تكراري

يمكنك تنفيذ ماكرو بشكل تكراري عن طريق استدعاء نفس سجل الماكرو أثناء تسجيل ذلك الماكرو. افترض أن لديك هذه القائمة مرة أخرى وتحتاج إلى تبديل حالة الكلمة الأولى:

```shell
a. chocolate donut
b. mochi donut
c. powdered sugar donut
d. plain donut
```

هذه المرة، دعنا نفعل ذلك بشكل تكراري. قم بتشغيل:

```shell
qaqqa0W~j@aq
```

إليك تفصيل الخطوات:
- `qaq` يسجل ماكرو فارغ a. من الضروري البدء بسجل فارغ لأنه عند استدعاء الماكرو بشكل تكراري، سيقوم بتشغيل أي شيء في ذلك السجل.
- `qa` يبدأ التسجيل في السجل a.
- `0` يذهب إلى أول حرف في السطر الحالي.
- `W` يذهب إلى الكلمة التالية.
- `~` يبدل حالة الحرف تحت المؤشر.
- `j` ينزل سطرًا واحدًا.
- `@a` ينفذ الماكرو a.
- `q` يوقف التسجيل.

الآن يمكنك فقط تشغيل `@a` ومشاهدة Vim ينفذ الماكرو بشكل تكراري.

كيف عرف الماكرو متى يتوقف؟ عندما كان الماكرو على السطر الأخير، حاول تشغيل `j`، وبما أنه لم يكن هناك المزيد من الأسطر للنزول إليها، توقف تنفيذ الماكرو.

## إضافة ماكرو

إذا كنت بحاجة إلى إضافة إجراءات إلى ماكرو موجود، بدلاً من إعادة إنشاء الماكرو من الصفر، يمكنك إضافة إجراءات إلى واحد موجود. في فصل السجلات، تعلمت أنه يمكنك إضافة سجل مسمى باستخدام رمزه الكبير. القاعدة نفسها تنطبق. لإضافة إجراءات إلى سجل ماكرو، استخدم السجل A.

سجل ماكرو في السجل a: `qa0W~q` (تقوم هذه السلسلة بتبديل حالة الكلمة التالية في السطر). إذا كنت تريد إضافة سلسلة جديدة أيضًا لإضافة نقطة في نهاية السطر، قم بتشغيل:

```shell
qAA.<Esc>q
```

التفصيل:
- `qA` يبدأ تسجيل الماكرو في السجل A.
- `A.<Esc>` يدرج في نهاية السطر (هنا `A` هو أمر وضع الإدراج، لا تخلط بينه وبين الماكرو A) نقطة، ثم يخرج من وضع الإدراج.
- `q` يوقف تسجيل الماكرو.

الآن عند تنفيذ `@a`، فإنه لا يقوم فقط بتبديل حالة الكلمة التالية، بل يضيف أيضًا نقطة في نهاية السطر.

## تعديل ماكرو

ماذا لو كنت بحاجة إلى إضافة إجراءات جديدة في منتصف ماكرو؟

افترض أن لديك ماكرو يقوم بتبديل الكلمة الفعلية الأولى وإضافة نقطة في نهاية السطر، `0W~A.<Esc>` في السجل a. افترض أنه بين تحويل الكلمة الأولى إلى أحرف كبيرة وإضافة نقطة في نهاية السطر، تحتاج إلى إضافة كلمة "deep fried" مباشرة قبل كلمة "donut" *(لأن الشيء الوحيد الأفضل من الدونات العادية هو الدونات المقلية)*.

سأعيد استخدام النص من القسم السابق:
```shell
a. chocolate donut
b. mochi donut
c. powdered sugar donut
d. plain donut
```

أولاً، دعنا نستدعي الماكرو الموجود (افترض أنك احتفظت بالماكرو من القسم السابق في السجل a) باستخدام `:put a`:

```shell
0W~A.^[
```

ما هو هذا `^[`؟ أليس قد قمت بـ `0W~A.<Esc>`؟ أين هو `<Esc>`؟ `^[` هو تمثيل *الرمز الداخلي* لـ Vim لـ `<Esc>`. مع بعض المفاتيح الخاصة، يطبع Vim تمثيل تلك المفاتيح في شكل رموز داخلية. بعض المفاتيح الشائعة التي لها تمثيلات رموز داخلية هي `<Esc>` و `<Backspace>` و `<Enter>`. هناك المزيد من المفاتيح الخاصة، لكنها ليست ضمن نطاق هذا الفصل.

عد إلى الماكرو، مباشرة بعد عامل تبديل الحالة (`~`)، دعنا نضيف التعليمات للذهاب إلى نهاية السطر (`$`)، والعودة إلى كلمة واحدة (`b`)، والذهاب إلى وضع الإدراج (`i`)، وكتابة "deep fried " (لا تنسَ المسافة بعد "fried ")، والخروج من وضع الإدراج (`<Esc>`).

إليك ما ستنتهي به:

```shell
0W~$bideep fried <Esc>A.^[
```

هناك مشكلة صغيرة. لا يفهم Vim `<Esc>`. لا يمكنك كتابة `<Esc>` حرفيًا. سيتعين عليك كتابة التمثيل الرمزي الداخلي لمفتاح `<Esc>`. أثناء وضع الإدراج، اضغط على `Ctrl-V` متبوعًا بـ `<Esc>`. سيطبع Vim `^[`. `Ctrl-V` هو عامل وضع الإدراج لإدراج الحرف غير الرقمي التالي *حرفيًا*. يجب أن يبدو كود الماكرو الخاص بك الآن كما يلي:

```shell
0W~$bideep fried ^[A.^[
```

لإضافة التعليمات المعدلة إلى السجل a، يمكنك القيام بذلك بنفس الطريقة التي تضيف بها إدخالًا جديدًا إلى سجل مسمى. في بداية السطر، قم بتشغيل `"ay$` لتخزين النص المنسوخ في السجل a.

الآن عند تنفيذ `@a`، سيقوم الماكرو بتبديل حالة الكلمة الأولى، وإضافة "deep fried " قبل "donut"، وإضافة "." في نهاية السطر. لذيذ!

طريقة بديلة لتعديل ماكرو هي استخدام تعبير سطر الأوامر. قم بتشغيل `:let @a="`، ثم اضغط `Ctrl-R a`، سيقوم هذا بلصق محتوى السجل a حرفيًا. وأخيرًا، لا تنسَ إغلاق علامات الاقتباس المزدوجة (`"`). قد يكون لديك شيء مثل `:let @a="0W~$bideep fried ^[A.^["`.

## تكرار الماكرو

يمكنك بسهولة تكرار الماكرو من سجل إلى آخر. على سبيل المثال، لتكرار ماكرو في السجل a إلى السجل z، يمكنك القيام بـ `:let @z = @a`. يمثل `@a` محتوى السجل a. الآن إذا قمت بتشغيل `@z`، فإنه يقوم بنفس الإجراءات تمامًا كما يفعل `@a`.

أجد أن إنشاء تكرار مفيد في أكثر الماكرو التي أستخدمها بشكل متكرر. في سير العمل الخاص بي، عادةً ما أسجل الماكرو في أول سبعة أحرف أبجدية (a-g) وغالبًا ما أستبدلها دون الكثير من التفكير. إذا قمت بنقل الماكرو المفيد نحو نهاية الأبجدية، يمكنني الحفاظ عليها دون القلق من أنني قد أستبدلها عن غير قصد.

## الماكرو المتسلسل مقابل الماكرو المتوازي

يمكن لـ Vim تنفيذ الماكرو بشكل متسلسل ومتوازي. افترض أن لديك هذا النص:

```shell
import { FUNC1 } from "library1";
import { FUNC2 } from "library2";
import { FUNC3 } from "library3";
import { FUNC4 } from "library4";
import { FUNC5 } from "library5";
```

إذا كنت تريد تسجيل ماكرو لتحويل جميع "FUNC" إلى أحرف صغيرة، يجب أن يعمل هذا الماكرو:

```shell
qa0f{gui{jq
```

التفصيل:
- `qa` يبدأ التسجيل في السجل a.
- `0` يذهب إلى السطر الأول.
- `f{` يجد أول حالة من "{".
- `gui{` يحول إلى أحرف صغيرة (`gu`) النص داخل كائن النص بين الأقواس (`i{`).
- `j` ينزل سطرًا واحدًا.
- `q` يوقف تسجيل الماكرو.

الآن يمكنك تشغيل `99@a` لتنفيذه على الأسطر المتبقية. ومع ذلك، ماذا لو كان لديك هذا التعبير الاستيرادي داخل ملفك؟

```shell
import { FUNC1 } from "library1";
import { FUNC2 } from "library2";
import { FUNC3 } from "library3";
import foo from "bar";
import { FUNC4 } from "library4";
import { FUNC5 } from "library5";
```

تشغيل `99@a`، ينفذ الماكرو ثلاث مرات فقط. لا ينفذ الماكرو على السطرين الأخيرين لأن التنفيذ يفشل في تشغيل `f{` على سطر "foo". هذا متوقع عند تشغيل الماكرو بشكل متسلسل. يمكنك دائمًا الانتقال إلى السطر التالي حيث "FUNC4" وتشغيل ذلك الماكرو مرة أخرى. لكن ماذا لو كنت تريد إنجاز كل شيء دفعة واحدة؟

قم بتشغيل الماكرو بشكل متوازي.

تذكر من القسم السابق أن الماكرو يمكن تنفيذه باستخدام أمر سطر الأوامر `:normal` (على سبيل المثال: `:3,5 normal @a` ينفذ الماكرو a على الأسطر 3-5). إذا قمت بتشغيل `:1,$ normal @a`، سترى أن الماكرو يتم تنفيذه على جميع الأسطر باستثناء سطر "foo". إنه يعمل!

على الرغم من أن Vim داخليًا لا يقوم فعليًا بتشغيل الماكرو بشكل متوازي، إلا أنه يتصرف كأنه كذلك. يقوم Vim بتنفيذ `@a` *بشكل مستقل* على كل سطر من الأول إلى الأخير (`1,$`). نظرًا لأن Vim ينفذ هذه الماكرو بشكل مستقل، فإن كل سطر لا يعرف أن أحد تنفيذات الماكرو قد فشل على سطر "foo".
## تعلم الماكرو بطريقة ذكية

العديد من الأشياء التي تقوم بها أثناء التحرير متكررة. لتحسين مهاراتك في التحرير، اعتد على اكتشاف الأفعال المتكررة. استخدم الماكرو (أو أمر النقطة) حتى لا تضطر إلى تنفيذ نفس الإجراء مرتين. يمكن تكرار كل شيء تقريبًا يمكنك القيام به في Vim باستخدام الماكرو.

في البداية، أجد أنه من المحرج جدًا كتابة الماكرو، لكن لا تستسلم. مع الممارسة الكافية، ستعتاد على أتمتة كل شيء.

قد تجد أنه من المفيد استخدام المساعدات التذكارية لمساعدتك في تذكر الماكرو الخاص بك. إذا كان لديك ماكرو ينشئ دالة، استخدم "سجل f (`qf`). إذا كان لديك ماكرو لعمليات عددية، يجب أن يعمل "سجل n (`qn`). سمّه بأول سجل مسمى يتبادر إلى ذهنك عندما تفكر في تلك العملية. أجد أيضًا أن "سجل q يعد سجل ماكرو افتراضي جيد لأنه يتطلب طاقة عقلية أقل للتفكير فيه. أخيرًا، أحب أيضًا زيادة ماكرو الخاص بي بترتيب أبجدي، مثل `qa`، ثم `qb`، ثم `qc`، وهكذا.

ابحث عن طريقة تناسبك بشكل أفضل.