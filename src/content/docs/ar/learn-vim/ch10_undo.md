---
description: يتناول هذا الفصل نظام التراجع في فيم، ويشرح كيفية التراجع، وإعادة التراجع،
  والتنقل بين حالات النص المختلفة.
title: Ch10. Undo
---

نحن جميعًا نرتكب جميع أنواع أخطاء الكتابة. لهذا السبب، يعتبر التراجع ميزة أساسية في أي برنامج حديث. نظام التراجع في فيم ليس فقط قادرًا على التراجع وإعادة التراجع عن الأخطاء البسيطة، ولكن أيضًا الوصول إلى حالات نصية مختلفة، مما يمنحك السيطرة على جميع النصوص التي كتبتها من قبل. في هذا الفصل، ستتعلم كيفية التراجع، وإعادة التراجع، والتنقل في فرع التراجع، والحفاظ على التراجع، والسفر عبر الزمن.

## التراجع، إعادة التراجع، وUNDU

لإجراء تراجع أساسي، يمكنك استخدام `u` أو تشغيل `:undo`.

إذا كان لديك هذا النص (لاحظ السطر الفارغ أسفل "one"):

```shell
one

```

ثم تضيف نصًا آخر:

```shell
one
two
```

إذا ضغطت `u`، فإن فيم يتراجع عن النص "two".

كيف يعرف فيم مقدار ما يجب التراجع عنه؟ يقوم فيم بالتراجع عن "تغيير" واحد في كل مرة، مشابهًا لتغيير أمر النقطة (على عكس أمر النقطة، فإن الأوامر في سطر الأوامر تُحسب أيضًا كتغيير).

لإعادة التراجع عن آخر تغيير، اضغط `Ctrl-R` أو قم بتشغيل `:redo`. بعد أن تتراجع عن النص أعلاه لإزالة "two"، فإن تشغيل `Ctrl-R` سيعيد النص المحذوف.

يمتلك فيم أيضًا UNDO يمكنك تشغيله باستخدام `U`. يقوم بإلغاء جميع التغييرات الأخيرة.

كيف يختلف `U` عن `u`؟ أولاً، يقوم `U` بإزالة *جميع* التغييرات على السطر الذي تم تغييره مؤخرًا، بينما `u` يزيل تغييرًا واحدًا في كل مرة. ثانيًا، في حين أن القيام بـ `u` لا يُحسب كتغيير، فإن القيام بـ `U` يُحسب كتغيير.

عد إلى هذا المثال:

```shell
one
two
```

قم بتغيير السطر الثاني إلى "three":

```shell
one
three
```

قم بتغيير السطر الثاني مرة أخرى واستبدله بـ "four":

```shell
one
four
```

إذا ضغطت `u`، سترى "three". إذا ضغطت `u` مرة أخرى، سترى "two". إذا بدلاً من الضغط على `u` عندما كان لديك النص "four"، كنت قد ضغطت `U`، سترى:

```shell
one

```

يتجاوز `U` جميع التغييرات الوسيطة ويعود إلى الحالة الأصلية عندما بدأت (سطر فارغ). بالإضافة إلى ذلك، نظرًا لأن UNDO في الواقع ينشئ تغييرًا جديدًا في فيم، يمكنك التراجع عن تراجعك. `U` متبوعًا بـ `U` سيقوم بإلغاء نفسه. يمكنك الضغط على `U`، ثم `U`، ثم `U`، إلخ. سترى نفس حالتي النص تتبدلان ذهابًا وإيابًا.

شخصيًا، لا أستخدم `U` لأنه من الصعب تذكر الحالة الأصلية (نادراً ما أحتاجها).

يحدد فيم عددًا أقصى لعدد المرات التي يمكنك فيها التراجع في متغير خيار `undolevels`. يمكنك التحقق منه باستخدام `:echo &undolevels`. لقد قمت بتعيينها على 1000. لتغيير إعدادك إلى 1000، قم بتشغيل `:set undolevels=1000`. لا تتردد في تعيينها إلى أي رقم تريده.

## كسر الكتل

ذكرت سابقًا أن `u` يتراجع عن "تغيير" واحد مشابه لتغيير أمر النقطة: النصوص المدخلة من لحظة دخولك وضع الإدخال حتى تخرج منه تُحسب كتغيير.

إذا قمت بكتابة `ione two three<Esc>` ثم ضغطت `u`، فإن فيم يزيل النص بالكامل "one two three" لأن الكل يُحسب كتغيير. هذه ليست مشكلة كبيرة إذا كنت قد كتبت نصوصًا قصيرة، ولكن ماذا لو كنت قد كتبت عدة فقرات في جلسة واحدة من وضع الإدخال دون الخروج ولاحقًا أدركت أنك ارتكبت خطأ؟ إذا ضغطت `u`، سيتم إزالة كل ما كتبته. ألن يكون من المفيد إذا كنت تستطيع الضغط على `u` لإزالة جزء فقط من نصك؟

لحسن الحظ، يمكنك كسر كتل التراجع. عندما تكون في وضع الإدخال، فإن الضغط على `Ctrl-G u` ينشئ نقطة توقف للتراجع. على سبيل المثال، إذا قمت بكتابة `ione <Ctrl-G u>two <Ctrl-G u>three<Esc>`، ثم ضغطت `u`، ستفقد فقط النص "three" (اضغط `u` مرة أخرى لإزالة "two"). عندما تكتب نصًا طويلًا، استخدم `Ctrl-G u` بشكل استراتيجي. نهاية كل جملة، بين فقرتين، أو بعد كل سطر من الشيفرة هي مواقع رئيسية لإضافة نقاط توقف للتراجع لتسهيل التراجع عن أخطائك إذا ارتكبت واحدة.

من المفيد أيضًا إنشاء نقطة توقف للتراجع عند حذف أجزاء في وضع الإدخال باستخدام `Ctrl-W` (حذف الكلمة قبل المؤشر) و `Ctrl-U` (حذف كل النص قبل المؤشر). اقترح صديق استخدام الخرائط التالية:

```shell
inoremap <c-u> <c-g>u<c-u>
inoremap <c-w> <c-g>u<c-w>
```

مع هذه، يمكنك بسهولة استعادة النصوص المحذوفة.

## شجرة التراجع

يخزن فيم كل تغيير تم كتابته في شجرة التراجع. ابدأ ملفًا فارغًا جديدًا. ثم أضف نصًا جديدًا:

```shell
one

```

أضف نصًا جديدًا:

```shell
one
two
```

تراجع مرة واحدة:

```shell
one

```

أضف نصًا مختلفًا:

```shell
one
three
```

تراجع مرة أخرى:

```shell
one

```

وأضف نصًا مختلفًا آخر:

```shell
one
four
```

الآن إذا تراجعت، ستفقد النص "four" الذي أضفته للتو:

```shell
one

```

إذا تراجعت مرة أخرى:

```shell

```

ستفقد النص "one". في معظم محررات النصوص، سيكون من المستحيل استعادة النصوص "two" و "three"، لكن ليس مع فيم! اضغط `g+` وستستعيد نصك "one":

```shell
one

```

اكتب `g+` مرة أخرى وسترى صديقًا قديمًا:

```shell
one
two
```

لنستمر. اضغط `g+` مرة أخرى:

```shell
one
three
```

اضغط `g+` مرة أخرى:

```shell
one
four
```

في فيم، في كل مرة تضغط فيها `u` ثم تقوم بعمل تغيير مختلف، يقوم فيم بتخزين نص الحالة السابقة عن طريق إنشاء "فرع تراجع". في هذا المثال، بعد أن كتبت "two"، ثم ضغطت `u`، ثم كتبت "three"، أنشأت فرع ورقة يخزن الحالة التي تحتوي على النص "two". في تلك اللحظة، كانت شجرة التراجع تحتوي على الأقل على ورقتين: العقدة الرئيسية التي تحتوي على النص "three" (الأحدث) وعقدة فرع التراجع التي تحتوي على النص "two". إذا كنت قد قمت بتراجع آخر وكتبت النص "four"، سيكون لديك ثلاث عقد: عقدة رئيسية تحتوي على النص "four" وعقدتان تحتويان على النصين "three" و "two".

للتنقل بين كل عقد شجرة التراجع، يمكنك استخدام `g+` للذهاب إلى حالة أحدث و `g-` للذهاب إلى حالة أقدم. الفرق بين `u` و `Ctrl-R` و `g+` و `g-` هو أن كل من `u` و `Ctrl-R` يتنقلان فقط عبر *العقد الرئيسية* في شجرة التراجع بينما يتنقل `g+` و `g-` عبر *جميع* العقد في شجرة التراجع.

شجرة التراجع ليست سهلة التصور. أجد أن إضافة [vim-mundo](https://github.com/simnalamburt/vim-mundo) مفيدة جدًا للمساعدة في تصور شجرة التراجع في فيم. امنحها بعض الوقت لتجربتها.

## التراجع الدائم

إذا بدأت فيم، وفتحت ملفًا، وضغطت مباشرةً على `u`، فمن المحتمل أن يعرض فيم تحذير "*Already at oldest change*". لا يوجد شيء للتراجع عنه لأنك لم تقم بإجراء أي تغييرات.

لتمرير تاريخ التراجع من جلسة التحرير الأخيرة، يمكن لفيم الحفاظ على تاريخ التراجع الخاص بك مع ملف تراجع باستخدام `:wundo`.

أنشئ ملفًا باسم `mynumbers.txt`. اكتب:

```shell
one
```

ثم اكتب سطرًا آخر (تأكد من أن كل سطر يُحسب كتغيير):

```shell
one
two
```

اكتب سطرًا آخر:

```shell
one
two
three
```

الآن أنشئ ملف التراجع الخاص بك باستخدام `:wundo {my-undo-file}`. إذا كنت بحاجة إلى الكتابة فوق ملف تراجع موجود، يمكنك إضافة `!` بعد `wundo`.

```shell
:wundo! mynumbers.undo
```

ثم اخرج من فيم.

الآن يجب أن يكون لديك ملفي `mynumbers.txt` و `mynumbers.undo` في دليلك. افتح `mynumbers.txt` مرة أخرى وحاول الضغط على `u`. لا يمكنك. لم تقم بإجراء أي تغييرات منذ أن فتحت الملف. الآن قم بتحميل تاريخ التراجع الخاص بك عن طريق قراءة ملف التراجع باستخدام `:rundo`:

```shell
:rundo mynumbers.undo
```

الآن إذا ضغطت `u`، سيقوم فيم بإزالة "three". اضغط `u` مرة أخرى لإزالة "two". إنه كما لو أنك لم تغلق فيم أبدًا!

إذا كنت تريد الحفاظ على التراجع تلقائيًا، فإن إحدى الطرق للقيام بذلك هي إضافة ما يلي في vimrc:

```shell
set undodir=~/.vim/undo_dir
set undofile
```

ستضع الإعدادات أعلاه جميع ملفات التراجع في دليل مركزي واحد، وهو دليل `~/.vim`. اسم `undo_dir` هو اسم عشوائي. `set undofile` يخبر فيم بتفعيل ميزة `undofile` لأنها معطلة بشكل افتراضي. الآن كلما قمت بالحفظ، يقوم فيم تلقائيًا بإنشاء وتحديث الملف ذي الصلة داخل دليل `undo_dir` (تأكد من إنشاء الدليل الفعلي `undo_dir` داخل دليل `~/.vim` قبل تشغيل هذا).

## السفر عبر الزمن

من يقول إن السفر عبر الزمن غير موجود؟ يمكن لفيم السفر إلى حالة نصية في الماضي باستخدام أمر سطر الأوامر `:earlier`.

إذا كان لديك هذا النص:

```shell
one

```
ثم لاحقًا تضيف:

```shell
one
two
```

إذا كنت قد كتبت "two" قبل أقل من عشر ثوانٍ، يمكنك العودة إلى الحالة التي لم يكن فيها "two" موجودًا قبل عشر ثوانٍ باستخدام:

```shell
:earlier 10s
```

يمكنك استخدام `:undolist` لرؤية متى تم إجراء آخر تغيير. كما أن `:earlier` يقبل أيضًا معلمات مختلفة:

```shell
:earlier 10s    اذهب إلى الحالة قبل 10 ثوانٍ
:earlier 10m    اذهب إلى الحالة قبل 10 دقائق
:earlier 10h    اذهب إلى الحالة قبل 10 ساعات
:earlier 10d    اذهب إلى الحالة قبل 10 أيام
```

بالإضافة إلى ذلك، فإنه يقبل أيضًا عددًا عاديًا كمعامل ليخبر فيم بالذهاب إلى الحالة الأقدم `count` مرات. على سبيل المثال، إذا قمت بـ `:earlier 2`، سيعود فيم إلى حالة نصية أقدم قبل تغييرين. إنه نفس الشيء مثل القيام بـ `g-` مرتين. يمكنك أيضًا إخبارها بالذهاب إلى الحالة النصية الأقدم قبل 10 حفظات باستخدام `:earlier 10f`.

تعمل نفس مجموعة المعلمات مع نظير `:earlier`: `:later`.

```shell
:later 10s    اذهب إلى الحالة بعد 10 ثوانٍ
:later 10m    اذهب إلى الحالة بعد 10 دقائق
:later 10h    اذهب إلى الحالة بعد 10 ساعات
:later 10d    اذهب إلى الحالة بعد 10 أيام
:later 10     اذهب إلى الحالة الأحدث 10 مرات
:later 10f    اذهب إلى الحالة بعد 10 حفظات
```

## تعلم التراجع بالطريقة الذكية

`u` و `Ctrl-R` هما أمران لا غنى عنهما في فيم لتصحيح الأخطاء. تعلمهما أولاً. بعد ذلك، تعلم كيفية استخدام `:earlier` و `:later` باستخدام معلمات الوقت أولاً. بعد ذلك، خذ وقتك لفهم شجرة التراجع. ساعدني إضافة [vim-mundo](https://github.com/simnalamburt/vim-mundo) كثيرًا. اكتب النصوص في هذا الفصل وتحقق من شجرة التراجع أثناء إجراء كل تغيير. بمجرد أن تفهمها، لن ترى نظام التراجع بنفس الطريقة مرة أخرى.

قبل هذا الفصل، تعلمت كيفية العثور على أي نص في مساحة مشروع، مع التراجع، يمكنك الآن العثور على أي نص في بعد زمني. أنت الآن قادر على البحث عن أي نص من خلال موقعه والوقت الذي كُتب فيه. لقد حققت وجودًا شاملًا في فيم.