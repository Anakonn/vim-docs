---
description: В этом руководстве вы узнаете, как использовать глобальную команду в
  Vim для выполнения команд на нескольких строках одновременно.
title: Ch13. the Global Command
---

Пока вы научились повторять последнее изменение с помощью команды точки (`.`), воспроизводить действия с помощью макросов (`q`) и сохранять тексты в регистрах (`"`).

В этой главе вы узнаете, как повторить команду командной строки с помощью глобальной команды.

## Обзор глобальной команды

Глобальная команда Vim используется для выполнения команды командной строки на нескольких строках одновременно.

Кстати, вы, возможно, слышали термин "Ex Commands" ранее. В этом руководстве я называю их командами командной строки. Команды Ex и команды командной строки — это одно и то же. Это команды, которые начинаются с двоеточия (`:`). Команда замены в последней главе была примером команды Ex. Их называют Ex, потому что они изначально произошли от текстового редактора Ex. Я продолжу называть их командами командной строки в этом руководстве. Для полного списка команд Ex, посмотрите `:h ex-cmd-index`.

Глобальная команда имеет следующий синтаксис:

```shell
:g/pattern/command
```

`pattern` соответствует всем строкам, содержащим этот шаблон, аналогично шаблону в команде замены. `command` может быть любой командой командной строки. Глобальная команда работает, выполняя `command` для каждой строки, которая соответствует `pattern`.

Если у вас есть следующие выражения:

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

Чтобы удалить все строки, содержащие "console", вы можете выполнить:

```shell
:g/console/d
```

Результат:

```shell
const one = 1;

const two = 2;

const three = 3;
```

Глобальная команда выполняет команду удаления (`d`) на всех строках, которые соответствуют шаблону "console".

При выполнении команды `g` Vim делает два сканирования файла. При первом запуске он сканирует каждую строку и помечает строку, которая соответствует шаблону `/console/`. Как только все соответствующие строки помечены, он выполняет второй проход и выполняет команду `d` на помеченных строках.

Если вы хотите удалить все строки, содержащие "const", вместо этого выполните:

```shell
:g/const/d
```

Результат:

```shell
console.log("one: ", one);

console.log("two: ", two);

console.log("three: ", three);
```

## Обратное соответствие

Чтобы выполнить глобальную команду на несовпадающих строках, вы можете выполнить:

```shell
:g!/pattern/command
```

или

```shell
:v/pattern/command
```

Если вы выполните `:v/console/d`, это удалит все строки, *не* содержащие "console".

## Шаблон

Глобальная команда использует ту же систему шаблонов, что и команда замены, поэтому этот раздел будет служить как освежение. Не стесняйтесь пропустить к следующему разделу или читать дальше!

Если у вас есть эти выражения:

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

Чтобы удалить строки, содержащие либо "one", либо "two", выполните:

```shell
:g/one\|two/d
```

Чтобы удалить строки, содержащие любые одиночные цифры, выполните либо:

```shell
:g/[0-9]/d
```

или

```shell
:g/\d/d
```

Если у вас есть выражение:

```shell
const oneMillion = 1000000;
const oneThousand = 1000;
const one = 1;
```

Чтобы соответствовать строкам, содержащим от трех до шести нулей, выполните:

```shell
:g/0\{3,6\}/d
```

## Передача диапазона

Вы можете передать диапазон перед командой `g`. Вот несколько способов, как это сделать:
- `:1,5g/console/d` соответствует строке "console" между строками 1 и 5 и удаляет их.
- `:,5g/console/d` если перед запятой нет адреса, то он начинается с текущей строки. Он ищет строку "console" между текущей строкой и строкой 5 и удаляет их.
- `:3,g/console/d` если после запятой нет адреса, то он заканчивается на текущей строке. Он ищет строку "console" между строкой 3 и текущей строкой и удаляет их.
- `:3g/console/d` если вы передаете только один адрес без запятой, он выполняет команду только на строке 3. Он смотрит на строку 3 и удаляет ее, если она содержит строку "console".

В дополнение к числам, вы также можете использовать эти символы как диапазон:
- `.` означает текущую строку. Диапазон `.,3` означает между текущей строкой и строкой 3.
- `$` означает последнюю строку в файле. Диапазон `3,$` означает между строкой 3 и последней строкой.
- `+n` означает n строк после текущей строки. Вы можете использовать его с `.` или без. `3,+1` или `3,.+1` означает между строкой 3 и строкой после текущей строки.

Если вы не укажете никакой диапазон, по умолчанию он влияет на весь файл. Это на самом деле не является нормой. Большинство команд командной строки Vim выполняются только на текущей строке, если вы не передаете им никакой диапазон. Два заметных исключения — это глобальная (`:g`) и команда сохранения (`:w`).

## Нормальная команда

Вы можете выполнить нормальную команду с помощью глобальной команды с помощью команды командной строки `:normal`.

Если у вас есть этот текст:
```shell
const one = 1
console.log("one: ", one)

const two = 2
console.log("two: ", two)

const three = 3
console.log("three: ", three)
```

Чтобы добавить ";" в конец каждой строки, выполните:

```shell
:g/./normal A;
```

Давайте разберем это:
- `:g` — это глобальная команда.
- `/./` — это шаблон для "непустых строк". Он соответствует строкам с как минимум одним символом, поэтому он соответствует строкам с "const" и "console", и не соответствует пустым строкам.
- `normal A;` выполняет команду командной строки `:normal`. `A;` — это команда нормального режима для вставки ";" в конец строки.

## Выполнение макроса

Вы также можете выполнить макрос с помощью глобальной команды. Макрос может быть выполнен с помощью команды `normal`. Если у вас есть выражения:

```shell
const one = 1
console.log("one: ", one);

const two = 2
console.log("two: ", two);

const three = 3
console.log("three: ", three);
```

Обратите внимание, что строки с "const" не имеют точек с запятой. Давайте создадим макрос, чтобы добавить запятую в конец этих строк в регистре a:

```shell
qaA;<Esc>q
```

Если вам нужно освежение, посмотрите главу о макросах. Теперь выполните:

```shell
:g/const/normal @a
```

Теперь все строки с "const" будут иметь ";" в конце.

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

Если вы следовали этому пошагово, у вас будет две точки с запятой на первой строке. Чтобы избежать этого, выполните глобальную команду со второй строки и далее, `:2,$g/const/normal @a`.

## Рекурсивная глобальная команда

Глобальная команда сама по себе является типом команды командной строки, поэтому вы можете технически выполнять глобальную команду внутри глобальной команды.

Учитывая следующие выражения, если вы хотите удалить второе выражение `console.log`:

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

Если вы выполните:

```shell
:g/console/g/two/d
```

Сначала `g` будет искать строки, содержащие шаблон "console", и найдет 3 совпадения. Затем второй `g` будет искать строку, содержащую шаблон "two" из этих трех совпадений. Наконец, он удалит это совпадение.

Вы также можете комбинировать `g` с `v`, чтобы найти положительные и отрицательные шаблоны. Например:

```shell
:g/console/v/two/d
```

Вместо того, чтобы искать строку, содержащую шаблон "two", он будет искать строки, *не* содержащие шаблон "two".

## Изменение разделителя

Вы можете изменить разделитель глобальной команды, как и в команде замены. Правила те же: вы можете использовать любой одиночный байтовый символ, кроме букв, цифр, `"`, `|` и `\`.

Чтобы удалить строки, содержащие "console":

```shell
:g@console@d
```

Если вы используете команду замены с глобальной командой, вы можете использовать два разных разделителя:

```shell
g@one@s+const+let+g
```

Здесь глобальная команда будет искать все строки, содержащие "one". Команда замены заменит, из этих совпадений, строку "const" на "let".

## Команда по умолчанию

Что происходит, если вы не указываете никакую команду командной строки в глобальной команде?

Глобальная команда будет использовать команду печати (`:p`), чтобы напечатать текст текущей строки. Если вы выполните:

```shell
:g/console
```

Это напечатает внизу экрана все строки, содержащие "console".

Кстати, вот один интересный факт. Поскольку команда по умолчанию, используемая глобальной командой, — это `p`, это делает синтаксис `g` следующим:

```shell
:g/re/p
```

- `g` = глобальная команда
- `re` = регулярный шаблон
- `p` = команда печати

Это слово *"grep"*, то же самое `grep` из командной строки. Это **не** совпадение. Команда `g/re/p` изначально пришла из редактора Ed, одного из оригинальных текстовых редакторов. Команда `grep` получила свое название от Ed.

Ваш компьютер, вероятно, все еще имеет редактор Ed. Запустите `ed` из терминала (подсказка: чтобы выйти, введите `q`).

## Обратное движение всего буфера

Чтобы развернуть весь файл, выполните:

```shell
:g/^/m 0
```

`^` — это шаблон для начала строки. Используйте `^`, чтобы соответствовать всем строкам, включая пустые строки.

Если вам нужно развернуть только несколько строк, передайте ему диапазон. Чтобы развернуть строки с пятой по десятую, выполните:

```shell
:5,10g/^/m 0
```

Чтобы узнать больше о команде перемещения, посмотрите `:h :move`.

## Аггрегация всех TODO

При кодировании иногда я пишу TODO в файле, который редактирую:

```shell
const one = 1;
console.log("one: ", one);
// TODO: покормить щенка

const two = 2;
// TODO: покормить щенка автоматически
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
// TODO: создать стартап по продаже автоматической кормушки для щенков
```

Может быть трудно отслеживать все созданные TODO. У Vim есть метод `:t` (копировать), чтобы скопировать все совпадения в адрес. Чтобы узнать больше о методе копирования, посмотрите `:h :copy`.

Чтобы скопировать все TODO в конец файла для более легкого просмотра, выполните:

```shell
:g/TODO/t $
```

Результат:

```shell
const one = 1;
console.log("one: ", one);
// TODO: покормить щенка

const two = 2;
// TODO: покормить щенка автоматически
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
// TODO: создать стартап по продаже автоматической кормушки для щенков

// TODO: покормить щенка
// TODO: покормить щенка автоматически
// TODO: создать стартап по продаже автоматической кормушки для щенков
```

Теперь я могу просмотреть все TODO, которые я создал, найти время, чтобы сделать их или делегировать кому-то другому, и продолжить работать над своей следующей задачей.

Если вместо того, чтобы копировать их, вы хотите переместить все TODO в конец, используйте команду перемещения, `:m`:

```shell
:g/TODO/m $
```

Результат:

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);

// TODO: покормить щенка
// TODO: покормить щенка автоматически
// TODO: создать стартап по продаже автоматической кормушки для щенков
```

## Удаление в черную дыру

Напомню из главы о регистрах, что удаленные тексты хранятся внутри нумерованных регистров (при условии, что они достаточно большие). Каждый раз, когда вы выполняете `:g/console/d`, Vim хранит удаленные строки в нумерованных регистрах. Если вы удалите много строк, вы можете быстро заполнить все нумерованные регистры. Чтобы избежать этого, вы всегда можете использовать регистр черной дыры (`"_`), чтобы *не* сохранять ваши удаленные строки в регистрах. Выполните:

```shell
:g/console/d_
```

Передав `_` после `d`, Vim не использует ваши временные регистры.
## Уменьшение нескольких пустых строк до одной пустой строки

Если у вас есть текст с несколькими пустыми строками:

```shell
const one = 1;
console.log("one: ", one);


const two = 2;
console.log("two: ", two);





const three = 3;
console.log("three: ", three);
```

Вы можете быстро уменьшить пустые строки до одной пустой строки с помощью:

```shell
:g/^$/,/./-1j
```

Результат:

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

Обычно глобальная команда принимает следующую форму: `:g/pattern/command`. Однако вы также можете выполнить глобальную команду в следующей форме: `:g/pattern1/,/pattern2/command`. С этим Vim применит `command` в пределах `pattern1` и `pattern2`.

С учетом этого давайте разберем команду `:g/^$/,/./-1j` согласно `:g/pattern1/,/pattern2/command`:
- `/pattern1/` — это `/^$/`. Это обозначает пустую строку (строка с нулевым символом).
- `/pattern2/` — это `/./` с модификатором строки `-1`. `/./` обозначает непустую строку (строка с хотя бы одним символом). `-1` означает строку выше.
- `command` — это `j`, команда соединения (`:j`). В этом контексте эта глобальная команда соединяет все указанные строки.

Кстати, если вы хотите уменьшить несколько пустых строк до нуля строк, выполните это вместо этого:

```shell
:g/^$/,/./j
```

Более простой вариант:

```shell
:g/^$/-j
```

Ваш текст теперь уменьшен до:

```shell
const one = 1;
console.log("one: ", one);
const two = 2;
console.log("two: ", two);
const three = 3;
console.log("three: ", three);
```

## Расширенная сортировка

Vim имеет команду `:sort` для сортировки строк в пределах диапазона. Например:

```shell
d
b
a
e
c
```

Вы можете отсортировать их, выполнив `:sort`. Если вы укажете диапазон, он отсортирует только строки в этом диапазоне. Например, `:3,5sort` сортирует только строки три и пять.

Если у вас есть следующие выражения:

```shell
const arrayB = [
  "i",
  "g",
  "h",
  "b",
  "f",
  "d",
  "e",
  "c",
  "a",
]

const arrayA = [
  "h",
  "b",
  "f",
  "d",
  "e",
  "a",
  "c",
]
```

Если вам нужно отсортировать элементы внутри массивов, но не сами массивы, вы можете выполнить это:

```shell
:g/\[/+1,/\]/-1sort
```

Результат:

```shell
const arrayB = [
  "a",
  "b",
  "c",
  "d",
  "e",
  "f",
  "g",
  "h",
  "i",
]

const arrayA = [
  "a"
  "b",
  "c",
  "d",
  "e",
  "f",
  "h",
]
```

Это здорово! Но команда выглядит сложно. Давайте разберем ее. Эта команда также следует форме `:g/pattern1/,/pattern2/command`.

- `:g` — это глобальная команда.
- `/\[/+1` — это первый шаблон. Он соответствует буквальной левой квадратной скобке "[". `+1` относится к строке ниже.
- `/\]/-1` — это второй шаблон. Он соответствует буквенной правой квадратной скобке "]". `-1` относится к строке выше.
- `/\[/+1,/\]/-1` затем относится ко всем строкам между "[" и "]".
- `sort` — это командная строка для сортировки.

## Учите глобальную команду умным способом

Глобальная команда выполняет команду командной строки против всех совпадающих строк. С ней вам нужно запустить команду только один раз, и Vim сделает все остальное за вас. Чтобы стать опытным в глобальной команде, требуется две вещи: хороший словарный запас команд командной строки и знание регулярных выражений. По мере того как вы проводите больше времени, используя Vim, вы естественным образом будете учить больше команд командной строки. Знание регулярных выражений потребует более активного подхода. Но как только вы станете уверенно использовать регулярные выражения, вы будете впереди многих.

Некоторые из примеров здесь сложные. Не пугайтесь. Действительно, уделите время, чтобы понять их. Учитесь читать шаблоны. Не сдавайтесь.

Когда вам нужно выполнить несколько команд, остановитесь и посмотрите, можете ли вы использовать команду `g`. Определите лучшую команду для работы и напишите шаблон, чтобы нацелиться на как можно больше вещей сразу.

Теперь, когда вы знаете, насколько мощной является глобальная команда, давайте научимся использовать внешние команды, чтобы увеличить ваш арсенал инструментов.