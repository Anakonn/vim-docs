---
description: В этой главе вы узнаете, как быстро искать в Vim, используя встроенные
  функции и плагин fzf.vim для повышения продуктивности.
title: Ch03. Searching Files
---

Цель этой главы — дать вам введение в то, как быстро искать в Vim. Умение быстро искать — отличный способ ускорить вашу продуктивность в Vim. Когда я понял, как быстро искать файлы, я полностью перешел на использование Vim.

Эта глава делится на две части: как искать без плагинов и как искать с помощью плагина [fzf.vim](https://github.com/junegunn/fzf.vim). Давайте начнем!

## Открытие и редактирование файлов

Чтобы открыть файл в Vim, вы можете использовать `:edit`.

```shell
:edit file.txt
```

Если `file.txt` существует, он откроет буфер `file.txt`. Если `file.txt` не существует, будет создан новый буфер для `file.txt`.

Автозаполнение с помощью `<Tab>` работает с `:edit`. Например, если ваш файл находится в директории контроллеров пользователей *a*pp *c*ontroller `./app/controllers/users_controllers.rb`, вы можете использовать `<Tab>`, чтобы быстро развернуть термины:

```shell
:edit a<Tab>c<Tab>u<Tab>
```

`:edit` принимает аргументы с подстановочными знаками. `*` соответствует любому файлу в текущей директории. Если вы ищете только файлы с расширением `.yml` в текущей директории:

```shell
:edit *.yml<Tab>
```

Vim предоставит вам список всех `.yml` файлов в текущей директории на выбор.

Вы можете использовать `**` для рекурсивного поиска. Если вы хотите найти все `*.md` файлы в вашем проекте, но не уверены, в каких директориях, вы можете сделать это:

```shell
:edit **/*.md<Tab>
```

`:edit` можно использовать для запуска `netrw`, встроенного файлового менеджера Vim. Для этого передайте `:edit` аргументом директорию вместо файла:

```shell
:edit .
:edit test/unit/
```

## Поиск файлов с помощью Find

Вы можете находить файлы с помощью `:find`. Например:

```shell
:find package.json
:find app/controllers/users_controller.rb
```

Автозаполнение также работает с `:find`:

```shell
:find p<Tab>                " чтобы найти package.json
:find a<Tab>c<Tab>u<Tab>    " чтобы найти app/controllers/users_controller.rb
```

Вы можете заметить, что `:find` выглядит как `:edit`. В чем разница?

## Find и Path

Разница в том, что `:find` ищет файл в `path`, а `:edit` — нет. Давайте немного узнаем о `path`. Как только вы научитесь изменять свои пути, `:find` может стать мощным инструментом поиска. Чтобы проверить, какие у вас пути, выполните:

```shell
:set path?
```

По умолчанию ваши пути, вероятно, выглядят так:

```shell
path=.,/usr/include,,
```

- `.` означает поиск в директории открытого в данный момент файла.
- `,` означает поиск в текущей директории.
- `/usr/include` — это типичная директория для заголовочных файлов библиотек C.

Первые два важны в нашем контексте, а третий можно игнорировать на данный момент. Главное здесь — вы можете изменять свои собственные пути, где Vim будет искать файлы. Предположим, это структура вашего проекта:

```shell
app/
  assets/
  controllers/
    application_controller.rb
    comments_controller.rb
    users_controller.rb
    ...
```

Если вы хотите перейти к `users_controller.rb` из корневой директории, вам придется пройти через несколько директорий (и нажать значительное количество табов). Часто, работая с фреймворком, вы проводите 90% своего времени в определенной директории. В этой ситуации вам важно перейти в директорию `controllers/` с минимальным количеством нажатий клавиш. Настройка `path` может сократить это путешествие.

Вам нужно добавить `app/controllers/` в текущий `path`. Вот как вы можете это сделать:

```shell
:set path+=app/controllers/
```

Теперь, когда ваш путь обновлен, когда вы вводите `:find u<Tab>`, Vim будет искать файлы, начинающиеся с "u", внутри директории `app/controllers/`.

Если у вас есть вложенная директория `controllers/`, такая как `app/controllers/account/users_controller.rb`, Vim не найдет `users_controllers`. Вместо этого вам нужно добавить `:set path+=app/controllers/**`, чтобы автозаполнение нашло `users_controller.rb`. Это здорово! Теперь вы можете найти контроллер пользователей с 1 нажатием таба вместо 3.

Вы можете подумать о том, чтобы добавить все директории проекта, чтобы при нажатии `tab` Vim искал везде этот файл, вот так:

```shell
:set path+=$PWD/**
```

`$PWD` — это текущая рабочая директория. Если вы попытаетесь добавить весь ваш проект в `path`, надеясь сделать все файлы доступными при нажатии `tab`, хотя это может сработать для небольшого проекта, это значительно замедлит ваш поиск, если у вас много файлов в проекте. Я рекомендую добавлять только `path` ваших наиболее посещаемых файлов / директорий.

Вы можете добавить `set path+={ваш-путь-здесь}` в ваш vimrc. Обновление `path` занимает всего несколько секунд и может сэкономить вам много времени.

## Поиск в файлах с помощью Grep

Если вам нужно найти в файлах (найти фразы в файлах), вы можете использовать grep. Vim предлагает два способа сделать это:

- Внутренний grep (`:vim`. Да, это написано как `:vim`. Это сокращение от `:vimgrep`).
- Внешний grep (`:grep`).

Давайте сначала рассмотрим внутренний grep. `:vim` имеет следующий синтаксис:

```shell
:vim /pattern/ file
```

- `/pattern/` — это регулярное выражение вашего поискового термина.
- `file` — это аргумент файла. Вы можете передать несколько аргументов. Vim будет искать шаблон внутри аргумента файла. Подобно `:find`, вы можете передать ему подстановочные знаки `*` и `**`.

Например, чтобы найти все вхождения строки "breakfast" во всех ruby файлах (`.rb`) в директории `app/controllers/`:

```shell
:vim /breakfast/ app/controllers/**/*.rb
```

После выполнения этой команды вы будете перенаправлены на первый результат. Команда поиска `vim` в Vim использует операцию `quickfix`. Чтобы увидеть все результаты поиска, выполните `:copen`. Это откроет окно `quickfix`. Вот несколько полезных команд quickfix, чтобы вы могли сразу же приступить к работе:

```shell
:copen        Открыть окно quickfix
:cclose       Закрыть окно quickfix
:cnext        Перейти к следующей ошибке
:cprevious    Перейти к предыдущей ошибке
:colder       Перейти к более старому списку ошибок
:cnewer       Перейти к более новому списку ошибок
```

Чтобы узнать больше о quickfix, ознакомьтесь с `:h quickfix`.

Вы можете заметить, что выполнение внутреннего grep (`:vim`) может замедляться, если у вас много совпадений. Это потому, что Vim загружает каждый совпадающий файл в память, как будто он редактируется. Если Vim находит большое количество файлов, соответствующих вашему поиску, он загрузит их все и, следовательно, потребует много памяти.

Давайте поговорим о внешнем grep. По умолчанию он использует команду терминала `grep`. Чтобы искать "lunch" внутри ruby файла в директории `app/controllers/`, вы можете сделать это:

```shell
:grep -R "lunch" app/controllers/
```

Обратите внимание, что вместо использования `/pattern/` он следует синтаксису терминального grep `"pattern"`. Он также отображает все совпадения с помощью quickfix.

Vim определяет переменную `grepprg`, чтобы определить, какую внешнюю программу запускать при выполнении команды `:grep` в Vim, чтобы вам не приходилось закрывать Vim и вызывать команду терминала `grep`. Позже я покажу вам, как изменить программу по умолчанию, вызываемую при использовании команды `:grep` в Vim.

## Просмотр файлов с помощью Netrw

`netrw` — это встроенный файловый менеджер Vim. Он полезен для просмотра иерархии проекта. Чтобы запустить `netrw`, вам нужно установить эти два параметра в вашем `.vimrc`:

```shell
set nocp
filetype plugin on
```

Поскольку `netrw` — это обширная тема, я охвачу только основные моменты, но этого должно быть достаточно, чтобы начать. Вы можете запустить `netrw`, когда запускаете Vim, передав ему директорию в качестве параметра вместо файла. Например:

```shell
vim .
vim src/client/
vim app/controllers/
```

Чтобы запустить `netrw` изнутри Vim, вы можете использовать команду `:edit` и передать ей параметр директории вместо имени файла:

```shell
:edit .
:edit src/client/
:edit app/controllers/
```

Существуют и другие способы запустить окно `netrw`, не передавая директорию:

```shell
:Explore     Запускает netrw для текущего файла
:Sexplore    Не шутка. Запускает netrw на верхней половине экрана
:Vexplore    Запускает netrw на левой половине экрана
```

Вы можете перемещаться по `netrw` с помощью движений Vim (движения будут подробно рассмотрены в следующей главе). Если вам нужно создать, удалить или переименовать файл или директорию, вот список полезных команд `netrw`:

```shell
%    Создать новый файл
d    Создать новую директорию
R    Переименовать файл или директорию
D    Удалить файл или директорию
```

`:h netrw` очень подробен. Ознакомьтесь с ним, если у вас есть время.

Если вы считаете `netrw` слишком скучным и вам нужно больше изюминки, [vim-vinegar](https://github.com/tpope/vim-vinegar) — хороший плагин для улучшения `netrw`. Если вы ищете другой файловый менеджер, [NERDTree](https://github.com/preservim/nerdtree) — хорошая альтернатива. Ознакомьтесь с ними!

## Fzf

Теперь, когда вы узнали, как искать файлы в Vim с помощью встроенных инструментов, давайте узнаем, как сделать это с помощью плагинов.

Одно из того, что современные текстовые редакторы делают правильно, и что Vim не делает, — это насколько легко находить файлы, особенно с помощью нечеткого поиска. Во второй половине этой главы я покажу вам, как использовать [fzf.vim](https://github.com/junegunn/fzf.vim), чтобы сделать поиск в Vim простым и мощным.

## Настройка

Сначала убедитесь, что у вас загружены [fzf](https://github.com/junegunn/fzf) и [ripgrep](https://github.com/BurntSushi/ripgrep). Следуйте инструкциям на их репозитории GitHub. Команды `fzf` и `rg` должны быть доступны после успешной установки.

Ripgrep — это инструмент поиска, очень похожий на grep (отсюда и название). Он, как правило, быстрее, чем grep, и имеет много полезных функций. Fzf — это универсальный инструмент для нечеткого поиска в командной строке. Вы можете использовать его с любыми командами, включая ripgrep. Вместе они составляют мощную комбинацию инструментов поиска.

Fzf по умолчанию не использует ripgrep, поэтому нам нужно сказать fzf использовать ripgrep, определив переменную `FZF_DEFAULT_COMMAND`. В моем `.zshrc` (`.bashrc`, если вы используете bash) у меня есть следующее:

```shell
if type rg &> /dev/null; then
  export FZF_DEFAULT_COMMAND='rg --files'
  export FZF_DEFAULT_OPTS='-m'
fi
```

Обратите внимание на `-m` в `FZF_DEFAULT_OPTS`. Эта опция позволяет нам делать несколько выборок с помощью `<Tab>` или `<Shift-Tab>`. Вам не нужна эта строка, чтобы fzf работал с Vim, но я думаю, что это полезная опция. Она пригодится, когда вы захотите выполнить поиск и замену в нескольких файлах, о чем я расскажу чуть позже. Команда fzf принимает много других опций, но я не буду их здесь рассматривать. Чтобы узнать больше, ознакомьтесь с [репозиторием fzf](https://github.com/junegunn/fzf#usage) или `man fzf`. Минимум, что вам нужно, это `export FZF_DEFAULT_COMMAND='rg'`.

После установки fzf и ripgrep давайте настроим плагин fzf. В этом примере я использую менеджер плагинов [vim-plug](https://github.com/junegunn/vim-plug), но вы можете использовать любой менеджер плагинов.

Добавьте это в раздел плагинов вашего `.vimrc`. Вам нужно использовать плагин [fzf.vim](https://github.com/junegunn/fzf.vim) (созданный тем же автором fzf).

```shell
call plug#begin()
Plug 'junegunn/fzf.vim'
Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }
call plug#end()
```

После добавления этих строк вам нужно открыть `vim` и выполнить `:PlugInstall`. Это установит все плагины, которые определены в вашем файле vimrc и не установлены. В нашем случае это установит `fzf.vim` и `fzf`.

Для получения дополнительной информации об этом плагине вы можете ознакомиться с [репозиторием fzf.vim](https://github.com/junegunn/fzf/blob/master/README-VIM.md).
## Синтаксис Fzf

Чтобы эффективно использовать fzf, вам следует изучить некоторые основные синтаксисы fzf. К счастью, список короткий:

- `^` — это точное совпадение по префиксу. Чтобы найти фразу, начинающуюся с "welcome": `^welcome`.
- `$` — это точное совпадение по суффиксу. Чтобы найти фразу, заканчивающуюся на "my friends": `friends$`.
- `'` — это точное совпадение. Чтобы найти фразу "welcome my friends": `'welcome my friends`.
- `|` — это совпадение "или". Чтобы найти либо "friends", либо "foes": `friends | foes`.
- `!` — это инверсное совпадение. Чтобы найти фразу, содержащую "welcome" и не содержащую "friends": `welcome !friends`

Вы можете комбинировать эти опции. Например, `^hello | ^welcome friends$` будет искать фразу, начинающуюся либо с "welcome", либо с "hello" и заканчивающуюся на "friends".

## Поиск файлов

Чтобы искать файлы внутри Vim с помощью плагина fzf.vim, вы можете использовать метод `:Files`. Запустите `:Files` из Vim, и вам будет предложено ввести запрос для поиска fzf.

Поскольку вы будете часто использовать эту команду, хорошо бы назначить её на сочетание клавиш. Я назначил своё на `Ctrl-f`. В моем vimrc это выглядит так:

```shell
nnoremap <silent> <C-f> :Files<CR>
```

## Поиск в файлах

Чтобы искать внутри файлов, вы можете использовать команду `:Rg`.

Снова, поскольку вы, вероятно, будете использовать это часто, давайте назначим это на сочетание клавиш. Я назначил своё на `<Leader>f`. Клавиша `<Leader>` по умолчанию назначена на `\`.

```shell
nnoremap <silent> <Leader>f :Rg<CR>
```

## Другие поиски

Fzf.vim предоставляет множество других команд поиска. Я не буду проходить через каждую из них здесь, но вы можете ознакомиться с ними [здесь](https://github.com/junegunn/fzf.vim#commands).

Вот как выглядят мои привязки fzf:

```shell
nnoremap <silent> <Leader>b :Buffers<CR>
nnoremap <silent> <C-f> :Files<CR>
nnoremap <silent> <Leader>f :Rg<CR>
nnoremap <silent> <Leader>/ :BLines<CR>
nnoremap <silent> <Leader>' :Marks<CR>
nnoremap <silent> <Leader>g :Commits<CR>
nnoremap <silent> <Leader>H :Helptags<CR>
nnoremap <silent> <Leader>hh :History<CR>
nnoremap <silent> <Leader>h: :History:<CR>
nnoremap <silent> <Leader>h/ :History/<CR>
```

## Замена Grep на Rg

Как уже упоминалось, Vim имеет два способа поиска в файлах: `:vim` и `:grep`. `:grep` использует внешний инструмент поиска, который вы можете переназначить с помощью ключевого слова `grepprg`. Я покажу вам, как настроить Vim для использования ripgrep вместо терминального grep при выполнении команды `:grep`.

Теперь давайте настроим `grepprg`, чтобы команда `:grep` в Vim использовала ripgrep. Добавьте это в ваш vimrc:

```shell
set grepprg=rg\ --vimgrep\ --smart-case\ --follow
```

Не стесняйтесь изменять некоторые из вышеперечисленных опций! Для получения дополнительной информации о значении вышеуказанных опций, ознакомьтесь с `man rg`.

После того как вы обновили `grepprg`, теперь, когда вы запускаете `:grep`, он выполняет `rg --vimgrep --smart-case --follow` вместо `grep`. Если вы хотите искать "donut" с помощью ripgrep, вы теперь можете выполнить более лаконичную команду `:grep "donut"` вместо `:grep "donut" . -R`.

Как и старый `:grep`, этот новый `:grep` также использует quickfix для отображения результатов.

Вы можете задаться вопросом: "Ну, это хорошо, но я никогда не использовал `:grep` в Vim, плюс разве я не могу просто использовать `:Rg`, чтобы находить фразы в файлах? Когда мне когда-либо понадобится использовать `:grep`?"

Это очень хороший вопрос. Вам может понадобиться использовать `:grep` в Vim для поиска и замены в нескольких файлах, что я рассмотрю далее.

## Поиск и замена в нескольких файлах

Современные текстовые редакторы, такие как VSCode, делают поиск и замену строки в нескольких файлах очень простым. В этом разделе я покажу вам два разных метода, чтобы легко сделать это в Vim.

Первый метод — заменить *все* совпадающие фразы в вашем проекте. Вам нужно будет использовать `:grep`. Если вы хотите заменить все вхождения "pizza" на "donut", вот что вам нужно сделать:

```shell
:grep "pizza"
:cfdo %s/pizza/donut/g | update
```

Давайте разберем команды:

1. `:grep pizza` использует ripgrep для поиска всех вхождений "pizza" (кстати, это все равно будет работать, даже если вы не переназначили `grepprg` на использование ripgrep. Вам нужно будет выполнить `:grep "pizza" . -R` вместо `:grep "pizza"`).
2. `:cfdo` выполняет любую команду, которую вы передаете, для всех файлов в вашем списке quickfix. В этом случае вашей командой является команда замены `%s/pizza/donut/g`. Пайп (`|`) является оператором цепочки. Команда `update` сохраняет каждый файл после замены. Я подробнее расскажу о команде замены в следующей главе.

Второй метод — искать и заменять в выбранных файлах. С помощью этого метода вы можете вручную выбрать, в каких файлах вы хотите выполнить выбор и замену. Вот что вам нужно сделать:

1. Сначала очистите свои буферы. Важно, чтобы ваш список буферов содержал только файлы, в которых вы хотите выполнить замену. Вы можете либо перезапустить Vim, либо выполнить команду `:%bd | e#` (`%bd` удаляет все буферы, а `e#` открывает файл, в котором вы только что были).
2. Запустите `:Files`.
3. Выберите все файлы, в которых вы хотите выполнить поиск и замену. Чтобы выбрать несколько файлов, используйте `<Tab>` / `<Shift-Tab>`. Это возможно только если у вас установлен флаг множественного выбора (`-m`) в `FZF_DEFAULT_OPTS`.
4. Запустите `:bufdo %s/pizza/donut/g | update`. Команда `:bufdo %s/pizza/donut/g | update` выглядит похоже на предыдущую команду `:cfdo %s/pizza/donut/g | update`. Разница в том, что вместо замены всех записей quickfix (`:cfdo`), вы заменяете все записи буфера (`:bufdo`).

## Учитесь искать умным способом

Поиск — это основа текстового редактирования. Изучение того, как хорошо искать в Vim, значительно улучшит ваш рабочий процесс редактирования текста.

Fzf.vim — это настоящая находка. Я не могу представить использование Vim без него. Я считаю, что очень важно иметь хороший инструмент поиска при начале работы с Vim. Я видел, как люди испытывают трудности с переходом на Vim, потому что он, казалось бы, лишен критически важных функций, которые есть у современных текстовых редакторов, таких как простой и мощный инструмент поиска. Я надеюсь, что эта глава поможет вам сделать переход на Vim более легким.

Вы также только что увидели, как расширяемость Vim работает в действии — возможность расширять функциональность поиска с помощью плагина и внешней программы. В будущем имейте в виду, какие другие функции вы хотите расширить в Vim. Скорее всего, это уже есть в Vim, кто-то создал плагин или для этого уже существует программа. Далее вы узнаете о очень важной теме в Vim: грамматике Vim.