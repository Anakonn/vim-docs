---
description: В этом документе рассматривается система отмены и повтора в Vim, включая
  управление состояниями текста и навигацию по ветвям отмены.
title: Ch10. Undo
---

Мы все совершаем всевозможные ошибки при наборе текста. Вот почему функция отмены является важной особенностью любого современного программного обеспечения. Система отмены в Vim способна не только отменять и повторять простые ошибки, но и получать доступ к различным состояниям текста, предоставляя вам контроль над всеми текстами, которые вы когда-либо набирали. В этой главе вы узнаете, как отменять, повторять, перемещаться по ветвям отмены, сохранять отмену и путешествовать во времени.

## Отмена, Повтор и ОТМЕНА

Чтобы выполнить базовую отмену, вы можете использовать `u` или выполнить `:undo`.

Если у вас есть этот текст (обратите внимание на пустую строку под "one"):

```shell
one

```

Затем вы добавляете другой текст:

```shell
one
two
```

Если вы нажмете `u`, Vim отменит текст "two".

Как Vim знает, сколько отменять? Vim отменяет одно "изменение" за раз, подобно изменению команды точки (в отличие от команды точки, команды командной строки также считаются изменением).

Чтобы повторить последнее изменение, нажмите `Ctrl-R` или выполните `:redo`. После того как вы отмените текст выше, чтобы удалить "two", выполнение `Ctrl-R` вернет удаленный текст.

У Vim также есть ОТМЕНА, которую вы можете выполнить с помощью `U`. Она отменяет все последние изменения.

Чем `U` отличается от `u`? Во-первых, `U` удаляет *все* изменения на последней измененной строке, в то время как `u` удаляет только одно изменение за раз. Во-вторых, выполнение `u` не считается изменением, тогда как выполнение `U` считается изменением.

Вернемся к этому примеру:

```shell
one
two
```

Измените вторую строку на "three":

```shell
one
three
```

Снова измените вторую строку и замените ее на "four":

```shell
one
four
```

Если вы нажмете `u`, вы увидите "three". Если вы снова нажмете `u`, вы увидите "two". Если вместо нажатия `u`, когда у вас еще был текст "four", вы нажали `U`, вы увидите:

```shell
one

```

`U` пропускает все промежуточные изменения и возвращает к исходному состоянию, когда вы начали (пустая строка). Кроме того, поскольку ОТМЕНА фактически создает новое изменение в Vim, вы можете ОТМЕНИТЬ свою ОТМЕНУ. `U`, за которым следует `U`, отменит само себя. Вы можете нажимать `U`, затем `U`, затем `U` и так далее. Вы будете видеть те же два состояния текста, переключающиеся взад и вперед.

Лично я не использую `U`, потому что трудно запомнить исходное состояние (я редко в этом нуждаюсь).

Vim устанавливает максимальное количество раз, сколько вы можете отменить, в переменной опции `undolevels`. Вы можете проверить это с помощью `:echo &undolevels`. У меня установлено 1000. Чтобы изменить ваше на 1000, выполните `:set undolevels=1000`. Не стесняйтесь устанавливать любое число, которое вам нравится.

## Разрыв Блоков

Я упоминал ранее, что `u` отменяет одно "изменение", подобно изменению команды точки: тексты, вставленные с момента входа в режим вставки до его выхода, считаются изменением.

Если вы выполните `ione two three<Esc>`, а затем нажмете `u`, Vim удалит весь текст "one two three", потому что все это считается изменением. Это не проблема, если вы написали короткие тексты, но что, если вы написали несколько абзацев за одну сессию режима вставки, не выходя из него, и позже поняли, что сделали ошибку? Если вы нажмете `u`, все, что вы написали, будет удалено. Разве не было бы полезно, если бы вы могли нажать `u`, чтобы удалить только часть вашего текста?

К счастью, вы можете разорвать блоки отмены. Когда вы печатаете в режиме вставки, нажатие `Ctrl-G u` создает контрольную точку отмены. Например, если вы выполните `ione <Ctrl-G u>two <Ctrl-G u>three<Esc>`, затем нажмете `u`, вы потеряете только текст "three" (нажмите `u` еще раз, чтобы удалить "two"). Когда вы пишете длинный текст, используйте `Ctrl-G u` стратегически. Конец каждого предложения, между двумя абзацами или после каждой строки кода — это отличные места для добавления контрольных точек отмены, чтобы облегчить отмену ваших ошибок, если вы когда-либо их сделаете.

Также полезно создать контрольную точку отмены при удалении фрагментов в режиме вставки с помощью `Ctrl-W` (удалить слово перед курсором) и `Ctrl-U` (удалить весь текст перед курсором). Один друг предложил использовать следующие карты:

```shell
inoremap <c-u> <c-g>u<c-u>
inoremap <c-w> <c-g>u<c-w>
```

С помощью этих карт вы можете легко восстановить удаленные тексты.

## Дерево Отмены

Vim хранит каждое изменение, когда-либо написанное, в дереве отмены. Начните новый пустой файл. Затем добавьте новый текст:

```shell
one

```

Добавьте новый текст:

```shell
one
two
```

Отмените один раз:

```shell
one

```

Добавьте другой текст:

```shell
one
three
```

Отмените снова:

```shell
one

```

И добавьте еще один другой текст:

```shell
one
four
```

Теперь, если вы отмените, вы потеряете текст "four", который только что добавили:

```shell
one

```

Если вы отмените еще раз:

```shell

```

Вы потеряете текст "one". В большинстве текстовых редакторов вернуть тексты "two" и "three" было бы невозможно, но не в Vim! Нажмите `g+`, и вы получите свой текст "one" обратно:

```shell
one

```

Наберите `g+` снова, и вы увидите старого друга:

```shell
one
two
```

Продолжим. Нажмите `g+` снова:

```shell
one
three
```

Нажмите `g+` еще раз:

```shell
one
four
```

В Vim каждый раз, когда вы нажимаете `u`, а затем вносите другое изменение, Vim сохраняет текст предыдущего состояния, создавая "ветвь отмены". В этом примере, после того как вы набрали "two", затем нажали `u`, а затем набрали "three", вы создали листовую ветвь, которая хранит состояние, содержащее текст "two". В этот момент дерево отмены содержало как минимум два листовых узла: основной узел, содержащий текст "three" (самый последний), и узел ветви отмены, содержащий текст "two". Если бы вы сделали еще одну отмену и набрали текст "four", у вас было бы три узла: основной узел, содержащий текст "four", и два узла, содержащие тексты "three" и "two".

Чтобы перемещаться по каждому узлу дерева отмены, вы можете использовать `g+`, чтобы перейти к более новому состоянию, и `g-`, чтобы перейти к более старому состоянию. Разница между `u`, `Ctrl-R`, `g+` и `g-` заключается в том, что и `u`, и `Ctrl-R` перемещаются только по *основным* узлам в дереве отмены, в то время как `g+` и `g-` перемещаются по *всем* узлам в дереве отмены.

Дерево отмены не легко визуализировать. Я нахожу плагин [vim-mundo](https://github.com/simnalamburt/vim-mundo) очень полезным для визуализации дерева отмены Vim. Потратьте немного времени, чтобы поиграть с ним.

## Периодическая Отмена

Если вы запустите Vim, откроете файл и сразу нажмете `u`, Vim, вероятно, отобразит предупреждение "*Уже на самом старом изменении*". Нечего отменять, потому что вы не внесли никаких изменений.

Чтобы перенести историю отмены из последней сессии редактирования, Vim может сохранить вашу историю отмены с помощью файла отмены с `:wundo`.

Создайте файл `mynumbers.txt`. Наберите:

```shell
one
```

Затем введите еще одну строку (убедитесь, что каждая строка считается изменением):

```shell
one
two
```

Наберите еще одну строку:

```shell
one
two
three
```

Теперь создайте свой файл отмены с помощью `:wundo {my-undo-file}`. Если вам нужно перезаписать существующий файл отмены, вы можете добавить `!` после `wundo`.

```shell
:wundo! mynumbers.undo
```

Затем выйдите из Vim.

Теперь у вас должны быть файлы `mynumbers.txt` и `mynumbers.undo` в вашей директории. Откройте `mynumbers.txt` снова и попробуйте нажать `u`. Вы не можете. Вы не внесли никаких изменений с тех пор, как открыли файл. Теперь загрузите свою историю отмены, прочитав файл отмены с помощью `:rundo`:

```shell
:rundo mynumbers.undo
```

Теперь, если вы нажмете `u`, Vim удалит "three". Нажмите `u` еще раз, чтобы удалить "two". Это как будто вы даже не закрывали Vim!

Если вы хотите, чтобы отмена сохранялась автоматически, одним из способов сделать это является добавление следующего в vimrc:

```shell
set undodir=~/.vim/undo_dir
set undofile
```

Настройка выше поместит все файлы отмены в одну централизованную директорию, директорию `~/.vim`. Имя `undo_dir` произвольно. `set undofile` говорит Vim включить функцию `undofile`, потому что она по умолчанию отключена. Теперь, когда вы сохраняете, Vim автоматически создает и обновляет соответствующий файл внутри директории `undo_dir` (убедитесь, что вы создали фактическую директорию `undo_dir` внутри директории `~/.vim` перед выполнением этого).

## Путешествие во Времени

Кто сказал, что путешествия во времени не существуют? Vim может перемещаться к состоянию текста в прошлом с помощью команды командной строки `:earlier`.

Если у вас есть этот текст:

```shell
one

```
Затем позже вы добавляете:

```shell
one
two
```

Если вы набрали "two" менее десяти секунд назад, вы можете вернуться к состоянию, где "two" не существовало десять секунд назад с помощью:

```shell
:earlier 10s
```

Вы можете использовать `:undolist`, чтобы увидеть, когда было сделано последнее изменение. `:earlier` также принимает различные аргументы:

```shell
:earlier 10s    Перейти к состоянию 10 секунд назад
:earlier 10m    Перейти к состоянию 10 минут назад
:earlier 10h    Перейти к состоянию 10 часов назад
:earlier 10d    Перейти к состоянию 10 дней назад
```

Кроме того, он также принимает обычный `count` в качестве аргумента, чтобы сказать Vim вернуться к более старому состоянию `count` раз. Например, если вы выполните `:earlier 2`, Vim вернется к более старому текстовому состоянию два изменения назад. Это то же самое, что выполнить `g-` дважды. Вы также можете сказать ему вернуться к более старому текстовому состоянию 10 сохранений назад с помощью `:earlier 10f`.

Тот же набор аргументов работает с аналогом `:earlier`: `:later`.

```shell
:later 10s    перейти к состоянию 10 секунд спустя
:later 10m    перейти к состоянию 10 минут спустя
:later 10h    перейти к состоянию 10 часов спустя
:later 10d    перейти к состоянию 10 дней спустя
:later 10     перейти к новому состоянию 10 раз
:later 10f    перейти к состоянию 10 сохранений спустя
```

## Учите Отмену Умным Способом

`u` и `Ctrl-R` — две незаменимые команды Vim для исправления ошибок. Учите их в первую очередь. Затем научитесь использовать `:earlier` и `:later`, используя временные аргументы сначала. После этого уделите время, чтобы понять дерево отмены. Плагин [vim-mundo](https://github.com/simnalamburt/vim-mundo) очень помог мне. Набирайте тексты в этой главе и проверяйте дерево отмены, когда вносите каждое изменение. Как только вы это поймете, вы никогда больше не увидите систему отмены прежним образом.

Перед этой главой вы узнали, как находить любой текст в проекте, с помощью отмены вы теперь можете находить любой текст в временном измерении. Теперь вы можете искать любой текст по его местоположению и времени написания. Вы достигли всемогущества Vim.