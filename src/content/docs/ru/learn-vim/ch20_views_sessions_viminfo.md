---
description: В этом разделе вы узнаете, как использовать View, Session и Viminfo для
  сохранения настроек и состояния проектов в Vim.
title: Ch20. Views, Sessions, and Viminfo
---

После того, как вы поработали над проектом некоторое время, вы можете заметить, что проект постепенно принимает форму со своими настройками, свертками, буферами, макетами и т. д. Это похоже на то, как вы украшаете свою квартиру после того, как некоторое время в ней живете. Проблема в том, что когда вы закрываете Vim, вы теряете эти изменения. Разве не было бы здорово, если бы вы могли сохранить эти изменения, чтобы в следующий раз, когда вы откроете Vim, он выглядел так, как будто вы никогда не уходили?

В этой главе вы узнаете, как использовать View, Session и Viminfo для сохранения "снимка" ваших проектов.

## View

View — это наименьший подмножество из трех (View, Session, Viminfo). Это коллекция настроек для одного окна. Если вы долго работаете в окне и хотите сохранить карты и свертки, вы можете использовать View.

Давайте создадим файл с именем `foo.txt`:

```shell
foo1
foo2
foo3
foo4
foo5
foo6
foo7
foo8
foo9
foo10
```

В этом файле создайте три изменения:
1. На строке 1 создайте ручной сверток `zf4j` (сверните следующие 4 строки).
2. Измените настройку `number`: `setlocal nonumber norelativenumber`. Это уберет индикаторы номеров с левой стороны окна.
3. Создайте локальное сопоставление, чтобы каждый раз, когда вы нажимаете `j`, перемещаться вниз на две строки вместо одной: `:nnoremap <buffer> j jj`.

Ваш файл должен выглядеть так:

```shell
+-- 5 lines: foo1 -----
foo6
foo7
foo8
foo9
foo10
```

### Настройка атрибутов View

Запустите:

```shell
:set viewoptions?
```

По умолчанию должно быть указано (ваше может выглядеть иначе в зависимости от вашего vimrc):

```shell
viewoptions=folds,cursor,curdir
```

Давайте настроим `viewoptions`. Три атрибута, которые вы хотите сохранить, это свертки, карты и локальные настройки. Если ваша настройка выглядит как моя, у вас уже есть опция `folds`. Вам нужно сказать View запомнить `localoptions`. Запустите:

```shell
:set viewoptions+=localoptions
```

Чтобы узнать, какие другие опции доступны для `viewoptions`, посмотрите `:h viewoptions`. Теперь, если вы запустите `:set viewoptions?`, вы должны увидеть:

```shell
viewoptions=folds,cursor,curdir,localoptions
```

### Сохранение View

С окном `foo.txt`, правильно свернутым и с опциями `nonumber norelativenumber`, давайте сохраним View. Запустите:

```shell
:mkview
```

Vim создает файл View.

### Файлы View

Вы можете задаться вопросом: "Где Vim сохранил этот файл View?" Чтобы увидеть, где Vim его сохраняет, выполните:

```shell
:set viewdir?
```

В Unix-подобных ОС по умолчанию должно быть указано `~/.vim/view` (если у вас другая ОС, путь может быть другим. Посмотрите `:h viewdir` для получения дополнительной информации). Если вы используете Unix-подобную ОС и хотите изменить его на другой путь, добавьте это в ваш vimrc:

```shell
set viewdir=$HOME/else/where
```

### Загрузка файла View

Закройте `foo.txt`, если вы этого еще не сделали, затем откройте `foo.txt` снова. **Вы должны увидеть оригинальный текст без изменений.** Это ожидаемо.

Чтобы восстановить состояние, вам нужно загрузить файл View. Запустите:

```shell
:loadview
```

Теперь вы должны увидеть:

```shell
+-- 5 lines: foo1 -----
foo6
foo7
foo8
foo9
foo10
```

Свертки, локальные настройки и локальные сопоставления восстановлены. Если вы заметили, курсор также должен находиться на строке, где вы его оставили, когда выполняли `:mkview`. Пока у вас есть опция `cursor`, View также запоминает положение курсора.

### Несколько Views

Vim позволяет сохранять 9 пронумерованных Views (1-9).

Предположим, вы хотите создать дополнительный сверток (скажем, вы хотите свернуть последние две строки) с помощью `:9,10 fold`. Давайте сохраним это как View 1. Запустите:

```shell
:mkview 1
```

Если вы хотите сделать еще один сверток с помощью `:6,7 fold` и сохранить его как другой View, запустите:

```shell
:mkview 2
```

Закройте файл. Когда вы откроете `foo.txt` и захотите загрузить View 1, запустите:

```shell
:loadview 1
```

Чтобы загрузить View 2, запустите:

```shell
:loadview 2
```

Чтобы загрузить оригинальный View, запустите:

```shell
:loadview
```

### Автоматизация создания View

Одно из худших вещей, которые могут произойти, это то, что после того, как вы провели бесчисленные часы, организуя большой файл со свертками, вы случайно закроете окно и потеряете всю информацию о свертках. Чтобы предотвратить это, вы можете автоматически создавать View каждый раз, когда закрываете буфер. Добавьте это в ваш vimrc:

```shell
autocmd BufWinLeave *.txt mkview
```

Кроме того, может быть полезно загружать View, когда вы открываете буфер:

```shell
autocmd BufWinEnter *.txt silent loadview
```

Теперь вам не нужно беспокоиться о создании и загрузке View, когда вы работаете с `txt` файлами. Имейте в виду, что со временем ваш `~/.vim/view` может начать накапливать файлы View. Хорошо бы очищать его раз в несколько месяцев.

## Сессии

Если View сохраняет настройки окна, то Сессия сохраняет информацию обо всех окнах (включая макет).

### Создание новой сессии

Предположим, вы работаете с этими 3 файлами в проекте `foobarbaz`:

Внутри `foo.txt`:

```shell
foo1
foo2
foo3
foo4
foo5
foo6
foo7
foo8
foo9
foo10
```

Внутри `bar.txt`:

```shell
bar1
bar2
bar3
bar4
bar5
bar6
bar7
bar8
bar9
bar10
```

Внутри `baz.txt`:

```shell
baz1
baz2
baz3
baz4
baz5
baz6
baz7
baz8
baz9
baz10
```

Теперь предположим, что вы разделили свои окна с помощью `:split` и `:vsplit`. Чтобы сохранить этот вид, вам нужно сохранить Сессию. Запустите:

```shell
:mksession
```

В отличие от `mkview`, который по умолчанию сохраняет в `~/.vim/view`, `mksession` сохраняет файл Сессии (`Session.vim`) в текущем каталоге. Посмотрите файл, если вам интересно, что внутри.

Если вы хотите сохранить файл Сессии в другом месте, вы можете передать аргумент команде `mksession`:

```shell
:mksession ~/some/where/else.vim
```

Если вы хотите перезаписать существующий файл Сессии, вызовите команду с `!` (`:mksession! ~/some/where/else.vim`).

### Загрузка сессии

Чтобы загрузить Сессию, выполните:

```shell
:source Session.vim
```

Теперь Vim выглядит так, как вы его оставили, включая разделенные окна! В качестве альтернативы вы также можете загрузить файл Сессии из терминала:

```shell
vim -S Session.vim
```

### Настройка атрибутов сессии

Вы можете настроить атрибуты, которые сохраняет Сессия. Чтобы увидеть, что в настоящее время сохраняется, выполните:

```shell
:set sessionoptions?
```

У меня указано:

```shell
blank,buffers,curdir,folds,help,tabpages,winsize,terminal
```

Если вы не хотите сохранять `terminal`, когда сохраняете Сессию, удалите его из параметров сессии. Запустите:

```shell
:set sessionoptions-=terminal
```

Если вы хотите добавить `options`, когда сохраняете Сессию, выполните:

```shell
:set sessionoptions+=options
```

Вот некоторые атрибуты, которые может хранить `sessionoptions`:
- `blank` сохраняет пустые окна
- `buffers` сохраняет буферы
- `folds` сохраняет свертки
- `globals` сохраняет глобальные переменные (должны начинаться с заглавной буквы и содержать хотя бы одну строчную букву)
- `options` сохраняет опции и сопоставления
- `resize` сохраняет строки и столбцы окна
- `winpos` сохраняет положение окна
- `winsize` сохраняет размеры окон
- `tabpages` сохраняет вкладки
- `unix` сохраняет файлы в формате Unix

Для полного списка посмотрите `:h 'sessionoptions'`.

Сессия — это полезный инструмент для сохранения внешних атрибутов вашего проекта. Однако некоторые внутренние атрибуты не сохраняются Сессией, такие как локальные метки, регистры, истории и т. д. Чтобы сохранить их, вам нужно использовать Viminfo!

## Viminfo

Если вы заметили, после того как вы скопировали слово в регистр a и вышли из Vim, в следующий раз, когда вы откроете Vim, у вас все еще будет этот текст, сохраненный в регистре a. Это на самом деле работа Viminfo. Без него Vim не будет помнить регистр после того, как вы закроете Vim.

Если вы используете Vim 8 или выше, Vim по умолчанию включает Viminfo, так что вы, возможно, использовали Viminfo все это время, не зная об этом!

Вы можете спросить: "Что сохраняет Viminfo? Чем он отличается от Сессии?"

Чтобы использовать Viminfo, сначала вам нужно, чтобы функция `+viminfo` была доступна (`:version`). Viminfo сохраняет:
- Историю командной строки.
- Историю строк поиска.
- Историю строк ввода.
- Содержимое непустых регистров.
- Метки для нескольких файлов.
- Метки файлов, указывающие на местоположения в файлах.
- Последний шаблон поиска / замены (для 'n' и '&').
- Список буферов.
- Глобальные переменные.

В общем, Сессия сохраняет "внешние" атрибуты, а Viminfo — "внутренние" атрибуты.

В отличие от Сессии, где вы можете иметь один файл Сессии на проект, вы обычно будете использовать один файл Viminfo на компьютер. Viminfo не привязан к проекту.

По умолчанию расположение Viminfo для Unix — это `$HOME/.viminfo` (`~/.viminfo`). Если вы используете другую ОС, ваше расположение Viminfo может быть другим. Посмотрите `:h viminfo-file-name`. Каждый раз, когда вы вносите "внутренние" изменения, такие как копирование текста в регистр, Vim автоматически обновляет файл Viminfo.

*Убедитесь, что у вас установлена опция `nocompatible` (`set nocompatible`), иначе ваш Viminfo не будет работать.*

### Запись и чтение Viminfo

Хотя вы будете использовать только один файл Viminfo, вы можете создать несколько файлов Viminfo. Чтобы записать файл Viminfo, используйте команду `:wviminfo` (`:wv` для краткости).

```shell
:wv ~/.viminfo_extra
```

Чтобы перезаписать существующий файл Viminfo, добавьте восклицательный знак к команде `wv`:

```shell
:wv! ~/.viminfo_extra
```

По умолчанию Vim будет читать из файла `~/.viminfo`. Чтобы прочитать из другого файла Viminfo, выполните `:rviminfo`, или `:rv` для краткости:

```shell
:rv ~/.viminfo_extra
```

Чтобы запустить Vim с другим файлом Viminfo из терминала, используйте флаг `i`:

```shell
vim -i viminfo_extra
```

Если вы используете Vim для разных задач, таких как кодирование и написание, вы можете создать Viminfo, оптимизированный для написания, и другой для кодирования.

```shell
vim -i viminfo_writing

vim -i viminfo_coding
```

### Запуск Vim без Viminfo

Чтобы запустить Vim без Viminfo, вы можете выполнить из терминала:

```shell
vim -i NONE
```

Чтобы сделать это постоянным, вы можете добавить это в ваш vimrc файл:

```shell
set viminfo="NONE"
```

### Настройка атрибутов Viminfo

Аналогично `viewoptions` и `sessionoptions`, вы можете указать, какие атрибуты сохранять с помощью опции `viminfo`. Запустите:

```shell
:set viminfo?
```

Вы получите:

```shell
!,'100,<50,s10,h
```

Это выглядит запутанно. Давайте разберем это:
- `!` сохраняет глобальные переменные, которые начинаются с заглавной буквы и не содержат строчных букв. Напоминаем, что `g:` указывает на глобальную переменную. Например, если в какой-то момент вы написали присваивание `let g:FOO = "foo"`, Viminfo сохранит глобальную переменную `FOO`. Однако если вы сделали `let g:Foo = "foo"`, Viminfo не сохранит эту глобальную переменную, потому что она содержит строчные буквы. Без `!` Vim не сохранит эти глобальные переменные.
- `'100` представляет метки. В этом случае Viminfo сохранит локальные метки (a-z) последних 100 файлов. Имейте в виду, что если вы скажете Viminfo сохранить слишком много файлов, Vim может начать замедляться. 1000 — хорошее число для хранения.
- `<50` говорит Viminfo, сколько максимальных строк сохранять для каждого регистра (50 в этом случае). Если я скопирую 100 строк текста в регистр a (`"ay99j`) и закрою Vim, в следующий раз, когда я открою Vim и вставлю из регистра a (`"ap`), Vim вставит только 50 строк максимум. Если вы не укажете максимальное количество строк, *все* строки будут сохранены. Если вы укажете 0, ничего не будет сохранено.
- `s10` устанавливает лимит размера (в кб) для регистра. В этом случае любой регистр размером более 10 кб будет исключен.
- `h` отключает подсветку (от `hlsearch`) при запуске Vim.

Существуют и другие параметры, которые вы можете указать. Чтобы узнать больше, посмотрите `:h 'viminfo'`.
## Использование представлений, сессий и Viminfo разумным образом

Vim имеет представления, сессии и Viminfo для создания снимков вашей среды Vim на разных уровнях. Для микро проектов используйте представления. Для более крупных проектов используйте сессии. Вам следует уделить время, чтобы ознакомиться со всеми опциями, которые предлагают представления, сессии и Viminfo.

Создайте свое собственное представление, сессию и Viminfo для вашего собственного стиля редактирования. Если вам когда-либо понадобится использовать Vim вне вашего компьютера, вы можете просто загрузить свои настройки, и вы сразу почувствуете себя как дома!