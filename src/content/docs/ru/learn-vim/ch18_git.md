---
description: В этом разделе вы узнаете, как интегрировать Vim и Git, включая использование
  команды vimdiff для сравнения файлов.
title: Ch18. Git
---

Vim и git — это два отличных инструмента для разных задач. Git — это инструмент контроля версий. Vim — это текстовый редактор.

В этой главе вы узнаете о различных способах интеграции Vim и git.

## Сравнение

Напомним, в предыдущей главе вы можете запустить команду `vimdiff`, чтобы показать различия между несколькими файлами.

Предположим, у вас есть два файла, `file1.txt` и `file2.txt`.

Внутри `file1.txt`:

```shell
блинчики
вафли
яблоки

молоко
яблочный сок

йогурт
```

Внутри `file2.txt`:

```shell
блинчики
вафли
апельсины

молоко
апельсиновый сок

йогурт
```

Чтобы увидеть различия между обоими файлами, выполните:

```shell
vimdiff file1.txt file2.txt
```

В качестве альтернативы вы можете выполнить:

```shell
vim -d file1.txt file2.txt
```

`vimdiff` отображает два буфера рядом. Слева находится `file1.txt`, а справа — `file2.txt`. Первые различия (яблоки и апельсины) выделены на обеих строках.

Предположим, вы хотите, чтобы второй буфер содержал яблоки, а не апельсины. Чтобы перенести содержимое из вашей текущей позиции (вы находитесь в `file1.txt`) в `file2.txt`, сначала перейдите к следующему различию с помощью `]c` (чтобы перейти к предыдущему окну различий, используйте `[c`). Курсор теперь должен быть на яблоках. Выполните `:diffput`. Оба файла теперь должны содержать яблоки.

Если вам нужно перенести текст из другого буфера (апельсиновый сок, `file2.txt`), чтобы заменить текст в текущем буфере (яблочный сок, `file1.txt`), с курсором все еще в окне `file1.txt`, сначала перейдите к следующему различию с помощью `]c`. Ваш курсор теперь должен быть на яблочном соке. Выполните `:diffget`, чтобы получить апельсиновый сок из другого буфера и заменить яблочный сок в нашем буфере.

`:diffput` *выводит* текст из текущего буфера в другой буфер. `:diffget` *получает* текст из другого буфера в текущий буфер.

Если у вас есть несколько буферов, вы можете выполнить `:diffput fileN.txt` и `:diffget fileN.txt`, чтобы нацелиться на буфер fileN.

## Vim как инструмент слияния

> "Я люблю решать конфликты слияния!" - Никто

Я не знаю никого, кто любит решать конфликты слияния. Тем не менее, они неизбежны. В этом разделе вы узнаете, как использовать Vim в качестве инструмента разрешения конфликтов слияния.

Сначала измените инструмент слияния по умолчанию на `vimdiff`, выполнив:

```shell
git config merge.tool vimdiff
git config merge.conflictstyle diff3
git config mergetool.prompt false
```

В качестве альтернативы вы можете изменить `~/.gitconfig` напрямую (по умолчанию он должен находиться в корне, но у вас он может находиться в другом месте). Команды выше должны изменить ваш gitconfig так, чтобы он выглядел как настройки ниже, если вы их еще не выполняли, вы также можете вручную отредактировать ваш gitconfig.

```shell
[core]
  editor = vim
[merge]
  tool = vimdiff
  conflictstyle = diff3
[difftool]
  prompt = false
```

Давайте создадим фиктивный конфликт слияния, чтобы протестировать это. Создайте директорию `/food` и сделайте ее репозиторием git:

```shell
git init
```

Добавьте файл `breakfast.txt`. Внутри:

```shell
блинчики
вафли
апельсины
```

Добавьте файл и зафиксируйте его:

```shell
git add .
git commit -m "Первоначальный коммит завтрака"
```

Затем создайте новую ветку и назовите ее веткой яблок:

```shell
git checkout -b apples
```

Измените `breakfast.txt`:

```shell
блинчики
вафли
яблоки
```

Сохраните файл, затем добавьте и зафиксируйте изменения:

```shell
git add .
git commit -m "Яблоки, а не апельсины"
```

Отлично. Теперь у вас есть апельсины в основной ветке и яблоки в ветке яблок. Давайте вернемся в основную ветку:

```shell
git checkout master
```

Внутри `breakfast.txt` вы должны увидеть базовый текст, апельсины. Давайте изменим его на виноград, потому что они сейчас в сезоне:

```shell
блинчики
вафли
виноград
```

Сохраните, добавьте и зафиксируйте:

```shell
git add .
git commit -m "Виноград, а не апельсины"
```

Теперь вы готовы слить ветку яблок в основную ветку:

```shell
git merge apples
```

Вы должны увидеть ошибку:

```shell
Авто-слияние breakfast.txt
КОНФЛИКТ (содержимое): Конфликт слияния в breakfast.txt
Автоматическое слияние не удалось; исправьте конфликты и затем зафиксируйте результат.
```

Конфликт, отлично! Давайте разрешим конфликт, используя наш новый настроенный `mergetool`. Выполните:

```shell
git mergetool
```

Vim отображает четыре окна. Обратите внимание на верхние три:

- `LOCAL` содержит `виноград`. Это изменение в "локальном", в что вы сливаете.
- `BASE` содержит `апельсины`. Это общий предок между `LOCAL` и `REMOTE`, чтобы сравнить, как они расходятся.
- `REMOTE` содержит `яблоки`. Это то, что сливается.

Внизу (четвертое окно) вы видите:

```shell
блинчики
вафли
<<<<<<< HEAD
виноград
||||||| db63958
апельсины
=======
яблоки
>>>>>>> apples
```

Четвертое окно содержит тексты конфликтов слияния. С этой настройкой легче увидеть, какое изменение есть в каждой среде. Вы можете видеть содержимое из `LOCAL`, `BASE` и `REMOTE` одновременно.

Ваш курсор должен находиться в четвертом окне, на выделенной области. Чтобы получить изменение из `LOCAL` (виноград), выполните `:diffget LOCAL`. Чтобы получить изменение из `BASE` (апельсины), выполните `:diffget BASE`, а чтобы получить изменение из `REMOTE` (яблоки), выполните `:diffget REMOTE`.

В этом случае давайте получим изменение из `LOCAL`. Выполните `:diffget LOCAL`. Четвертое окно теперь будет содержать виноград. Сохраните и выйдите из всех файлов (`:wqall`), когда закончите. Это было не так уж плохо, верно?

Если вы заметили, у вас также есть файл `breakfast.txt.orig`. Git создает резервный файл на случай, если что-то пойдет не так. Если вы не хотите, чтобы git создавал резервную копию во время слияния, выполните:

```shell
git config --global mergetool.keepBackup false
```

## Git внутри Vim

Vim не имеет встроенной функции git. Один из способов выполнения git-команд из Vim — использовать оператор bang, `!`, в режиме командной строки.

Любую git-команду можно выполнить с помощью `!`:

```shell
:!git status
:!git commit
:!git diff
:!git push origin master
```

Вы также можете использовать конвенции Vim `%` (текущий буфер) или `#` (другой буфер):

```shell
:!git add %         " git add текущий файл
:!git checkout #    " git checkout другого файла
```

Одним из трюков Vim, который вы можете использовать для добавления нескольких файлов в разных окнах Vim, является выполнение:

```shell
:windo !git add %
```

Затем сделайте коммит:

```shell
:!git commit "Только что добавил все в моем окне Vim, круто"
```

Команда `windo` — это одна из команд "выполнить" Vim, аналогичная `argdo`, которую вы видели ранее. `windo` выполняет команду в каждом окне.

В качестве альтернативы вы также можете использовать `bufdo !git add %`, чтобы добавить все буферы, или `argdo !git add %`, чтобы добавить все аргументы файлов, в зависимости от вашего рабочего процесса.

## Плагины

Существует множество плагинов Vim для поддержки git. Ниже приведен список некоторых популярных плагинов, связанных с git для Vim (возможно, их больше на момент, когда вы это читаете):

- [vim-gitgutter](https://github.com/airblade/vim-gitgutter)
- [vim-signify](https://github.com/mhinz/vim-signify)
- [vim-fugitive](https://github.com/tpope/vim-fugitive)
- [gv.vim](https://github.com/junegunn/gv.vim)
- [vimagit](https://github.com/jreybert/vimagit)
- [vim-twiggy](https://github.com/sodapopcan/vim-twiggy)
- [rhubarb](https://github.com/tpope/vim-rhubarb)

Одним из самых популярных является vim-fugitive. В оставшейся части главы я расскажу о нескольких рабочих процессах git с использованием этого плагина.

## Vim-fugitive

Плагин vim-fugitive позволяет вам выполнять git CLI, не покидая редактор Vim. Вы обнаружите, что некоторые команды лучше выполнять из Vim.

Чтобы начать, установите vim-fugitive с помощью менеджера плагинов Vim ([vim-plug](https://github.com/junegunn/vim-plug), [vundle](https://github.com/VundleVim/Vundle.vim), [dein.vim](https://github.com/Shougo/dein.vim) и т. д.).

## Статус Git

Когда вы выполняете команду `:Git` без каких-либо параметров, vim-fugitive отображает окно сводки git. Оно показывает неотслеживаемые, неиндексированные и индексированные файлы. Находясь в этом режиме "`git status`", вы можете делать несколько вещей:
- `Ctrl-N` / `Ctrl-P`, чтобы перемещаться вверх или вниз по списку файлов.
- `-`, чтобы индексировать или отменить индексацию имени файла под курсором.
- `s`, чтобы индексировать имя файла под курсором.
- `u`, чтобы отменить индексацию имени файла под курсором.
- `>` / `<`, чтобы отобразить или скрыть встроенное различие имени файла под курсором.

Для получения дополнительной информации смотрите `:h fugitive-staging-maps`.

## Git Blame

Когда вы выполняете команду `:Git blame` из текущего файла, vim-fugitive отображает окно с разделением blame. Это может быть полезно для нахождения человека, ответственного за написание этой проблемной строки кода, чтобы вы могли на него / нее накричать (шутка).

Некоторые вещи, которые вы можете делать в этом режиме `"git blame"`:
- `q`, чтобы закрыть окно blame.
- `A`, чтобы изменить размер колонки автора.
- `C`, чтобы изменить размер колонки коммита.
- `D`, чтобы изменить размер колонки даты / времени.

Для получения дополнительной информации смотрите `:h :Git_blame`.

## Gdiffsplit

Когда вы выполняете команду `:Gdiffsplit`, vim-fugitive запускает `vimdiff` последних изменений текущего файла по сравнению с индексом или рабочим деревом. Если вы выполните `:Gdiffsplit <commit>`, vim-fugitive запустит `vimdiff` по сравнению с этим файлом внутри `<commit>`.

Поскольку вы находитесь в режиме `vimdiff`, вы можете *получить* или *вывести* различие с помощью `:diffput` и `:diffget`.

## Gwrite и Gread

Когда вы выполняете команду `:Gwrite` в файле после внесения изменений, vim-fugitive индексирует изменения. Это похоже на выполнение `git add <текущий-файл>`.

Когда вы выполняете команду `:Gread` в файле после внесения изменений, vim-fugitive восстанавливает файл в состояние до изменений. Это похоже на выполнение `git checkout <текущий-файл>`. Одно из преимуществ выполнения `:Gread` заключается в том, что действие можно отменить. Если после выполнения `:Gread` вы передумали и хотите сохранить старое изменение, вы можете просто выполнить отмену (`u`), и Vim отменит действие `:Gread`. Это было бы невозможно, если бы вы выполнили `git checkout <текущий-файл>` из CLI.

## Gclog

Когда вы выполняете команду `:Gclog`, vim-fugitive отображает историю коммитов. Это похоже на выполнение команды `git log`. Vim-fugitive использует quickfix Vim для этого, поэтому вы можете использовать `:cnext` и `:cprevious`, чтобы перейти к следующей или предыдущей информации о логе. Вы можете открыть и закрыть список логов с помощью `:copen` и `:cclose`.

Находясь в этом режиме `"git log"`, вы можете сделать две вещи:
- Просмотреть дерево.
- Посетить родителя (предыдущий коммит).

Вы можете передавать аргументы в `:Gclog`, как в команде `git log`. Если у вашего проекта длинная история коммитов и вам нужно просмотреть только последние три коммита, вы можете выполнить `:Gclog -3`. Если вам нужно отфильтровать по дате коммитера, вы можете выполнить что-то вроде `:Gclog --after="1 января" --before="14 марта"`.

## Больше о Vim-fugitive

Это только несколько примеров того, что может делать vim-fugitive. Чтобы узнать больше о vim-fugitive, посмотрите `:h fugitive.txt`. Большинство популярных команд git, вероятно, оптимизированы с помощью vim-fugitive. Вам просто нужно искать их в документации.

Если вы находитесь в одном из "специальных режимов" vim-fugitive (например, в режиме `:Git` или `:Git blame`) и хотите узнать, какие сочетания клавиш доступны, нажмите `g?`. Vim-fugitive отобразит соответствующее окно `:help` для режима, в котором вы находитесь. Здорово!
## Учите Vim и Git умным способом

Вы можете обнаружить, что vim-fugitive хорошо дополняет ваш рабочий процесс (или нет). Тем не менее, я настоятельно рекомендую вам ознакомиться со всеми плагинами, перечисленными выше. Возможно, есть и другие, которые я не упомянул. Попробуйте их.

Очевидный способ улучшить интеграцию Vim и git — это больше читать о git. Git сам по себе — это обширная тема, и я показываю только ее часть. С этим давайте *начнем git* (простите за каламбур) и поговорим о том, как использовать Vim для компиляции вашего кода!