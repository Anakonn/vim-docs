---
description: В этом документе вы узнаете, как использовать свёртки в Vim для скрытия
  ненужного текста и улучшения восприятия файлов.
title: Ch17. Fold
---

Когда вы читаете файл, часто встречаются много нерелевантных текстов, которые мешают вам понять, что делает этот файл. Чтобы скрыть ненужный шум, используйте свёртки Vim.

В этой главе вы узнаете о различных способах сворачивания файла.

## Ручная свёртка

Представьте, что вы сворачиваете лист бумаги, чтобы скрыть некоторый текст. Сам текст не исчезает, он по-прежнему там. Свёртка Vim работает так же. Она сворачивает диапазон текста, скрывая его от отображения, не удаляя на самом деле.

Оператор свёртки — это `z` (когда бумага свернута, она имеет форму буквы z).

Предположим, у вас есть следующий текст:

```shell
Сверни меня
Держи меня
```

С курсором на первой строке введите `zfj`. Vim сворачивает обе строки в одну. Вы должны увидеть что-то вроде этого:

```shell
+-- 2 строки: Сверни меня -----
```

Вот разбор:
- `zf` — это оператор свёртки.
- `j` — это движение для оператора свёртки.

Вы можете открыть свернутый текст с помощью `zo`. Чтобы закрыть свёртку, используйте `zc`.

Свёртка — это оператор, поэтому он следует грамматическому правилу (`глагол + существительное`). Вы можете передать оператор свёртки с движением или текстовым объектом. Чтобы свернуть внутренний абзац, выполните `zfip`. Чтобы свернуть до конца файла, выполните `zfG`. Чтобы свернуть тексты между `{` и `}`, выполните `zfa{`.

Вы можете сворачивать из визуального режима. Выделите область, которую хотите свернуть (`v`, `V` или `Ctrl-v`), затем выполните `zf`.

Вы можете выполнить свёртку из командного режима с помощью команды `:fold`. Чтобы свернуть текущую строку и строку после неё, выполните:

```shell
:,+1fold
```

`,+1` — это диапазон. Если вы не передадите параметры диапазону, он по умолчанию будет равен текущей строке. `+1` — это индикатор диапазона для следующей строки. Чтобы свернуть строки с 5 по 10, выполните `:5,10fold`. Чтобы свернуть с текущей позиции до конца строки, выполните `:,$fold`.

Существует множество других команд для свёртки и развертывания. Я нахожу их слишком много, чтобы запомнить, когда только начинаю. Наиболее полезные из них:
- `zR` для открытия всех свёрток.
- `zM` для закрытия всех свёрток.
- `za` для переключения состояния свёртки.

Вы можете выполнять `zR` и `zM` на любой строке, но `za` работает только тогда, когда вы находитесь на свернутой/развернутой строке. Чтобы узнать больше команд свёртки, ознакомьтесь с `:h fold-commands`.

## Разные методы свёртки

В предыдущем разделе рассмотрена ручная свёртка Vim. В Vim есть шесть различных методов свёртки:
1. Ручная
2. По отступам
3. По выражению
4. По синтаксису
5. По различиям
6. По маркерам

Чтобы увидеть, какой метод свёртки вы используете в данный момент, выполните `:set foldmethod?`. По умолчанию Vim использует метод `manual`.

В остальной части главы вы узнаете о других пяти методах свёртки. Давайте начнём с свёртки по отступам.

## Свёртка по отступам

Чтобы использовать свёртку по отступам, измените `'foldmethod'` на indent:

```shell
:set foldmethod=indent
```

Предположим, что у вас есть текст:

```shell
Один
  Два
  Два снова
```

Если вы выполните `:set foldmethod=indent`, вы увидите:

```shell
Один
+-- 2 строки: Два -----
```

При свёртке по отступам Vim смотрит, сколько пробелов в начале каждой строки и сравнивает это с опцией `'shiftwidth'`, чтобы определить, можно ли её свернуть. `'shiftwidth'` возвращает количество пробелов, необходимых для каждого шага отступа. Если вы выполните:

```shell
:set shiftwidth?
```

По умолчанию значение `'shiftwidth'` в Vim равно 2. В приведённом выше тексте между началом строки и текстом "Два" и "Два снова" два пробела. Когда Vim видит количество пробелов и что значение `'shiftwidth'` равно 2, он считает, что эта строка имеет уровень отступа свёртки один.

Предположим, на этот раз у вас только один пробел между началом строки и текстом:

```shell
Один
 Два
 Два снова
```

Сейчас, если вы выполните `:set foldmethod=indent`, Vim не свернёт отступленную строку, потому что на каждой строке недостаточно пробелов. Один пробел не считается отступом. Однако, если вы измените `'shiftwidth'` на 1:

```shell
:set shiftwidth=1
```

Текст теперь можно свернуть. Теперь он считается отступом.

Восстановите `shiftwidth` обратно на 2 и пробелы между текстами снова на два. Кроме того, добавьте два дополнительных текста:

```shell
Один
  Два
  Два снова
    Три
    Три снова
```

Выполните свёртку (`zM`), вы увидите:

```shell
Один
+-- 4 строки: Два -----
```

Разверните свернутые строки (`zR`), затем установите курсор на "Три" и переключите состояние свёртки текста (`za`):

```shell
Один
  Два
  Два снова
+-- 2 строки: Три -----
```

Что это? Свёртка внутри свёртки?

Вложенные свёртки допустимы. Текст "Два" и "Два снова" имеют уровень свёртки один. Текст "Три" и "Три снова" имеют уровень свёртки два. Если у вас есть сворачиваемый текст с более высоким уровнем свёртки внутри сворачиваемого текста, у вас будет несколько слоёв свёртки.

## Свёртка по выражению

Свёртка по выражению позволяет вам определить выражение для сопоставления со свёрткой. После того, как вы определите выражения свёртки, Vim сканирует каждую строку на значение `'foldexpr'`. Это переменная, которую вам нужно настроить, чтобы вернуть соответствующее значение. Если `'foldexpr'` возвращает 0, то строка не сворачивается. Если она возвращает 1, то эта строка имеет уровень свёртки 1. Если она возвращает 2, то эта строка имеет уровень свёртки 2. Существуют и другие значения, помимо целых чисел, но я не буду их рассматривать. Если вам интересно, ознакомьтесь с `:h fold-expr`.

Сначала давайте изменим метод свёртки:

```shell
:set foldmethod=expr
```

Предположим, у вас есть список завтраков, и вы хотите свернуть все блюда, начинающиеся на "p":

```shell
пончик
блинчик
поп-тарт
протеиновый батончик
лосось
яичница
```

Затем измените `foldexpr`, чтобы захватить выражения, начинающиеся на "p":

```shell
:set foldexpr=getline(v:lnum)[0]==\\"p\\"
```

Выражение выше выглядит сложно. Давайте разберём его:
- `:set foldexpr` настраивает опцию `'foldexpr'` для принятия пользовательского выражения.
- `getline()` — это функция Vimscript, которая возвращает содержимое любой заданной строки. Если вы выполните `:echo getline(5)`, она вернёт содержимое пятой строки.
- `v:lnum` — это специальная переменная Vim для выражения `'foldexpr'`. Vim сканирует каждую строку и в этот момент сохраняет номер каждой строки в переменной `v:lnum`. В пятой строке `v:lnum` имеет значение 5. В десятой строке `v:lnum` имеет значение 10.
- `[0]` в контексте `getline(v:lnum)[0]` — это первый символ каждой строки. Когда Vim сканирует строку, `getline(v:lnum)` возвращает содержимое каждой строки. `getline(v:lnum)[0]` возвращает первый символ каждой строки. В первой строке нашего списка, "пончик", `getline(v:lnum)[0]` возвращает "п". Во второй строке нашего списка, "блинчик", `getline(v:lnum)[0]` возвращает "б".
- `==\\"p\\"` — это вторая половина выражения равенства. Она проверяет, равно ли выражение, которое вы только что оценили, "p". Если это правда, возвращает 1. Если это ложь, возвращает 0. В Vim 1 — это истинное значение, а 0 — ложное. Таким образом, на строках, которые начинаются с "p", возвращается 1. Напомню, если `'foldexpr'` имеет значение 1, то это уровень свёртки 1.

После выполнения этого выражения вы должны увидеть:

```shell
пончик
+-- 3 строки: блинчик -----
лосось
яичница
```

## Свёртка по синтаксису

Свёртка по синтаксису определяется подсветкой синтаксиса языка. Если вы используете плагин синтаксиса языка, такой как [vim-polyglot](https://github.com/sheerun/vim-polyglot), свёртка по синтаксису будет работать сразу. Просто измените метод свёртки на синтаксис:

```shell
:set foldmethod=syntax
```

Предположим, вы редактируете файл JavaScript и у вас установлен vim-polyglot. Если у вас есть массив, как следующий:

```shell
const nums = [
  один,
  два,
  три,
  четыре
]
```

Он будет свернут с помощью свёртки по синтаксису. Когда вы определяете подсветку синтаксиса для конкретного языка (обычно внутри директории `syntax/`), вы можете добавить атрибут `fold`, чтобы сделать его сворачиваемым. Ниже приведён фрагмент из файла синтаксиса JavaScript vim-polyglot. Обратите внимание на ключевое слово `fold` в конце.

```shell
syntax region  jsBracket                      matchgroup=jsBrackets            start=/\[/ end=/\]/ contains=@jsExpression,jsSpreadExpression extend fold
```

Этот гид не будет охватывать функцию `syntax`. Если вам интересно, ознакомьтесь с `:h syntax.txt`.

## Свёртка по различиям

Vim может выполнять процедуру различий для сравнения двух или более файлов.

Если у вас есть `file1.txt`:

```shell
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
```

И `file2.txt`:

```shell
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
emacs — это нормально
```

Выполните `vimdiff file1.txt file2.txt`:

```shell
+-- 3 строки: vim — это здорово -----
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
vim — это здорово
[vim — это здорово] / [emacs — это нормально]
```

Vim автоматически сворачивает некоторые из идентичных строк. Когда вы выполняете команду `vimdiff`, Vim автоматически использует `foldmethod=diff`. Если вы выполните `:set foldmethod?`, он вернёт `diff`.

## Свёртка по маркерам

Чтобы использовать свёртку по маркерам, выполните:

```shell
:set foldmethod=marker
```

Предположим, у вас есть текст:

```shell
Привет

{{{
мир
vim
}}}
```

Выполните `zM`, вы увидите:

```shell
привет

+-- 4 строки: -----
```

Vim видит `{{{` и `}}}` как индикаторы свёртки и сворачивает тексты между ними. При свёртке по маркерам Vim ищет специальные маркеры, определённые опцией `'foldmarker'`, чтобы обозначить области свёртки. Чтобы увидеть, какие маркеры использует Vim, выполните:

```shell
:set foldmarker?
```

По умолчанию Vim использует `{{{` и `}}}` в качестве индикаторов. Если вы хотите изменить индикатор на другие тексты, такие как "coffee1" и "coffee2":

```shell
:set foldmarker=coffee1,coffee2
```

Если у вас есть текст:

```shell
привет

coffee1
мир
vim
coffee2
```

Теперь Vim использует `coffee1` и `coffee2` в качестве новых маркеров свёртки. К слову, индикатор должен быть буквальной строкой и не может быть регулярным выражением.

## Сохранение свёрток

Вы теряете всю информацию о свёртках, когда закрываете сессию Vim. Если у вас есть этот файл, `count.txt`:

```shell
один
два
три
четыре
пять
```

Затем выполните ручную свёртку с третьей строки вниз (`:3,$fold`):

```shell
один
два
+-- 3 строки: три ---
```

Когда вы выходите из Vim и повторно открываете `count.txt`, свёртки больше нет!

Чтобы сохранить свёртки, после свёртки выполните:

```shell
:mkview
```

Затем, когда вы откроете `count.txt`, выполните:

```shell
:loadview
```

Ваши свёртки будут восстановлены. Однако вам нужно вручную выполнить `mkview` и `loadview`. Я знаю, что однажды я забуду выполнить `mkview` перед закрытием файла и потеряю все свёртки. Как можно автоматизировать этот процесс?

Чтобы автоматически выполнять `mkview`, когда вы закрываете файл `.txt`, и выполнять `loadview`, когда вы открываете файл `.txt`, добавьте это в ваш vimrc:

```shell
autocmd BufWinLeave *.txt mkview
autocmd BufWinEnter *.txt silent loadview
```

Напомню, что `autocmd` используется для выполнения команды при срабатывании события. Два события здесь:
- `BufWinLeave` для момента, когда вы удаляете буфер из окна.
- `BufWinEnter` для момента, когда вы загружаете буфер в окно.

Теперь после того, как вы свернули текст внутри файла `.txt` и вышли из Vim, в следующий раз, когда вы откроете этот файл, информация о свёртках будет восстановлена.

По умолчанию Vim сохраняет информацию о свёртках, выполняя `mkview` внутри `~/.vim/view` для системы Unix. Для получения дополнительной информации ознакомьтесь с `:h 'viewdir'`.
## Учитесь сворачивать умным способом

Когда я впервые начал использовать Vim, я пренебрегал изучением сворачивания, потому что не думал, что это полезно. Однако, чем больше я кодирую, тем полезнее мне кажется сворачивание. Стратегически расположенные сворачивания могут дать вам лучшее представление о структуре текста, как содержание книги.

Когда вы учитесь сворачивать, начните с ручного сворачивания, потому что его можно использовать на ходу. Затем постепенно изучайте различные приемы для выполнения отступов и сворачивания с помощью маркеров. Наконец, научитесь делать синтаксическое и выраженческое сворачивание. Вы даже можете использовать последние два для написания собственных плагинов Vim.