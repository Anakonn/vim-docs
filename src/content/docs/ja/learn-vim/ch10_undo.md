---
description: VimのUndoシステムを学び、基本的なUndo・Redo操作や、異なるテキスト状態へのアクセス方法を習得しましょう。
title: Ch10. Undo
---

私たちは皆、さまざまなタイピングミスをします。だからこそ、元に戻す機能は現代のソフトウェアにおいて不可欠な機能です。Vimの元に戻すシステムは、単純なミスを元に戻したりやり直したりするだけでなく、さまざまなテキストの状態にアクセスすることもでき、これまでに入力したすべてのテキストを制御できます。この章では、元に戻す方法、やり直す方法、元に戻しのブランチをナビゲートする方法、元に戻しを持続させる方法、そして時間を超えて移動する方法を学びます。

## 元に戻す、やり直す、そしてUNDO

基本的な元に戻す操作を行うには、`u`を使用するか、`:undo`を実行します。

以下のテキストがあるとします（「one」の下の空行に注意）：

```shell
one

```

次に、別のテキストを追加します：

```shell
one
two
```

`u`を押すと、Vimは「two」というテキストを元に戻します。

Vimはどのくらい元に戻すかをどうやって知るのでしょうか？Vimは、ドットコマンドの変更に似た単一の「変更」を一度に元に戻します（ドットコマンドとは異なり、コマンドラインコマンドも変更としてカウントされます）。

最後の変更をやり直すには、`Ctrl-R`を押すか、`:redo`を実行します。上記のテキストで「two」を削除した後、`Ctrl-R`を実行すると、削除されたテキストが戻ります。

Vimには、`U`を使って実行できるUNDOもあります。これは最新の変更をすべて元に戻します。

`U`は`u`とどう違うのでしょうか？まず、`U`は最新の変更された行の*すべて*の変更を削除しますが、`u`は一度に一つの変更だけを削除します。第二に、`u`を行うことは変更としてカウントされませんが、`U`を行うことは変更としてカウントされます。

この例に戻ります：

```shell
one
two
```

二行目を「three」に変更します：

```shell
one
three
```

二行目を再度変更して「four」に置き換えます：

```shell
one
four
```

`u`を押すと「three」が表示されます。再度`u`を押すと「two」が表示されます。もし「four」というテキストがある状態で`u`を押す代わりに`U`を押していたら、次のようになります：

```shell
one

```

`U`はすべての中間変更をバイパスし、開始時の元の状態（空行）に戻ります。さらに、UNDOは実際にVimで新しい変更を作成するため、あなたは自分のUNDOを元に戻すことができます。`U`の後に`U`を押すと、それ自身を元に戻します。`U`を押して、再度`U`を押して、また`U`を押すことができます。そうすると、同じ二つのテキスト状態が交互に切り替わります。

私は個人的に`U`を使用しません。なぜなら、元の状態を覚えておくのが難しいからです（私はそれを必要とすることはほとんどありません）。

Vimは、`undolevels`オプション変数で元に戻すことができる最大回数を設定します。`:echo &undolevels`で確認できます。私の設定は1000です。あなたの設定を1000に変更するには、`:set undolevels=1000`を実行してください。好きな数値に設定してください。

## ブロックを壊す

先ほど、`u`がドットコマンドの変更に似た単一の「変更」を元に戻すことを述べました：挿入モードに入ってから退出するまでに挿入されたテキストは変更としてカウントされます。

`ione two three<Esc>`と入力してから`u`を押すと、Vimは「one two three」というテキスト全体を削除します。これは短いテキストを書いた場合は大したことではありませんが、挿入モードセッション内でいくつかの段落を書いた後に間違いに気づいた場合はどうでしょうか？`u`を押すと、書いたすべてのテキストが削除されます。テキストの一部だけを削除するために`u`を押すことができれば便利ではないでしょうか？

幸いなことに、元に戻しブロックを壊すことができます。挿入モードで入力しているときに`Ctrl-G u`を押すと、元に戻しのブレークポイントが作成されます。たとえば、`ione <Ctrl-G u>two <Ctrl-G u>three<Esc>`と入力した場合、`u`を押すと「three」だけが失われます（もう一度`u`を押すと「two」が削除されます）。長いテキストを書くときは、`Ctrl-G u`を戦略的に使用してください。各文の終わり、二つの段落の間、または各コード行の後は、間違いを元に戻しやすくするための元に戻しブレークポイントを追加するための最適な場所です。

挿入モードで`Ctrl-W`（カーソルの前の単語を削除）や`Ctrl-U`（カーソルの前のすべてのテキストを削除）を使用してチャンクを削除する際に元に戻しブレークポイントを作成することも便利です。友人は次のマッピングを使用することを提案しました：

```shell
inoremap <c-u> <c-g>u<c-u>
inoremap <c-w> <c-g>u<c-w>
```

これを使えば、削除したテキストを簡単に回復できます。

## 元に戻しツリー

Vimは、書かれたすべての変更を元に戻しツリーに保存します。新しい空のファイルを開始します。次に、新しいテキストを追加します：

```shell
one

```

新しいテキストを追加します：

```shell
one
two
```

一度元に戻します：

```shell
one

```

異なるテキストを追加します：

```shell
one
three
```

再度元に戻します：

```shell
one

```

そして、もう一つ異なるテキストを追加します：

```shell
one
four
```

今、元に戻すと、追加した「four」テキストが失われます：

```shell
one

```

さらにもう一度元に戻すと：

```shell

```

「one」テキストが失われます。ほとんどのテキストエディタでは、「two」と「three」のテキストを取り戻すことは不可能ですが、Vimではそうではありません！`g+`を押すと、テキスト「one」が戻ります：

```shell
one

```

再度`g+`を押すと、古い友達が現れます：

```shell
one
two
```

さらに続けましょう。再度`g+`を押します：

```shell
one
three
```

もう一度`g+`を押します：

```shell
one
four
```

Vimでは、`u`を押してから異なる変更を行うたびに、Vimは前の状態のテキストを「元に戻しブランチ」を作成して保存します。この例では、「two」と入力してから`u`を押し、「three」と入力したことで、テキスト「two」を含む状態を保存する葉ブランチが作成されました。その時点で、元に戻しツリーには少なくとも二つの葉ノードが含まれていました：テキスト「three」を含むメインノード（最も最近のもの）と、テキスト「two」を含む元に戻しブランチノードです。別の元に戻しを行い、「four」というテキストを入力した場合、三つのノードが存在します：テキスト「four」を含むメインノードと、テキスト「three」と「two」を含む二つのノードです。

各元に戻しツリーのノードを移動するには、`g+`を使用して新しい状態に移動し、`g-`を使用して古い状態に移動します。`u`、`Ctrl-R`、`g+`、および`g-`の違いは、`u`と`Ctrl-R`は元に戻しツリーの*メイン*ノードのみを移動するのに対し、`g+`と`g-`は元に戻しツリーの*すべて*のノードを移動することです。

元に戻しツリーは視覚化するのが簡単ではありません。私は[vim-mundo](https://github.com/simnalamburt/vim-mundo)プラグインがVimの元に戻しツリーを視覚化するのに非常に役立つと感じています。少し時間をかけて遊んでみてください。

## 永続的な元に戻し

Vimを起動し、ファイルを開いてすぐに`u`を押すと、Vimはおそらく「*すでに最古の変更にいます*」という警告を表示します。変更を行っていないため、元に戻すものはありません。

前回の編集セッションから元に戻しの履歴をロールオーバーするために、Vimは`undo`ファイルで元に戻しの履歴を保存できます。`:wundo`を使用します。

`mynumbers.txt`というファイルを作成します。次のように入力します：

```shell
one
```

次の行を入力します（各行が変更としてカウントされることを確認してください）：

```shell
one
two
```

もう一行入力します：

```shell
one
two
three
```

次に、`:wundo {my-undo-file}`を使用して元に戻しファイルを作成します。既存の元に戻しファイルを上書きする必要がある場合は、`wundo`の後に`!`を追加できます。

```shell
:wundo! mynumbers.undo
```

その後、Vimを終了します。

これで、あなたのディレクトリには`mynumbers.txt`と`mynumbers.undo`ファイルがあるはずです。再度`mynumbers.txt`を開き、`u`を押してみてください。できません。ファイルを開いてから変更を行っていないからです。今、`:rundo`を使用して元に戻しの履歴を読み込みます：

```shell
:rundo mynumbers.undo
```

今、`u`を押すと、Vimは「three」を削除します。再度`u`を押して「two」を削除します。まるでVimを閉じたことがなかったかのようです！

自動的に元に戻しを持続させたい場合、これをvimrcに追加することで実現できます：

```shell
set undodir=~/.vim/undo_dir
set undofile
```

上記の設定により、すべての元に戻しファイルが一つの中央ディレクトリ、`~/.vim`ディレクトリに配置されます。`undo_dir`という名前は任意です。`set undofile`は、Vimに`undofile`機能をオンにするよう指示します。デフォルトではオフになっています。これで、保存するたびにVimは自動的に`undo_dir`ディレクトリ内に関連するファイルを作成および更新します（実際に`~/.vim`内に`undo_dir`ディレクトリを作成してから実行してください）。

## タイムトラベル

タイムトラベルが存在しないと言う人は誰ですか？Vimは、`:earlier`コマンドラインコマンドを使用して過去のテキスト状態に移動できます。

次のテキストがあるとします：

```shell
one

```
その後、次のように追加します：

```shell
one
two
```

もし「two」を入力してから10秒未満であれば、次のようにして「two」が存在しなかった状態に戻ることができます：

```shell
:earlier 10s
```

`:undolist`を使用して、最後の変更がいつ行われたかを確認できます。`:earlier`は異なる引数も受け付けます：

```shell
:earlier 10s    10秒前の状態に移動
:earlier 10m    10分前の状態に移動
:earlier 10h    10時間前の状態に移動
:earlier 10d    10日前の状態に移動
```

さらに、`count`という通常の引数を受け付け、Vimに`count`回古い状態に移動するよう指示できます。たとえば、`:earlier 2`を実行すると、Vimは二つ前の古いテキスト状態に戻ります。これは`g-`を二回押すのと同じです。また、`:earlier 10f`を使用して、10回前の古いテキスト状態に移動することもできます。

同じ引数のセットが`:earlier`の対となる`:later`でも機能します：

```shell
:later 10s    10秒後の状態に移動
:later 10m    10分後の状態に移動
:later 10h    10時間後の状態に移動
:later 10d    10日後の状態に移動
:later 10     新しい状態に10回移動
:later 10f    10回後の状態に移動
```

## スマートな方法で元に戻しを学ぶ

`u`と`Ctrl-R`は、ミスを修正するための二つの不可欠なVimコマンドです。まずこれらを学びましょう。次に、時間引数を使用して`:earlier`と`:later`の使い方を学びます。その後、元に戻しツリーを理解するために時間をかけてください。[vim-mundo](https://github.com/simnalamburt/vim-mundo)プラグインは私にとって非常に役立ちました。この章のテキストに沿って入力し、各変更を行う際に元に戻しツリーを確認してください。それを理解すれば、元に戻しシステムを以前とは全く異なる視点で見ることができるようになります。

この章の前に、プロジェクトスペース内の任意のテキストを見つける方法を学びましたが、元に戻しを使うことで、今では任意のテキストを時間の次元で見つけることができるようになりました。あなたは今、書かれた場所と時間によって任意のテキストを検索できるようになりました。あなたはVimの遍在性を達成しました。