---
description: Vimのグローバルコマンドを使用して、複数行に対してコマンドラインコマンドを同時に実行する方法を学びます。
title: Ch13. the Global Command
---

これまでに、ドットコマンド（`.`）で最後の変更を繰り返す方法、マクロ（`q`）でアクションを再生する方法、レジスタ（`"`）にテキストを保存する方法を学びました。

この章では、グローバルコマンドを使用してコマンドラインコマンドを繰り返す方法を学びます。

## グローバルコマンドの概要

Vimのグローバルコマンドは、複数の行に対して同時にコマンドラインコマンドを実行するために使用されます。

ところで、「Exコマンド」という用語を聞いたことがあるかもしれません。このガイドでは、これらをコマンドラインコマンドと呼びます。Exコマンドとコマンドラインコマンドは同じです。どちらもコロン（`:`）で始まるコマンドです。前の章の置換コマンドはExコマンドの例でした。Exは、元々Exテキストエディタから来たためにそのように呼ばれています。このガイドでは、引き続きコマンドラインコマンドと呼びます。Exコマンドの完全なリストについては、`:h ex-cmd-index`を確認してください。

グローバルコマンドの構文は次のとおりです：

```shell
:g/pattern/command
```

`pattern`は、置換コマンドのパターンと同様に、そのパターンを含むすべての行に一致します。`command`は任意のコマンドラインコマンドであることができます。グローバルコマンドは、`pattern`に一致する各行に対して`command`を実行することによって機能します。

次の式があるとします：

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

「console」を含むすべての行を削除するには、次のように実行します：

```shell
:g/console/d
```

結果：

```shell
const one = 1;

const two = 2;

const three = 3;
```

グローバルコマンドは、「console」パターンに一致するすべての行に対して削除コマンド（`d`）を実行します。

`g`コマンドを実行すると、Vimはファイルを2回スキャンします。最初の実行では、各行をスキャンし、`/console/`パターンに一致する行にマークを付けます。すべての一致する行がマークされたら、2回目に行き、マークされた行に対して`d`コマンドを実行します。

代わりに「const」を含むすべての行を削除したい場合は、次のように実行します：

```shell
:g/const/d
```

結果：

```shell
console.log("one: ", one);

console.log("two: ", two);

console.log("three: ", three);
```

## 逆一致

一致しない行に対してグローバルコマンドを実行するには、次のように実行します：

```shell
:g!/pattern/command
```

または

```shell
:v/pattern/command
```

`:v/console/d`を実行すると、「console」を含まないすべての行が削除されます。

## パターン

グローバルコマンドは置換コマンドと同じパターンシステムを使用するため、このセクションはリフレッシャーとして役立ちます。次のセクションにスキップしても、読み進めても構いません！

次の式があるとします：

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

「one」または「two」を含む行を削除するには、次のように実行します：

```shell
:g/one\|two/d
```

任意の1桁の数字を含む行を削除するには、次のいずれかを実行します：

```shell
:g/[0-9]/d
```

または

```shell
:g/\d/d
```

次の式があるとします：

```shell
const oneMillion = 1000000;
const oneThousand = 1000;
const one = 1;
```

3から6のゼロを含む行に一致させるには、次のように実行します：

```shell
:g/0\{3,6\}/d
```

## 範囲を渡す

`g`コマンドの前に範囲を渡すことができます。以下はその方法です：
- `:1,5g/console/d` は、1行目から5行目の間で「console」という文字列に一致し、それらを削除します。
- `:,5g/console/d` は、カンマの前にアドレスがない場合、現在の行から始まります。現在の行と5行目の間で「console」という文字列を探し、それらを削除します。
- `:3,g/console/d` は、カンマの後にアドレスがない場合、現在の行で終了します。3行目と現在の行の間で「console」という文字列を探し、それらを削除します。
- `:3g/console/d` は、カンマなしで1つのアドレスのみを渡すと、3行目のみにコマンドを実行します。3行目を見て、「console」という文字列があれば削除します。

数字に加えて、次の記号を範囲として使用することもできます：
- `.` は現在の行を意味します。`.,3` の範囲は、現在の行と3行目の間を意味します。
- `$` はファイルの最後の行を意味します。`3,$` の範囲は、3行目と最後の行の間を意味します。
- `+n` は現在の行の後のn行を意味します。`.`と一緒に使うことも、使わないこともできます。`3,+1` または `3,.+1` は、3行目と現在の行の次の行の間を意味します。

範囲を指定しない場合、デフォルトではファイル全体に影響します。これは実際には標準ではありません。Vimのコマンドラインコマンドのほとんどは、範囲を渡さないと現在の行のみに実行されます。2つの顕著な例外は、グローバル（`:g`）と保存（`:w`）コマンドです。

## ノーマルコマンド

グローバルコマンドを使用してノーマルコマンドを実行することができます。`:normal` コマンドラインコマンドを使用します。

次のテキストがあるとします：
```shell
const one = 1
console.log("one: ", one)

const two = 2
console.log("two: ", two)

const three = 3
console.log("three: ", three)
```

各行の末尾に「;」を追加するには、次のように実行します：

```shell
:g/./normal A;
```

これを分解してみましょう：
- `:g` はグローバルコマンドです。
- `/./` は「非空行」のパターンです。少なくとも1文字を含む行に一致するため、「const」と「console」を含む行に一致し、空行には一致しません。
- `normal A;` は `:normal` コマンドラインコマンドを実行します。`A;` は行の末尾に「;」を挿入するノーマルモードコマンドです。

## マクロの実行

グローバルコマンドでマクロを実行することもできます。マクロは `normal` コマンドで実行できます。次の式があるとします：

```shell
const one = 1
console.log("one: ", one);

const two = 2
console.log("two: ", two);

const three = 3
console.log("three: ", three);
```

「const」を含む行にはセミコロンがありません。これらの行の末尾にカンマを追加するマクロをレジスタaに作成しましょう：

```shell
qaA;<Esc>q
```

リフレッシャーが必要な場合は、マクロに関する章を確認してください。次に実行します：

```shell
:g/const/normal @a
```

これで「const」を含むすべての行の末尾に「;」が追加されます。

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

このステップを順を追って進めた場合、最初の行には2つのセミコロンがあります。それを避けるために、2行目以降でグローバルコマンドを実行します：`:2,$g/const/normal @a`。

## 再帰的グローバルコマンド

グローバルコマンド自体はコマンドラインコマンドの一種であるため、技術的にはグローバルコマンドの中でグローバルコマンドを実行できます。

次の式があるとします。2番目の `console.log` ステートメントを削除したい場合：

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

次のように実行します：

```shell
:g/console/g/two/d
```

最初に、`g` は「console」というパターンを含む行を探し、3つの一致を見つけます。次に、2番目の `g` は、その3つの一致の中から「two」というパターンを含む行を探します。最後に、その一致を削除します。

`g` と `v` を組み合わせて、正のパターンと負のパターンを見つけることもできます。例えば：

```shell
:g/console/v/two/d
```

「two」というパターンを含む行を探す代わりに、「two」というパターンを含まない行を探します。

## 区切り文字の変更

置換コマンドのように、グローバルコマンドの区切り文字を変更できます。ルールは同じです：アルファベット、数字、`"`、`|`、および `\` 以外の任意の1バイト文字を使用できます。

「console」を含む行を削除するには：

```shell
:g@console@d
```

グローバルコマンドで置換コマンドを使用する場合、2つの異なる区切り文字を持つことができます：

```shell
g@one@s+const+let+g
```

ここで、グローバルコマンドは「one」を含むすべての行を探します。置換コマンドは、それらの一致から「const」という文字列を「let」に置き換えます。

## デフォルトコマンド

グローバルコマンドでコマンドラインコマンドを指定しない場合、どうなりますか？

グローバルコマンドは、現在の行のテキストを印刷するために印刷（`:p`）コマンドを使用します。次のように実行すると：

```shell
:g/console
```

「console」を含むすべての行が画面の下部に印刷されます。

ちなみに、ここに興味深い事実があります。グローバルコマンドで使用されるデフォルトコマンドが `p` であるため、`g` 構文は次のようになります：

```shell
:g/re/p
```

- `g` = グローバルコマンド
- `re` = 正規表現パターン
- `p` = 印刷コマンド

これは *"grep"* と綴られ、コマンドラインの `grep` と同じです。これは **偶然ではありません**。`g/re/p` コマンドは、元々Edエディタから来たもので、元の行テキストエディタの1つです。`grep` コマンドはEdからその名前を得ました。

あなたのコンピュータにはおそらくまだEdエディタがインストールされています。ターミナルから `ed` を実行してください（ヒント：終了するには `q` と入力します）。

## バッファ全体の反転

ファイル全体を反転させるには、次のように実行します：

```shell
:g/^/m 0
```

`^` は行の先頭のパターンです。空行を含むすべての行に一致させるために `^` を使用します。

いくつかの行だけを反転させる必要がある場合は、範囲を渡します。5行目から10行目の間の行を反転させるには、次のように実行します：

```shell
:5,10g/^/m 0
```

移動コマンドについて詳しく学ぶには、`:h :move` を確認してください。

## すべてのTODOを集約

コーディング中に、編集中のファイルにTODOを書き込むことがあります：

```shell
const one = 1;
console.log("one: ", one);
// TODO: feed the puppy

const two = 2;
// TODO: feed the puppy automatically
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
// TODO: create a startup selling an automatic puppy feeder
```

作成したTODOをすべて追跡するのは難しいことがあります。Vimには、すべての一致をアドレスにコピーするための `:t`（コピー）メソッドがあります。コピー方法について詳しく学ぶには、`:h :copy` を確認してください。

すべてのTODOをファイルの最後にコピーして、簡単に確認できるようにするには、次のように実行します：

```shell
:g/TODO/t $
```

結果：

```shell
const one = 1;
console.log("one: ", one);
// TODO: feed the puppy

const two = 2;
// TODO: feed the puppy automatically
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
// TODO: create a startup selling an automatic puppy feeder

// TODO: feed the puppy
// TODO: feed the puppy automatically
// TODO: create a startup selling an automatic puppy feeder
```

これで、作成したすべてのTODOを確認し、それを行う時間を見つけたり、他の誰かに委任したりして、次のタスクに取り組むことができます。

コピーするのではなく、すべてのTODOを最後に移動したい場合は、移動コマンド `:m` を使用します：

```shell
:g/TODO/m $
```

結果：

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);

// TODO: feed the puppy
// TODO: feed the puppy automatically
// TODO: create a startup selling an automatic puppy feeder
```

## ブラックホール削除

レジスタの章を思い出してください。削除されたテキストは、番号付きレジスタに保存されます（十分に大きい場合）。`:g/console/d` を実行すると、Vimは削除された行を番号付きレジスタに保存します。多くの行を削除すると、すぐにすべての番号付きレジスタがいっぱいになることがあります。これを避けるために、ブラックホールレジスタ（`"_`）を使用して、削除した行をレジスタに保存しないようにすることができます。次のように実行します：

```shell
:g/console/d_
```

`d` の後に `_` を渡すことで、Vimはスクラッチレジスタを使わなくなります。
## 複数の空行を1つの空行に減らす

複数の空行を含むテキストがある場合：

```shell
const one = 1;
console.log("one: ", one);


const two = 2;
console.log("two: ", two);





const three = 3;
console.log("three: ", three);
```

次のコマンドを使って、空行を1つの空行にすばやく減らすことができます：

```shell
:g/^$/,/./-1j
```

結果：

```shell
const one = 1;
console.log("one: ", one);

const two = 2;
console.log("two: ", two);

const three = 3;
console.log("three: ", three);
```

通常、グローバルコマンドは次の形式を受け入れます：`:g/pattern/command`。ただし、次の形式でもグローバルコマンドを実行できます：`:g/pattern1/,/pattern2/command`。これにより、Vimは`pattern1`と`pattern2`の間で`command`を適用します。

これを考慮して、コマンド`:g/^$/,/./-1j`を`:g/pattern1/,/pattern2/command`に従って分解してみましょう：
- `/pattern1/`は`/^$/`です。これは空行（文字がゼロの行）を表します。
- `/pattern2/`は`/./`で、`-1`行修飾子が付いています。`/./`は非空行（少なくとも1文字のある行）を表します。`-1`はその上の行を意味します。
- `command`は`j`、結合コマンド（`:j`）です。この文脈では、このグローバルコマンドは指定されたすべての行を結合します。

ちなみに、複数の空行をゼロ行に減らしたい場合は、次のコマンドを実行します：

```shell
:g/^$/,/./j
```

より簡単な代替案：

```shell
:g/^$/-j
```

あなたのテキストは次のように減らされました：

```shell
const one = 1;
console.log("one: ", one);
const two = 2;
console.log("two: ", two);
const three = 3;
console.log("three: ", three);
```

## 高度なソート

Vimには、範囲内の行をソートするための`:sort`コマンドがあります。例えば：

```shell
d
b
a
e
c
```

`:sort`を実行することで、それらをソートできます。範囲を指定すると、その範囲内の行のみをソートします。例えば、`:3,5sort`は、3行目と5行目のみをソートします。

次のような式がある場合：

```shell
const arrayB = [
  "i",
  "g",
  "h",
  "b",
  "f",
  "d",
  "e",
  "c",
  "a",
]

const arrayA = [
  "h",
  "b",
  "f",
  "d",
  "e",
  "a",
  "c",
]
```

配列内の要素をソートしたいが、配列自体はソートしたくない場合、次のコマンドを実行できます：

```shell
:g/\[/+1,/\]/-1sort
```

結果：

```shell
const arrayB = [
  "a",
  "b",
  "c",
  "d",
  "e",
  "f",
  "g",
  "h",
  "i",
]

const arrayA = [
  "a"
  "b",
  "c",
  "d",
  "e",
  "f",
  "h",
]
```

これは素晴らしいですが、コマンドは複雑に見えます。分解してみましょう。このコマンドも`:g/pattern1/,/pattern2/command`の形式に従います。

- `:g`はグローバルコマンドパターンです。
- `/\[/+1`は最初のパターンです。リテラルの左角括弧`[`に一致します。`+1`はその下の行を指します。
- `/\]/-1`は2番目のパターンです。リテラルの右角括弧`]`に一致します。`-1`はその上の行を指します。
- `/\[/+1,/\]/-1`は`[`と`]`の間の任意の行を指します。
- `sort`はソートするためのコマンドラインコマンドです。

## グローバルコマンドを賢く学ぶ

グローバルコマンドは、すべての一致する行に対してコマンドラインコマンドを実行します。これにより、コマンドを1回実行するだけで、Vimが残りを処理します。グローバルコマンドに習熟するためには、2つのことが必要です：コマンドラインコマンドの良い語彙と正規表現の知識です。Vimを使う時間が増えるにつれて、自然により多くのコマンドラインコマンドを学ぶことになります。正規表現の知識は、より積極的なアプローチを必要とします。しかし、正規表現に慣れると、多くの人よりも先に進むことができます。

ここにあるいくつかの例は複雑です。恐れずに、じっくり理解してください。パターンを読むことを学びましょう。あきらめないでください。

複数のコマンドを実行する必要があるときは、一時停止して`g`コマンドを使用できるか確認してください。作業に最適なコマンドを特定し、できるだけ多くのものを一度にターゲットにするパターンを書いてください。

グローバルコマンドの強力さを理解したので、外部コマンドを使用してツールの arsenal を増やす方法を学びましょう。