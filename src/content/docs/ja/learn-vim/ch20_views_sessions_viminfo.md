---
description: プロジェクトの設定やレイアウトを保存する方法を学び、Vimを再起動しても以前の状態を維持する方法を紹介します。
title: Ch20. Views, Sessions, and Viminfo
---

プロジェクトにしばらく取り組んでいると、プロジェクトが独自の設定、折りたたみ、バッファ、レイアウトなどを持って徐々に形になっていくのがわかるかもしれません。それは、しばらく住んだ後にアパートを装飾するようなものです。問題は、Vimを閉じると、その変更が失われてしまうことです。次回Vimを開いたときに、まるで一度も離れていなかったかのように、その変更を保持できれば素晴らしいと思いませんか？

この章では、View、Session、およびViminfoを使用してプロジェクトの「スナップショット」を保存する方法を学びます。

## View

Viewは、三つのうち最も小さなサブセット（View、Session、Viminfo）です。これは、1つのウィンドウの設定のコレクションです。ウィンドウで長時間作業し、マップや折りたたみを保存したい場合は、Viewを使用できます。

`foo.txt`というファイルを作成しましょう：

```shell
foo1
foo2
foo3
foo4
foo5
foo6
foo7
foo8
foo9
foo10
```

このファイルに三つの変更を加えます：
1. 1行目で手動折りたたみ `zf4j` を作成します（次の4行を折りたたむ）。
2. `number` 設定を変更します： `setlocal nonumber norelativenumber`。これにより、ウィンドウの左側の番号インジケータが削除されます。
3. `j` を押すたびに1行ではなく2行下に移動するローカルマッピングを作成します： `:nnoremap <buffer> j jj`。

あなたのファイルは次のようになります：

```shell
+-- 5 lines: foo1 -----
foo6
foo7
foo8
foo9
foo10
```

### View属性の設定

実行します：

```shell
:set viewoptions?
```

デフォルトでは次のように表示されるはずです（あなたのvimrcによって異なる場合があります）：

```shell
viewoptions=folds,cursor,curdir
```

`viewoptions`を設定しましょう。保存したい三つの属性は、折りたたみ、マップ、およびローカル設定オプションです。私の設定があなたのものと同じであれば、すでに`folds`オプションがあります。Viewに`localoptions`を記憶させる必要があります。実行します：

```shell
:set viewoptions+=localoptions
```

`viewoptions`に利用可能な他のオプションを学ぶには、`:h viewoptions`を確認してください。今、`:set viewoptions?`を実行すると、次のように表示されるはずです：

```shell
viewoptions=folds,cursor,curdir,localoptions
```

### Viewの保存

`foo.txt`ウィンドウが適切に折りたたまれ、`nonumber norelativenumber`オプションを持っている状態で、Viewを保存しましょう。実行します：

```shell
:mkview
```

VimはViewファイルを作成します。

### Viewファイル

「VimはこのViewファイルをどこに保存したのか？」と疑問に思うかもしれません。Vimがどこに保存するかを見るには、実行します：

```shell
:set viewdir?
```

UnixベースのOSでは、デフォルトは`~/.vim/view`と表示されるはずです（異なるOSを使用している場合、異なるパスが表示されるかもしれません。詳細は`:h viewdir`を確認してください）。UnixベースのOSを使用していて、別のパスに変更したい場合は、vimrcに次のように追加します：

```shell
set viewdir=$HOME/else/where
```

### Viewファイルの読み込み

まだ`foo.txt`を閉じていない場合は閉じて、再度`foo.txt`を開きます。**変更なしの元のテキストが表示されるはずです。** これは予想通りです。

状態を復元するには、Viewファイルを読み込む必要があります。実行します：

```shell
:loadview
```

今、次のように表示されるはずです：

```shell
+-- 5 lines: foo1 -----
foo6
foo7
foo8
foo9
foo10
```

折りたたみ、ローカル設定、およびローカルマッピングが復元されます。気づけば、カーソルも`:mkview`を実行したときにいた行に戻っているはずです。`cursor`オプションがある限り、Viewはカーソルの位置も記憶します。

### 複数のView

Vimは9つの番号付きView（1-9）を保存できます。

追加の折りたたみを作成したいとしましょう（例えば、最後の2行を折りたたみたい場合）、`:9,10 fold`を使います。これをView 1として保存します。実行します：

```shell
:mkview 1
```

さらに別の折りたたみを作成したい場合（`:6,7 fold`を使って異なるViewとして保存する場合）、実行します：

```shell
:mkview 2
```

ファイルを閉じます。`foo.txt`を開き、View 1を読み込みたい場合は、実行します：

```shell
:loadview 1
```

View 2を読み込むには、実行します：

```shell
:loadview 2
```

元のViewを読み込むには、実行します：

```shell
:loadview
```

### View作成の自動化

最悪の事態の一つは、大きなファイルを折りたたみで整理するのに何時間も費やした後、誤ってウィンドウを閉じてすべての折りたたみ情報を失ってしまうことです。これを防ぐために、バッファを閉じるたびに自動的にViewを作成するようにしたいかもしれません。vimrcに次のように追加します：

```shell
autocmd BufWinLeave *.txt mkview
```

さらに、バッファを開くときにViewを読み込むのも良いかもしれません：

```shell
autocmd BufWinEnter *.txt silent loadview
```

これで、`txt`ファイルを扱うときにViewを作成したり読み込んだりする心配がなくなります。時間が経つにつれて、`~/.vim/view`にViewファイルが蓄積される可能性があることに注意してください。数ヶ月ごとに整理するのが良いでしょう。

## セッション

Viewがウィンドウの設定を保存するのに対し、Sessionはすべてのウィンドウの情報（レイアウトを含む）を保存します。

### 新しいセッションの作成

`foobarbaz`プロジェクトでこれらの3つのファイルを扱っているとしましょう：

`foo.txt`の中：

```shell
foo1
foo2
foo3
foo4
foo5
foo6
foo7
foo8
foo9
foo10
```

`bar.txt`の中：

```shell
bar1
bar2
bar3
bar4
bar5
bar6
bar7
bar8
bar9
bar10
```

`baz.txt`の中：

```shell
baz1
baz2
baz3
baz4
baz5
baz6
baz7
baz8
baz9
baz10
```

ウィンドウを`:split`や`:vsplit`で分割したとしましょう。この見た目を保持するには、セッションを保存する必要があります。実行します：

```shell
:mksession
```

`mkview`がデフォルトで`~/.vim/view`に保存するのに対し、`mksession`は現在のディレクトリにセッションファイル（`Session.vim`）を保存します。中身が気になる場合はファイルを確認してください。

セッションファイルを別の場所に保存したい場合は、`mksession`に引数を渡すことができます：

```shell
:mksession ~/some/where/else.vim
```

既存のセッションファイルを上書きしたい場合は、`!`を付けてコマンドを呼び出します（`:mksession! ~/some/where/else.vim`）。

### セッションの読み込み

セッションを読み込むには、実行します：

```shell
:source Session.vim
```

今、Vimはあなたが離れたときの状態のまま、分割ウィンドウを含めて表示されます！また、ターミナルからセッションファイルを読み込むこともできます：

```shell
vim -S Session.vim
```

### セッション属性の設定

セッションが保存する属性を設定できます。現在保存されているものを確認するには、実行します：

```shell
:set sessionoptions?
```

私の設定は次のようになっています：

```shell
blank,buffers,curdir,folds,help,tabpages,winsize,terminal
```

セッションを保存する際に`terminal`を保存したくない場合は、セッションオプションから削除します。実行します：

```shell
:set sessionoptions-=terminal
```

セッションを保存する際に`options`を追加したい場合は、実行します：

```shell
:set sessionoptions+=options
```

以下は、`sessionoptions`が保存できる属性の一部です：
- `blank`は空のウィンドウを保存します
- `buffers`はバッファを保存します
- `folds`は折りたたみを保存します
- `globals`はグローバル変数を保存します（大文字で始まり、少なくとも1つの小文字を含む必要があります）
- `options`はオプションとマッピングを保存します
- `resize`はウィンドウの行数と列数を保存します
- `winpos`はウィンドウの位置を保存します
- `winsize`はウィンドウのサイズを保存します
- `tabpages`はタブを保存します
- `unix`はUnix形式のファイルを保存します

完全なリストについては、`:h 'sessionoptions'`を確認してください。

セッションはプロジェクトの外部属性を保存するのに便利なツールです。ただし、ローカルマーク、レジスタ、履歴などの一部の内部属性はセッションによって保存されません。それらを保存するには、Viminfoを使用する必要があります！

## Viminfo

単語をレジスタaにヤンクしてVimを終了した後、次回Vimを開くと、レジスタaにそのテキストが保存されているのに気づくかもしれません。これは実際にはViminfoの働きです。これがなければ、VimはVimを閉じた後にレジスタを記憶しません。

Vim 8以上を使用している場合、VimはデフォルトでViminfoを有効にしているため、あなたは知らず知らずのうちにViminfoを使用していたかもしれません！

「Viminfoは何を保存するのか？セッションとはどう違うのか？」と尋ねるかもしれません。

Viminfoを使用するには、まず`+viminfo`機能が利用可能である必要があります（`:version`）。Viminfoは以下を保存します：
- コマンドライン履歴。
- 検索文字列の履歴。
- 入力行の履歴。
- 空でないレジスタの内容。
- 複数のファイルのマーク。
- ファイルマーク、ファイル内の位置を指し示す。
- 最後の検索/置換パターン（'n'および'&'用）。
- バッファリスト。
- グローバル変数。

一般的に、セッションは「外部」属性を保存し、Viminfoは「内部」属性を保存します。

セッションはプロジェクトごとに1つのセッションファイルを持つことができますが、通常はコンピュータごとに1つのViminfoファイルを使用します。Viminfoはプロジェクトに依存しません。

UnixのデフォルトのViminfoの場所は`$HOME/.viminfo`（`~/.viminfo`）です。異なるOSを使用している場合、Viminfoの場所は異なるかもしれません。`:h viminfo-file-name`を確認してください。内部の変更（テキストをレジスタにヤンクするなど）を行うたびに、Vimは自動的にViminfoファイルを更新します。

*必ず`nocompatible`オプションが設定されていることを確認してください（`set nocompatible`）、そうでないとViminfoは機能しません。*

### Viminfoの書き込みと読み込み

1つのViminfoファイルのみを使用しますが、複数のViminfoファイルを作成できます。Viminfoファイルを書き込むには、`:wviminfo`コマンドを使用します（短縮形は`:wv`です）。

```shell
:wv ~/.viminfo_extra
```

既存のViminfoファイルを上書きするには、`wv`コマンドにバンを追加します：

```shell
:wv! ~/.viminfo_extra
```

デフォルトでは、Vimは`~/.viminfo`ファイルから読み込みます。別のViminfoファイルから読み込むには、`:rviminfo`を実行するか、短縮形の`:rv`を使用します：

```shell
:rv ~/.viminfo_extra
```

ターミナルから異なるViminfoファイルでVimを開始するには、`i`フラグを使用します：

```shell
vim -i viminfo_extra
```

異なるタスク（コーディングや執筆など）にVimを使用する場合、執筆用に最適化されたViminfoとコーディング用のViminfoを作成できます。

```shell
vim -i viminfo_writing

vim -i viminfo_coding
```

### ViminfoなしでVimを開始する

VimをViminfoなしで開始するには、ターミナルから次のように実行します：

```shell
vim -i NONE
```

これを永続的にするには、vimrcファイルに次のように追加できます：

```shell
set viminfo="NONE"
```

### Viminfo属性の設定

`viewoptions`や`sessionoptions`と同様に、`viminfo`オプションで保存する属性を指示できます。実行します：

```shell
:set viminfo?
```

次のように表示されます：

```shell
!,'100,<50,s10,h
```

これは暗号のように見えます。分解してみましょう：
- `!`は、大文字で始まり小文字を含まないグローバル変数を保存します。`g:`はグローバル変数を示します。たとえば、ある時点で`let g:FOO = "foo"`と書いた場合、Viminfoはグローバル変数`FOO`を保存します。しかし、`let g:Foo = "foo"`と書いた場合、Viminfoはこのグローバル変数を保存しません。小文字を含むためです。`!`がなければ、Vimはこれらのグローバル変数を保存しません。
- `'100`はマークを表します。この場合、Viminfoは最後の100ファイルのローカルマーク（a-z）を保存します。Viminfoにあまりにも多くのファイルを保存するよう指示すると、Vimが遅くなる可能性があることに注意してください。1000が良い数です。
- `<50`は、各レジスタに保存される最大行数を示します（この場合は50）。もし私が100行のテキストをレジスタaにヤンクし（`"ay99j`）、Vimを閉じた場合、次回Vimを開いてレジスタaからペーストすると（`"ap`）、Vimは最大50行しかペーストしません。最大行数を指定しない場合、*すべて*の行が保存されます。0を指定すると、何も保存されません。
- `s10`は、レジスタのサイズ制限（kb単位）を設定します。この場合、10kbを超えるレジスタは除外されます。
- `h`は、Vimが起動する際にハイライト（`hlsearch`から）を無効にします。

他にも渡すことができるオプションがあります。詳細については、`:h 'viminfo'`を確認してください。
## ビュー、セッション、Viminfoを賢く使う

Vimには、Vim環境のスナップショットを異なるレベルで取得するためのビュー、セッション、Viminfoがあります。マイクロプロジェクトにはビューを使用してください。より大きなプロジェクトにはセッションを使用します。ビュー、セッション、Viminfoが提供するすべてのオプションを確認するために時間をかけるべきです。

自分の編集スタイルに合わせて独自のビュー、セッション、Viminfoを作成してください。コンピュータの外でVimを使用する必要がある場合は、設定を読み込むだけで、すぐに自宅にいるように感じることができます！