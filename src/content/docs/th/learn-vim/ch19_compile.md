---
description: บทนี้สอนการคอมไพล์จาก Vim และวิธีใช้คำสั่ง `:make` เพื่อจัดการการคอมไพล์ไฟล์ในภาษาโปรแกรมต่างๆ
  อย่างมีประสิทธิภาพ
title: Ch19. Compile
---

การคอมไพล์เป็นหัวข้อที่สำคัญสำหรับหลายภาษา ในบทนี้คุณจะได้เรียนรู้วิธีการคอมไพล์จาก Vim นอกจากนี้คุณยังจะได้ดูวิธีการใช้คำสั่ง `:make` ของ Vim ให้เกิดประโยชน์

## คอมไพล์จาก Command Line

คุณสามารถใช้ bang operator (`!`) เพื่อคอมไพล์ หากคุณต้องการคอมไพล์ไฟล์ `.cpp` ของคุณด้วย `g++` ให้รัน:

```shell
:!g++ hello.cpp -o hello
```

อย่างไรก็ตาม การพิมพ์ชื่อไฟล์และชื่อไฟล์ผลลัพธ์ด้วยมือทุกครั้งนั้นมีโอกาสเกิดข้อผิดพลาดและน่าเบื่อ การใช้ makefile เป็นวิธีที่ดีกว่า

## คำสั่ง Make

Vim มีคำสั่ง `:make` เพื่อรัน makefile เมื่อคุณรันมัน Vim จะมองหา makefile ในไดเรกทอรีปัจจุบันเพื่อดำเนินการ

สร้างไฟล์ชื่อ `makefile` ในไดเรกทอรีปัจจุบันและใส่เนื้อหาดังนี้:

```shell
all:
	echo "Hello all"
foo:
	echo "Hello foo"
list_pls:
	ls
```

รันคำสั่งนี้จาก Vim:

```shell
:make
```

Vim จะดำเนินการเช่นเดียวกับเมื่อคุณรันจาก terminal คำสั่ง `:make` รับพารามิเตอร์เช่นเดียวกับคำสั่ง make ใน terminal รัน:

```shell
:make foo
" แสดงผล "Hello foo"

:make list_pls
" แสดงผลผลลัพธ์ของคำสั่ง ls
```

คำสั่ง `:make` ใช้ quickfix ของ Vim เพื่อเก็บข้อผิดพลาดใด ๆ หากคุณรันคำสั่งที่ไม่ถูกต้อง มาลองรันเป้าหมายที่ไม่มีอยู่:

```shell
:make dontexist
```

คุณควรเห็นข้อผิดพลาดเมื่อรันคำสั่งนั้น เพื่อดูข้อผิดพลาดนั้น ให้รันคำสั่ง quickfix `:copen` เพื่อดูหน้าต่าง quickfix:

```shell
|| make: *** No rule to make target `dontexist'.  Stop.
```

## การคอมไพล์ด้วย Make

มาลองใช้ makefile เพื่อคอมไพล์โปรแกรม `.cpp` เบื้องต้น ก่อนอื่นให้สร้างไฟล์ `hello.cpp`:

```shell
#include <iostream>

int main() {
    std::cout << "Hello!\n";
    return 0;
}
```

อัปเดต makefile ของคุณเพื่อสร้างและรันไฟล์ `.cpp`:

```shell
all:
	echo "build, run"
build:
	g++ hello.cpp -o hello
run:
	./hello
```

ตอนนี้รัน:

```shell
:make build
```

คำสั่ง `g++` จะคอมไพล์ `./hello.cpp` และสร้าง `./hello` จากนั้นรัน:

```shell
:make run
```

คุณควรเห็น `"Hello!"` ปรากฏบน terminal

## โปรแกรม Make ที่แตกต่างกัน

เมื่อคุณรัน `:make` Vim จะรันคำสั่งใด ๆ ที่ตั้งไว้ภายใต้ตัวเลือก `makeprg` หากคุณรัน `:set makeprg?` คุณจะเห็น:

```shell
makeprg=make
```

คำสั่ง `:make` เริ่มต้นคือคำสั่ง `make` ภายนอก หากต้องการเปลี่ยนคำสั่ง `:make` ให้รัน `g++ {ชื่อไฟล์ของคุณ}` ทุกครั้งที่คุณรัน ให้รัน:

```shell
:set makeprg=g++\ %
```

เครื่องหมาย `\` ใช้เพื่อหลีกเลี่ยงช่องว่างหลัง `g++` สัญลักษณ์ `%` ใน Vim แทนไฟล์ปัจจุบัน คำสั่ง `g++\\ %` เทียบเท่ากับการรัน `g++ hello.cpp`

ไปที่ `./hello.cpp` แล้วรัน `:make` Vim จะคอมไพล์ `hello.cpp` และสร้าง `a.out` เพราะคุณไม่ได้ระบุผลลัพธ์ มาปรับปรุงให้มันตั้งชื่อผลลัพธ์ที่คอมไพล์ด้วยชื่อไฟล์ต้นฉบับโดยไม่มีนามสกุล รันหรือเพิ่มสิ่งนี้ใน vimrc:

```shell
set makeprg=g++\ %\ -o\ %<
```

การแบ่งส่วน:
- `g++\ %` เหมือนกับข้างต้น เทียบเท่ากับการรัน `g++ <ไฟล์ของคุณ>`
- `-o` คือทางเลือกผลลัพธ์
- `%<` ใน Vim แทนชื่อไฟล์ปัจจุบันโดยไม่มีนามสกุล (`hello.cpp` จะกลายเป็น `hello`)

เมื่อคุณรัน `:make` จากภายใน `./hello.cpp` มันจะถูกคอมไพล์เป็น `./hello` เพื่อรัน `./hello` อย่างรวดเร็วจากภายใน `./hello.cpp` ให้รัน `:!./%<` อีกครั้ง นี่คือสิ่งเดียวกับการรัน `:!./{ชื่อไฟล์ปัจจุบันที่ไม่มีนามสกุล}`

สำหรับข้อมูลเพิ่มเติม ดูที่ `:h :compiler` และ `:h write-compiler-plugin`

## การคอมไพล์อัตโนมัติเมื่อบันทึก

คุณสามารถทำให้ชีวิตง่ายขึ้นโดยการทำให้การคอมไพล์อัตโนมัติ จำไว้ว่าคุณสามารถใช้ `autocmd` ของ Vim เพื่อกระตุ้นการกระทำอัตโนมัติตามเหตุการณ์บางอย่าง เพื่อคอมไพล์ไฟล์ `.cpp` โดยอัตโนมัติเมื่อบันทึกให้เพิ่มสิ่งนี้ใน vimrc ของคุณ:

```shell
autocmd BufWritePost *.cpp make
```

ทุกครั้งที่คุณบันทึกในไฟล์ `.cpp` Vim จะดำเนินการคำสั่ง `make`

## การเปลี่ยนคอมไพเลอร์

Vim มีคำสั่ง `:compiler` เพื่อเปลี่ยนคอมไพเลอร์อย่างรวดเร็ว การติดตั้ง Vim ของคุณอาจมาพร้อมกับการตั้งค่าคอมไพเลอร์ที่สร้างไว้ล่วงหน้าหลายตัว เพื่อตรวจสอบว่าคุณมีคอมไพเลอร์อะไรบ้างให้รัน:

```shell
:e $VIMRUNTIME/compiler/<Tab>
```

คุณควรเห็นรายการคอมไพเลอร์สำหรับภาษาการเขียนโปรแกรมต่าง ๆ

เพื่อใช้คำสั่ง `:compiler` สมมติว่าคุณมีไฟล์ ruby, `hello.rb` และภายในมี:

```shell
puts "Hello ruby"
```

จำไว้ว่าถ้าคุณรัน `:make` Vim จะดำเนินการคำสั่งใด ๆ ที่กำหนดให้กับ `makeprg` (ค่าเริ่มต้นคือ `make`) หากคุณรัน:

```shell
:compiler ruby
```

Vim จะรันสคริปต์ `$VIMRUNTIME/compiler/ruby.vim` และเปลี่ยน `makeprg` ให้ใช้คำสั่ง `ruby` ตอนนี้ถ้าคุณรัน `:set makeprg?` มันควรจะบอกว่า `makeprg=ruby` (ขึ้นอยู่กับสิ่งที่อยู่ภายในไฟล์ `$VIMRUNTIME/compiler/ruby.vim` ของคุณหรือถ้าคุณมีคอมไพเลอร์ ruby ที่กำหนดเองอื่น ๆ ของคุณอาจจะแตกต่างกัน) คำสั่ง `:compiler {ภาษา-ของคุณ}` ช่วยให้คุณสามารถเปลี่ยนไปยังคอมไพเลอร์ที่แตกต่างกันได้อย่างรวดเร็ว ซึ่งมีประโยชน์หากโปรเจกต์ของคุณใช้หลายภาษา

คุณไม่จำเป็นต้องใช้ `:compiler` และ `makeprg` เพื่อคอมไพล์โปรแกรม คุณสามารถรันสคริปต์ทดสอบ, lint ไฟล์, ส่งสัญญาณ หรืออะไรก็ได้ที่คุณต้องการ

## การสร้างคอมไพเลอร์ที่กำหนดเอง

มาสร้างคอมไพเลอร์ Typescript ที่ง่าย ๆ ติดตั้ง Typescript (`npm install -g typescript`) ลงในเครื่องของคุณ คุณควรมีคำสั่ง `tsc` ตอนนี้ หากคุณยังไม่เคยเล่นกับ Typescript มาก่อน `tsc` จะคอมไพล์ไฟล์ Typescript เป็นไฟล์ Javascript สมมติว่าคุณมีไฟล์ `hello.ts`:

```shell
const hello = "hello";
console.log(hello);
```

หากคุณรัน `tsc hello.ts` มันจะคอมไพล์เป็น `hello.js` อย่างไรก็ตาม หากคุณมีนิพจน์ต่อไปนี้ภายใน `hello.ts`:

```shell
const hello = "hello";
hello = "hello again";
console.log(hello);
```

นี่จะทำให้เกิดข้อผิดพลาดเพราะคุณไม่สามารถเปลี่ยนแปลงตัวแปร `const` ได้ การรัน `tsc hello.ts` จะทำให้เกิดข้อผิดพลาด:

```shell
hello.ts:2:1 - error TS2588: Cannot assign to 'person' because it is a constant.

2 person = "hello again";
  ~~~~~~


Found 1 error.
```

เพื่อสร้างคอมไพเลอร์ Typescript ที่ง่าย ๆ ในไดเรกทอรี `~/.vim/` ของคุณ ให้เพิ่มไดเรกทอรี `compiler` (`~/.vim/compiler/`) จากนั้นสร้างไฟล์ `typescript.vim` (`~/.vim/compiler/typescript.vim`) ใส่เนื้อหานี้:

```shell
CompilerSet makeprg=tsc
CompilerSet errorformat=%f:\ %m
```

บรรทัดแรกตั้งค่า `makeprg` ให้รันคำสั่ง `tsc` บรรทัดที่สองตั้งค่า format ข้อผิดพลาดเพื่อแสดงไฟล์ (`%f`), ตามด้วยเครื่องหมายสองจุด (`:`) และช่องว่างที่หลีกเลี่ยง (`\ `), ตามด้วยข้อความข้อผิดพลาด (`%m`) เพื่อเรียนรู้เพิ่มเติมเกี่ยวกับการจัดรูปแบบข้อผิดพลาดให้ดูที่ `:h errorformat`

คุณควรอ่านคอมไพเลอร์ที่สร้างไว้ล่วงหน้าบางตัวเพื่อดูว่าคนอื่นทำอย่างไร ตรวจสอบที่ `:e $VIMRUNTIME/compiler/<some-language>.vim`

เนื่องจากปลั๊กอินบางตัวอาจรบกวนไฟล์ Typescript ให้เปิด `hello.ts` โดยไม่มีปลั๊กอินโดยใช้ธง `--noplugin`:

```shell
vim --noplugin hello.ts
```

ตรวจสอบ `makeprg`:

```shell
:set makeprg?
```

มันควรบอกว่าเป็นโปรแกรม `make` เริ่มต้น เพื่อใช้คอมไพเลอร์ Typescript ใหม่ให้รัน:

```shell
:compiler typescript
```

เมื่อคุณรัน `:set makeprg?` มันควรบอกว่าเป็น `tsc` ตอนนี้ มาลองทดสอบกัน รัน:

```shell
:make %
```

จำไว้ว่ `%` หมายถึงไฟล์ปัจจุบัน ดูให้เห็นคอมไพเลอร์ Typescript ของคุณทำงานตามที่คาดหวัง! เพื่อดูรายการข้อผิดพลาดให้รัน `:copen`

## คอมไพล์แบบ Async

บางครั้งการคอมไพล์อาจใช้เวลานาน คุณไม่ต้องการที่จะจ้องมอง Vim ที่หยุดนิ่งในขณะที่รอให้กระบวนการคอมไพล์เสร็จสิ้น จะไม่ดีหากคุณสามารถคอมไพล์แบบไม่ซิงโครนัสเพื่อให้คุณสามารถใช้ Vim ได้ในระหว่างการคอมไพล์?

โชคดีที่มีปลั๊กอินสำหรับรันกระบวนการแบบ async สองตัวใหญ่คือ:

- [vim-dispatch](https://github.com/tpope/vim-dispatch)
- [asyncrun.vim](https://github.com/skywind3000/asyncrun.vim)

ในส่วนที่เหลือของบทนี้ ฉันจะพูดถึง vim-dispatch แต่ฉันขอแนะนำให้คุณลองใช้ปลั๊กอินทั้งหมดที่มีอยู่

*Vim และ NeoVim จริง ๆ แล้วสนับสนุนงานแบบ async แต่เกินขอบเขตของบทนี้ หากคุณสนใจให้ตรวจสอบที่ `:h job-channel-overview.txt`*

## ปลั๊กอิน: Vim-dispatch

Vim-dispatch มีหลายคำสั่ง แต่สองคำสั่งหลักคือ `:Make` และ `:Dispatch`

### Async Make

คำสั่ง `:Make` ของ Vim-dispatch คล้ายกับคำสั่ง `:make` ของ Vim แต่จะรันแบบไม่ซิงโครนัส หากคุณอยู่ในโปรเจกต์ Javascript และต้องการรัน `npm t` คุณอาจพยายามตั้งค่า makeprg ของคุณให้เป็น:

```shell
:set makeprg=npm\\ t
```

หากคุณรัน:

```shell
:make
```

Vim จะดำเนินการ `npm t` แต่คุณจะจ้องมองหน้าจอที่หยุดนิ่งในขณะที่การทดสอบ JavaScript ของคุณทำงาน ด้วย vim-dispatch คุณสามารถรัน:

```shell
:Make
```

Vim จะรัน `npm t` แบบไม่ซิงโครนัส ด้วยวิธีนี้ในขณะที่ `npm t` ทำงานในกระบวนการพื้นหลัง คุณสามารถทำสิ่งที่คุณกำลังทำอยู่ต่อไปได้ เจ๋งมาก!

### Async Dispatch

คำสั่ง `:Dispatch` คล้ายกับคำสั่ง `:compiler` และคำสั่ง `:!` มันสามารถรันคำสั่งภายนอกใด ๆ แบบไม่ซิงโครนัสใน Vim

สมมติว่าคุณอยู่ในไฟล์ spec ของ ruby และคุณต้องการรันทดสอบ รัน:

```shell
:Dispatch bundle exec rspec %
```

Vim จะรันคำสั่ง `rspec` แบบไม่ซิงโครนัสกับไฟล์ปัจจุบัน (`%`)

### การทำให้ Dispatch อัตโนมัติ

Vim-dispatch มีตัวแปรบัฟเฟอร์ `b:dispatch` ที่คุณสามารถกำหนดค่าให้ประเมินคำสั่งเฉพาะโดยอัตโนมัติ คุณสามารถใช้มันร่วมกับ `autocmd` หากคุณเพิ่มสิ่งนี้ใน vimrc ของคุณ:

```shell
autocmd BufEnter *_spec.rb let b:dispatch = 'bundle exec rspec %'
```

ตอนนี้ทุกครั้งที่คุณเข้าไฟล์ (`BufEnter`) ที่ลงท้ายด้วย `_spec.rb การรัน `:Dispatch` จะทำให้ `bundle exec rspec {ไฟล์ ruby spec ปัจจุบันของคุณ}` ถูกดำเนินการโดยอัตโนมัติ

## เรียนรู้การคอมไพล์อย่างชาญฉลาด

ในบทนี้คุณได้เรียนรู้ว่าคุณสามารถใช้คำสั่ง `make` และ `compiler` เพื่อรัน *กระบวนการใด ๆ* จากภายใน Vim แบบไม่ซิงโครนัสเพื่อเสริมสร้างการทำงานของคุณ การที่ Vim สามารถขยายตัวเองด้วยโปรแกรมอื่น ๆ ทำให้มันมีพลังมาก